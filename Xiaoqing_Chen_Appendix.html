<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Zicheng Xiang">
<meta name="dcterms.date" content="2025-10-24">

<title>Philadelphia Housing Price Prediction – Technical Appendix</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Xiaoqing_Chen_Appendix_files/libs/clipboard/clipboard.min.js"></script>
<script src="Xiaoqing_Chen_Appendix_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="Xiaoqing_Chen_Appendix_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="Xiaoqing_Chen_Appendix_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="Xiaoqing_Chen_Appendix_files/libs/quarto-html/popper.min.js"></script>
<script src="Xiaoqing_Chen_Appendix_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Xiaoqing_Chen_Appendix_files/libs/quarto-html/anchor.min.js"></script>
<link href="Xiaoqing_Chen_Appendix_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Xiaoqing_Chen_Appendix_files/libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Xiaoqing_Chen_Appendix_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Xiaoqing_Chen_Appendix_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Xiaoqing_Chen_Appendix_files/libs/bootstrap/bootstrap-9e3ffae467580fdb927a41352e75a2e0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="Xiaoqing_Chen_Appendix_files/libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">

<script src="Xiaoqing_Chen_Appendix_files/libs/pagedtable-1.1/js/pagedtable.js"></script>



</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
  
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Philadelphia Housing Price Prediction – Technical Appendix</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Zicheng Xiang </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 24, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>Step0</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Load libraries and data</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>opa_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/opa_properties_public.csv"</span>,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>                    <span class="at">na =</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"NA"</span>, <span class="st">"NaN"</span>, <span class="st">"NULL"</span>),</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>                    <span class="at">guess_max =</span> <span class="fl">1e6</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Rows (loaded):"</span>, <span class="fu">nrow</span>(opa_raw), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows (loaded): 583754 </code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Data cleaning and filtering</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>opa_res <span class="ot">&lt;-</span> opa_raw <span class="sc">%&gt;%</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">sale_date =</span> <span class="fu">as_date</span>(sale_date),</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prices are standardized as numeric values: regardless of whether they were originally numbers or strings (including $ or commas).</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">sale_price_num =</span> <span class="fu">suppressWarnings</span>(</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">coalesce</span>(<span class="fu">as.numeric</span>(sale_price), readr<span class="sc">::</span><span class="fu">parse_number</span>(<span class="fu">as.character</span>(sale_price)))</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Categories are standardized to a consistent data type.</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">cat_chr =</span> <span class="fu">as.character</span>(category_code)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    cat_chr <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"1"</span>),  </span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    sale_date <span class="sc">&gt;=</span> <span class="fu">as_date</span>(<span class="st">"2023-01-01"</span>),</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    sale_date <span class="sc">&lt;=</span> <span class="fu">as_date</span>(<span class="st">"2024-12-31"</span>),</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    sale_price_num <span class="sc">&gt;=</span> <span class="dv">10000</span>,</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    total_livable_area <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    year_built <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    number_of_bedrooms <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    number_of_bathrooms <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(census_tract),</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    census_tract <span class="sc">!=</span> <span class="dv">0</span>,</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    census_tract <span class="sc">!=</span> <span class="st">""</span>,</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(zip_code),</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    zip_code <span class="sc">!=</span> <span class="st">""</span>,</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(exterior_condition),</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    exterior_condition <span class="sc">!=</span> <span class="st">""</span>,</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(interior_condition),</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    interior_condition <span class="sc">!=</span> <span class="st">""</span>,</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(shape),</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    shape <span class="sc">!=</span> <span class="st">""</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    parcel_number, sale_date,</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">sale_price =</span> sale_price_num,</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    number_of_bedrooms, number_of_bathrooms,</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    total_livable_area, year_built,</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    zip_code, category_code,</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    exterior_condition, interior_condition,</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    census_tract, shape</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Rows (after cleaning and filtering):"</span>, <span class="fu">nrow</span>(opa_res), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows (after cleaning and filtering): 24123 </code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Extract coordinates from shape field (using sf)</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove the prefix SRID=2272</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>wkt <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"^SRID=</span><span class="sc">\\</span><span class="st">d+;</span><span class="sc">\\</span><span class="st">s*"</span>, <span class="st">""</span>, opa_res<span class="sc">$</span>shape)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to sf format.</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>geom <span class="ot">&lt;-</span> <span class="fu">st_as_sfc</span>(wkt, <span class="at">crs =</span> <span class="dv">2272</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>opa_sf <span class="ot">&lt;-</span> <span class="fu">st_sf</span>(opa_res, <span class="at">geometry =</span> geom)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract coordinates (for scatter plot).</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_coordinates</span>(opa_sf)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>opa_sf<span class="sc">$</span>X <span class="ot">&lt;-</span> coords[, <span class="dv">1</span>]</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>opa_sf<span class="sc">$</span>Y <span class="ot">&lt;-</span> coords[, <span class="dv">2</span>]</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Debug output.</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Rows with valid coordinates:"</span>, <span class="fu">nrow</span>(opa_sf), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows with valid coordinates: 24123 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Sample X coordinates:"</span>, <span class="fu">head</span>(opa_sf<span class="sc">$</span>X, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sample X coordinates: 2726356 2709355 2718833 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Sample Y coordinates:"</span>, <span class="fu">head</span>(opa_sf<span class="sc">$</span>Y, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sample Y coordinates: 290862.2 257213.9 269581 </code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Save cleaned data</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create output directory</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>), <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Export data (remove the geometry column, keeping only coordinates)</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>opa_export <span class="ot">&lt;-</span> opa_sf <span class="sc">%&gt;%</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    parcel_number, sale_date, sale_price,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    number_of_bedrooms, number_of_bathrooms,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    total_livable_area, year_built,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    zip_code, category_code,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    exterior_condition, interior_condition,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    census_tract, <span class="at">x_coord =</span> X, <span class="at">y_coord =</span> Y</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>()  </span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(opa_export, <span class="st">"./data/opa_sales_2023_2024_residential_clean.csv"</span>)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Cleaned data saved to: opa_sales_2023_2024_residential_clean.csv</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cleaned data saved to: opa_sales_2023_2024_residential_clean.csv</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Final dataset contains"</span>, <span class="fu">nrow</span>(opa_export), <span class="st">"rows with"</span>, <span class="fu">ncol</span>(opa_export), <span class="st">"columns</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Final dataset contains 24123 rows with 14 columns</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Columns:"</span>, <span class="fu">paste</span>(<span class="fu">names</span>(opa_export), <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Columns: parcel_number, sale_date, sale_price, number_of_bedrooms, number_of_bathrooms, total_livable_area, year_built, zip_code, category_code, exterior_condition, interior_condition, census_tract, x_coord, y_coord </code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Load, clean crime data and calculate crime count for properties</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Load crime data for 2023 and 2024</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>crime_2023 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">"./data/crime_2023.csv"</span>), <span class="at">na =</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"NA"</span>, <span class="st">"NaN"</span>, <span class="st">"NULL"</span>), <span class="at">guess_max =</span> <span class="fl">1e6</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>crime_2024 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">"./data/crime_2024.csv"</span>), <span class="at">na =</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"NA"</span>, <span class="st">"NaN"</span>, <span class="st">"NULL"</span>), <span class="at">guess_max =</span> <span class="fl">1e6</span>)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge, clean, and process crime data</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>crime_clean <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  crime_2023 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">year =</span> <span class="dv">2023</span>),</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  crime_2024 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">year =</span> <span class="dv">2024</span>)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">dispatch_date_time =</span> <span class="fu">as_datetime</span>(dispatch_date_time),</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">dispatch_date =</span> <span class="fu">as_date</span>(dispatch_date),</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat =</span> <span class="fu">as.numeric</span>(lat),</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">lng =</span> <span class="fu">as.numeric</span>(lng),</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">point_x =</span> <span class="fu">as.numeric</span>(point_x),</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">point_y =</span> <span class="fu">as.numeric</span>(point_y),</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">ucr_general =</span> <span class="fu">as.numeric</span>(ucr_general),</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">text_general_code =</span> <span class="fu">as.character</span>(text_general_code)</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(lat) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(lng),</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>    lat <span class="sc">!=</span> <span class="dv">0</span> <span class="sc">&amp;</span> lng <span class="sc">!=</span> <span class="dv">0</span>,</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    dispatch_date <span class="sc">&gt;=</span> <span class="fu">as_date</span>(<span class="st">"2023-01-01"</span>),</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    dispatch_date <span class="sc">&lt;=</span> <span class="fu">as_date</span>(<span class="st">"2024-12-31"</span>)</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    objectid, dc_dist, psa, dispatch_date_time, dispatch_date, </span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    dispatch_time, hour, dc_key, location_block, </span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    ucr_general, text_general_code, </span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    lat, lng, point_x, point_y, year</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Coordinate transformation: convert from WGS84 (EPSG:4326) to EPSG:2272 coordinate system</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>crime_sf <span class="ot">&lt;-</span> crime_clean <span class="sc">%&gt;%</span></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lng"</span>, <span class="st">"lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="dv">2272</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">x_coord_2272 =</span> <span class="fu">st_coordinates</span>(.)[, <span class="dv">1</span>],</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_coord_2272 =</span> <span class="fu">st_coordinates</span>(.)[, <span class="dv">2</span>]</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>()</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the cleaned real estate data</span></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>opa_clean <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">"./data/opa_sales_2023_2024_residential_clean.csv"</span>))</span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the real estate data to an sf object (EPSG:2272)</span></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>opa_sf <span class="ot">&lt;-</span> opa_clean <span class="sc">%&gt;%</span></span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x_coord"</span>, <span class="st">"y_coord"</span>), <span class="at">crs =</span> <span class="dv">2272</span>)</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the crime data to an sf object (EPSG:2272)</span></span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>crime_sf_spatial <span class="ot">&lt;-</span> crime_sf <span class="sc">%&gt;%</span></span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x_coord_2272"</span>, <span class="st">"y_coord_2272"</span>), <span class="at">crs =</span> <span class="dv">2272</span>)</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a 0.75-mile buffer around each home and count crimes (15-minute walkshed)</span></span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>opa_buffers <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(opa_sf, <span class="at">dist =</span> <span class="dv">3960</span>)  <span class="co"># 0.75 mile = 3960 feet</span></span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>crime_count <span class="ot">&lt;-</span> <span class="fu">st_intersects</span>(opa_buffers, crime_sf_spatial)</span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the crime counts to the real estate dataset</span></span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>opa_with_crime <span class="ot">&lt;-</span> opa_clean <span class="sc">%&gt;%</span></span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">crime_count_15min_walk =</span> <span class="fu">sapply</span>(crime_count, length)</span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Crime data processing completed:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Crime data processing completed:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Number of 2023 crime records:"</span>, <span class="fu">nrow</span>(crime_2023), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of 2023 crime records: 169017 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Number of 2024 crime records:"</span>, <span class="fu">nrow</span>(crime_2024), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of 2024 crime records: 160388 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Number of valid crime records after cleaning:"</span>, <span class="fu">nrow</span>(crime_clean), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of valid crime records after cleaning: 218725 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Number of records after coordinate transformation:"</span>, <span class="fu">nrow</span>(crime_sf), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of records after coordinate transformation: 218725 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Number of real estate records:"</span>, <span class="fu">nrow</span>(opa_with_crime), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of real estate records: 24123 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Average number of crimes within a 15-minute walkshed per property:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(opa_with_crime<span class="sc">$</span>crime_count_15min_walk), <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Average number of crimes within a 15-minute walkshed per property: 4466.34 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Crime count range:"</span>, <span class="fu">min</span>(opa_with_crime<span class="sc">$</span>crime_count_15min_walk), <span class="st">"-"</span>, <span class="fu">max</span>(opa_with_crime<span class="sc">$</span>crime_count_15min_walk), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Crime count range: 35 - 13238 </code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 6: Add park accessibility metrics (distance in feet, keep coordinate columns)</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the crime data processing results from the previous step</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>opa_with_crime <span class="ot">&lt;-</span> opa_with_crime</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to an sf object (coordinate system: EPSG:2272, unit: feet)</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>opa_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  opa_with_crime,</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x_coord"</span>, <span class="st">"y_coord"</span>),</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">crs =</span> <span class="dv">2272</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Number of real estate records read:"</span>, <span class="fu">nrow</span>(opa_sf), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of real estate records read: 24123 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read and project the park data.</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>parks <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">here</span>(<span class="st">"./data/PPR_Program_Sites.geojson"</span>), <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">2272</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate park accessibility metrics (unit: feet)</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>opa_sf <span class="ot">&lt;-</span> opa_sf <span class="sc">%&gt;%</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">dist_to_park_ft =</span> <span class="fu">apply</span>(<span class="fu">st_distance</span>(opa_sf, parks), <span class="dv">1</span>, min),   </span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Nearest park distance (feet).</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">park_within_15min_walk =</span> <span class="fu">lengths</span>(<span class="fu">st_within</span>(opa_sf, <span class="fu">st_buffer</span>(parks, <span class="dv">3960</span>)))  <span class="co"># 0.75 mile = 3960 feet</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract coordinates to prevent st_drop_geometry from removing them</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_coordinates</span>(opa_sf)</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>opa_sf <span class="ot">&lt;-</span> opa_sf <span class="sc">%&gt;%</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">x_coord =</span> coords[, <span class="dv">1</span>],</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_coord =</span> coords[, <span class="dv">2</span>]</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Export data (retain coordinates and newly added indicators)</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>opa_export <span class="ot">&lt;-</span> opa_sf <span class="sc">%&gt;%</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    parcel_number, sale_date, sale_price,</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>    number_of_bedrooms, number_of_bathrooms,</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>    total_livable_area, year_built,</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>    zip_code, category_code,</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>    exterior_condition, interior_condition,</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>    census_tract,</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>    x_coord, y_coord,              <span class="co"># keep coordinates</span></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>    crime_count_15min_walk,        <span class="co"># number of crimes within 15-minute walkshed</span></span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>    dist_to_park_ft,               <span class="co"># nearest park distance (feet)</span></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    park_within_15min_walk         <span class="co"># number of parks within 15-minute walkshed</span></span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Output summary information</span></span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the complete dataset with park accessibility indicators</span></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(opa_export, <span class="fu">here</span>(<span class="st">"./data/opa_sales_with_parks.csv"</span>))</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">" Park accessibility indicators added (unit: feet)</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> Park accessibility indicators added (unit: feet)</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Average nearest park distance:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(opa_export<span class="sc">$</span>dist_to_park_ft, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>), <span class="st">"ft</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Average nearest park distance: 1768.6 ft</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Average number of parks within 15-minute walkshed:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(opa_export<span class="sc">$</span>park_within_15min_walk, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Average number of parks within 15-minute walkshed: 3.53 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Number of fields:"</span>, <span class="fu">ncol</span>(opa_export), <span class="st">"columns (including coordinate columns)</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Number of fields: 17 columns (including coordinate columns)</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"🎉 Data saved to: ./data/opa_sales_with_parks.csv</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>🎉 Data saved to: ./data/opa_sales_with_parks.csv</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 7: Add public transit accessibility metrics</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co"># (distance to nearest stop &amp; number of stops within 1,000 ft; also 15-min walkshed)</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(units)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the same CRS (EPSG:2272, units = feet)</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>analysis_crs <span class="ot">&lt;-</span> <span class="dv">2272</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the dataset saved in the previous step (with price, crime, and park metrics)</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>opa_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">"./data/opa_sales_with_parks.csv"</span>))</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>opa_sf <span class="ot">&lt;-</span> opa_data <span class="sc">%&gt;%</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x_coord"</span>, <span class="st">"y_coord"</span>), <span class="at">crs =</span> analysis_crs)</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Number of real estate records read:"</span>, <span class="fu">nrow</span>(opa_sf), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of real estate records read: 24123 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read and project transit stop data</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>transit_path <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"./data/Transit_Stops_(Spring_2025).geojson"</span>)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">file.exists</span>(transit_path))</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>transit_stops <span class="ot">&lt;-</span> <span class="fu">st_read</span>(transit_path, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(analysis_crs) <span class="sc">%&gt;%</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressWarnings</span>(<span class="fu">st_collection_extract</span>(<span class="st">"POINT"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">st_is_empty</span>(geometry)) <span class="sc">%&gt;%</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(geometry, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Number of transit stops:"</span>, <span class="fu">nrow</span>(transit_stops), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of transit stops: 13839 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute accessibility metrics (units: feet)</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Distance to nearest transit stop</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>nearest_idx <span class="ot">&lt;-</span> <span class="fu">st_nearest_feature</span>(opa_sf, transit_stops)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>dist_ft <span class="ot">&lt;-</span> <span class="fu">st_distance</span>(opa_sf, transit_stops[nearest_idx, ], <span class="at">by_element =</span> <span class="cn">TRUE</span>)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>opa_sf<span class="sc">$</span>dist_transit_ft <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">set_units</span>(dist_ft, <span class="st">"ft"</span>))</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Count of transit stops within a 15-minute walkshed (0.75 mile = 3960 ft)</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>buffer_3960ft <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(opa_sf, <span class="at">dist =</span> <span class="dv">3960</span>)</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>opa_sf<span class="sc">$</span>transit_15min_walk <span class="ot">&lt;-</span> <span class="fu">lengths</span>(<span class="fu">st_intersects</span>(buffer_3960ft, transit_stops))</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="co"># (Optional) Count of transit stops within 1,000 ft</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>buffer_1000ft <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(opa_sf, <span class="at">dist =</span> <span class="dv">1000</span>)</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>opa_sf<span class="sc">$</span>transit_within_1000ft <span class="ot">&lt;-</span> <span class="fu">lengths</span>(<span class="fu">st_intersects</span>(buffer_1000ft, transit_stops))</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract coordinates so st_drop_geometry does not remove them</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_coordinates</span>(opa_sf)</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>opa_sf <span class="ot">&lt;-</span> opa_sf <span class="sc">%&gt;%</span></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">x_coord =</span> coords[, <span class="dv">1</span>],</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_coord =</span> coords[, <span class="dv">2</span>]</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Export results (retain coordinates and newly added indicators)</span></span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>opa_export <span class="ot">&lt;-</span> opa_sf <span class="sc">%&gt;%</span></span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>    parcel_number, sale_date, sale_price,</span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>    number_of_bedrooms, number_of_bathrooms,</span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>    total_livable_area, year_built,</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>    zip_code, category_code,</span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>    exterior_condition, interior_condition,</span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>    census_tract,</span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>    x_coord, y_coord,                 <span class="co"># keep coordinates</span></span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>    crime_count_15min_walk,           <span class="co"># crime metric</span></span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a>    dist_to_park_ft, park_within_15min_walk, <span class="co"># park metrics</span></span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a>    dist_transit_ft, transit_15min_walk,     <span class="co"># transit metrics (walkshed)</span></span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>    transit_within_1000ft                    <span class="co"># transit stops within 1,000 ft</span></span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Output summary information</span></span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the complete dataset with transit metrics</span></span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(opa_export, <span class="fu">here</span>(<span class="st">"./data/opa_sales_with_transit.csv"</span>))</span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Public transit metrics added</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Public transit metrics added</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Average distance to nearest transit stop:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(opa_export<span class="sc">$</span>dist_transit_ft, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>), <span class="st">"ft</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Average distance to nearest transit stop: 428.8 ft</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Average number of transit stops within 15-minute walkshed:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(opa_export<span class="sc">$</span>transit_15min_walk, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Average number of transit stops within 15-minute walkshed: 151.79 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Average number of transit stops within 1,000 ft:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(opa_export<span class="sc">$</span>transit_within_1000ft, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Average number of transit stops within 1,000 ft: 10.73 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Number of fields:"</span>, <span class="fu">ncol</span>(opa_export), <span class="st">"columns (including coordinate columns)</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Number of fields: 20 columns (including coordinate columns)</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"🎉 Data saved to: ./data/opa_sales_with_transit.csv</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>🎉 Data saved to: ./data/opa_sales_with_transit.csv</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 8: Add hospital accessibility metrics</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="co"># (distance to nearest hospital &amp; count within 0.75-mile walkshed)</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a><span class="co"># CRS: EPSG:2272 (units: feet)</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>analysis_crs <span class="ot">&lt;-</span> <span class="dv">2272</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the dataset saved in the previous step (with price, crime, park, and transit metrics)</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>opa_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">"./data/opa_sales_with_transit.csv"</span>))</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>opa_sf <span class="ot">&lt;-</span> opa_data <span class="sc">%&gt;%</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x_coord"</span>, <span class="st">"y_coord"</span>), <span class="at">crs =</span> analysis_crs)</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Number of real estate records read:"</span>, <span class="fu">nrow</span>(opa_sf), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of real estate records read: 24123 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read hospital data and project to the same CRS</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>hospitals <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">here</span>(<span class="st">"./data/Hospitals.geojson"</span>), <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(analysis_crs)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Number of hospitals:"</span>, <span class="fu">nrow</span>(hospitals), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of hospitals: 36 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute hospital accessibility metrics (units: feet)</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>opa_sf <span class="ot">&lt;-</span> opa_sf <span class="sc">%&gt;%</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Distance to nearest hospital (feet)</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">dist_to_hospital_ft =</span> <span class="fu">as.numeric</span>(<span class="fu">apply</span>(<span class="fu">st_distance</span>(opa_sf, hospitals), <span class="dv">1</span>, min)),</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Number of hospitals within a 15-minute walkshed (0.75 mile = 3960 ft)</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">hospitals_15min_walk =</span> <span class="fu">lengths</span>(<span class="fu">st_within</span>(opa_sf, <span class="fu">st_buffer</span>(hospitals, <span class="dv">3960</span>)))</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract coordinates so st_drop_geometry does not remove them</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_coordinates</span>(opa_sf)</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>opa_sf <span class="ot">&lt;-</span> opa_sf <span class="sc">%&gt;%</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">x_coord =</span> coords[, <span class="dv">1</span>],</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_coord =</span> coords[, <span class="dv">2</span>]</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Export results (retain coordinates and all features)</span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>opa_export <span class="ot">&lt;-</span> opa_sf <span class="sc">%&gt;%</span></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>    parcel_number, sale_date, sale_price,</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>    number_of_bedrooms, number_of_bathrooms,</span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>    total_livable_area, year_built,</span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>    zip_code, category_code,</span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a>    exterior_condition, interior_condition,</span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a>    census_tract,</span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a>    x_coord, y_coord,                         <span class="co"># keep coordinates</span></span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a>    crime_count_15min_walk,                   <span class="co"># crime metrics</span></span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a>    dist_to_park_ft, park_within_15min_walk,  <span class="co"># park metrics</span></span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a>    dist_transit_ft, transit_15min_walk,      <span class="co"># transit metrics</span></span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a>    dist_to_hospital_ft, hospitals_15min_walk <span class="co"># hospital metrics (new)</span></span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Output summary information</span></span>
<span id="cb65-36"><a href="#cb65-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the complete dataset with hospital metrics</span></span>
<span id="cb65-37"><a href="#cb65-37" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(opa_export, <span class="fu">here</span>(<span class="st">"./data/opa_sales_with_hospitals.csv"</span>))</span>
<span id="cb65-38"><a href="#cb65-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-39"><a href="#cb65-39" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Hospital accessibility metrics added</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Hospital accessibility metrics added</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Average distance to nearest hospital:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(opa_export<span class="sc">$</span>dist_to_hospital_ft, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>), <span class="st">"ft</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Average distance to nearest hospital: 5169 ft</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Average number of hospitals within 15-minute walkshed:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(opa_export<span class="sc">$</span>hospitals_15min_walk, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Average number of hospitals within 15-minute walkshed: 0.74 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Number of fields:"</span>, <span class="fu">ncol</span>(opa_export), <span class="st">"columns (including coordinate columns)</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Number of fields: 21 columns (including coordinate columns)</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Includes all features: real estate info + crime + park + transit + hospital</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Includes all features: real estate info + crime + park + transit + hospital</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Data saved to: ./data/opa_sales_with_hospitals.csv</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Data saved to: ./data/opa_sales_with_hospitals.csv</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 9: Enrich with ACS (Census) Socioeconomic Indicators</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidycensus)</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the final property data (includes all accessibility metrics)</span></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>opa_final <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">"./data/opa_sales_with_hospitals.csv"</span>))</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to sf object (ensure CRS is EPSG:2272)</span></span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>opa_sf <span class="ot">&lt;-</span> opa_final <span class="sc">%&gt;%</span></span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x_coord"</span>, <span class="st">"y_coord"</span>), <span class="at">crs =</span> <span class="dv">2272</span>, <span class="at">remove =</span> <span class="cn">FALSE</span>)</span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Number of property records read:"</span>, <span class="fu">nrow</span>(opa_sf), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of property records read: 24123 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Download ACS data for Philadelphia (year can be changed)</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>year_acs <span class="ot">&lt;-</span> <span class="dv">2022</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="fu">census_api_key</span>(<span class="st">"86993dedbe98d77b9d79db6b8ba21a7fde55cb91"</span>, <span class="at">install =</span> <span class="cn">FALSE</span>)</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>acs_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">total_pop      =</span> <span class="st">"B01003_001"</span>,</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">median_income  =</span> <span class="st">"B19013_001"</span>,</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">per_cap_income =</span> <span class="st">"B19301_001"</span>,</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">below_pov      =</span> <span class="st">"B17001_002"</span>,</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">edu_total25    =</span> <span class="st">"B15003_001"</span>,</span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">edu_bach       =</span> <span class="st">"B15003_022"</span>,</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">edu_mast       =</span> <span class="st">"B15003_023"</span>,</span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">edu_prof       =</span> <span class="st">"B15003_024"</span>,</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">edu_phd        =</span> <span class="st">"B15003_025"</span></span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>phl_acs <span class="ot">&lt;-</span> <span class="fu">get_acs</span>(</span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">geography =</span> <span class="st">"tract"</span>,</span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">state =</span> <span class="st">"PA"</span>,</span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">county =</span> <span class="st">"Philadelphia"</span>,</span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">year =</span> year_acs,</span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">geometry =</span> <span class="cn">TRUE</span>,</span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">output =</span> <span class="st">"wide"</span>,</span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> acs_vars</span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb79-28"><a href="#cb79-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb79-29"><a href="#cb79-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">PCBACHMORE =</span> <span class="dv">100</span> <span class="sc">*</span> ((edu_bachE <span class="sc">+</span> edu_mastE <span class="sc">+</span> edu_profE <span class="sc">+</span> edu_phdE) <span class="sc">/</span> edu_total25E),</span>
<span id="cb79-30"><a href="#cb79-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">PCTPOVERTY =</span> <span class="dv">100</span> <span class="sc">*</span> (below_povE <span class="sc">/</span> total_popE)</span>
<span id="cb79-31"><a href="#cb79-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb79-32"><a href="#cb79-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(geometry, GEOID, total_popE, median_incomeE, per_cap_incomeE, PCBACHMORE, PCTPOVERTY)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |=                                                                     |   2%
  |                                                                            
  |==                                                                    |   3%
  |                                                                            
  |===                                                                   |   4%
  |                                                                            
  |====                                                                  |   5%
  |                                                                            
  |====                                                                  |   6%
  |                                                                            
  |=====                                                                 |   6%
  |                                                                            
  |=====                                                                 |   7%
  |                                                                            
  |======                                                                |   8%
  |                                                                            
  |======                                                                |   9%
  |                                                                            
  |=======                                                               |  10%
  |                                                                            
  |=======                                                               |  11%
  |                                                                            
  |========                                                              |  11%
  |                                                                            
  |=========                                                             |  12%
  |                                                                            
  |=========                                                             |  13%
  |                                                                            
  |==========                                                            |  14%
  |                                                                            
  |===========                                                           |  15%
  |                                                                            
  |===========                                                           |  16%
  |                                                                            
  |============                                                          |  17%
  |                                                                            
  |=============                                                         |  18%
  |                                                                            
  |=============                                                         |  19%
  |                                                                            
  |==============                                                        |  20%
  |                                                                            
  |===============                                                       |  21%
  |                                                                            
  |===============                                                       |  22%
  |                                                                            
  |================                                                      |  23%
  |                                                                            
  |=================                                                     |  24%
  |                                                                            
  |=================                                                     |  25%
  |                                                                            
  |==================                                                    |  26%
  |                                                                            
  |===================                                                   |  27%
  |                                                                            
  |===================                                                   |  28%
  |                                                                            
  |====================                                                  |  29%
  |                                                                            
  |=====================                                                 |  30%
  |                                                                            
  |=====================                                                 |  31%
  |                                                                            
  |======================                                                |  32%
  |                                                                            
  |=======================                                               |  33%
  |                                                                            
  |========================                                              |  34%
  |                                                                            
  |========================                                              |  35%
  |                                                                            
  |=========================                                             |  36%
  |                                                                            
  |==========================                                            |  37%
  |                                                                            
  |==========================                                            |  38%
  |                                                                            
  |===========================                                           |  39%
  |                                                                            
  |============================                                          |  40%
  |                                                                            
  |============================                                          |  41%
  |                                                                            
  |=============================                                         |  41%
  |                                                                            
  |==============================                                        |  42%
  |                                                                            
  |==============================                                        |  43%
  |                                                                            
  |===============================                                       |  44%
  |                                                                            
  |================================                                      |  45%
  |                                                                            
  |================================                                      |  46%
  |                                                                            
  |=================================                                     |  47%
  |                                                                            
  |==================================                                    |  48%
  |                                                                            
  |===================================                                   |  49%
  |                                                                            
  |===================================                                   |  50%
  |                                                                            
  |====================================                                  |  51%
  |                                                                            
  |=====================================                                 |  52%
  |                                                                            
  |=====================================                                 |  53%
  |                                                                            
  |======================================                                |  54%
  |                                                                            
  |=======================================                               |  55%
  |                                                                            
  |=======================================                               |  56%
  |                                                                            
  |========================================                              |  57%
  |                                                                            
  |=========================================                             |  58%
  |                                                                            
  |=========================================                             |  59%
  |                                                                            
  |==========================================                            |  60%
  |                                                                            
  |===========================================                           |  61%
  |                                                                            
  |===========================================                           |  62%
  |                                                                            
  |============================================                          |  63%
  |                                                                            
  |=============================================                         |  64%
  |                                                                            
  |==============================================                        |  65%
  |                                                                            
  |==============================================                        |  66%
  |                                                                            
  |===============================================                       |  67%
  |                                                                            
  |================================================                      |  68%
  |                                                                            
  |================================================                      |  69%
  |                                                                            
  |=================================================                     |  70%
  |                                                                            
  |==================================================                    |  71%
  |                                                                            
  |==================================================                    |  72%
  |                                                                            
  |===================================================                   |  73%
  |                                                                            
  |====================================================                  |  74%
  |                                                                            
  |====================================================                  |  75%
  |                                                                            
  |=====================================================                 |  76%
  |                                                                            
  |======================================================                |  77%
  |                                                                            
  |======================================================                |  78%
  |                                                                            
  |=======================================================               |  79%
  |                                                                            
  |========================================================              |  80%
  |                                                                            
  |=========================================================             |  81%
  |                                                                            
  |=========================================================             |  82%
  |                                                                            
  |==========================================================            |  83%
  |                                                                            
  |===========================================================           |  84%
  |                                                                            
  |===========================================================           |  85%
  |                                                                            
  |============================================================          |  86%
  |                                                                            
  |=============================================================         |  87%
  |                                                                            
  |=============================================================         |  88%
  |                                                                            
  |==============================================================        |  89%
  |                                                                            
  |===============================================================       |  90%
  |                                                                            
  |===============================================================       |  91%
  |                                                                            
  |================================================================      |  92%
  |                                                                            
  |=================================================================     |  92%
  |                                                                            
  |=================================================================     |  93%
  |                                                                            
  |==================================================================    |  94%
  |                                                                            
  |===================================================================   |  95%
  |                                                                            
  |===================================================================   |  96%
  |                                                                            
  |====================================================================  |  97%
  |                                                                            
  |===================================================================== |  98%
  |                                                                            
  |======================================================================|  99%
  |                                                                            
  |======================================================================| 100%</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Reproject to align (EPSG:2272)</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>phl_acs <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(phl_acs, <span class="dv">2272</span>)</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial join: assign each home to the tract it falls within</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>opa_joined <span class="ot">&lt;-</span> <span class="fu">st_join</span>(</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>  opa_sf,</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>  phl_acs,</span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">join =</span> st_within,</span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">left =</span> <span class="cn">TRUE</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a><span class="co"># For out-of-bound samples (occasional NAs), fill with nearest tract</span></span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>missing <span class="ot">&lt;-</span> <span class="fu">is.na</span>(opa_joined<span class="sc">$</span>median_incomeE)</span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">any</span>(missing)) {</span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">st_nearest_feature</span>(opa_joined[missing, ], phl_acs)</span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a>  repl <span class="ot">&lt;-</span> phl_acs[idx, ] <span class="sc">%&gt;%</span> <span class="fu">st_drop_geometry</span>()</span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a>  cols <span class="ot">&lt;-</span> <span class="fu">names</span>(repl)</span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a>  opa_joined[missing, cols] <span class="ot">&lt;-</span> repl</span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Export results</span></span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true" tabindex="-1"></a>opa_export <span class="ot">&lt;-</span> opa_joined <span class="sc">%&gt;%</span></span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true" tabindex="-1"></a>    parcel_number, sale_date, sale_price,</span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true" tabindex="-1"></a>    number_of_bedrooms, number_of_bathrooms,</span>
<span id="cb81-35"><a href="#cb81-35" aria-hidden="true" tabindex="-1"></a>    total_livable_area, year_built,</span>
<span id="cb81-36"><a href="#cb81-36" aria-hidden="true" tabindex="-1"></a>    zip_code, category_code,</span>
<span id="cb81-37"><a href="#cb81-37" aria-hidden="true" tabindex="-1"></a>    exterior_condition, interior_condition,</span>
<span id="cb81-38"><a href="#cb81-38" aria-hidden="true" tabindex="-1"></a>    census_tract,</span>
<span id="cb81-39"><a href="#cb81-39" aria-hidden="true" tabindex="-1"></a>    x_coord, y_coord,</span>
<span id="cb81-40"><a href="#cb81-40" aria-hidden="true" tabindex="-1"></a>    crime_count_15min_walk,                  <span class="co"># crime</span></span>
<span id="cb81-41"><a href="#cb81-41" aria-hidden="true" tabindex="-1"></a>    dist_to_park_ft, park_within_15min_walk, <span class="co"># parks</span></span>
<span id="cb81-42"><a href="#cb81-42" aria-hidden="true" tabindex="-1"></a>    dist_transit_ft, transit_15min_walk,     <span class="co"># transit</span></span>
<span id="cb81-43"><a href="#cb81-43" aria-hidden="true" tabindex="-1"></a>    dist_to_hospital_ft, hospitals_15min_walk, <span class="co"># hospitals</span></span>
<span id="cb81-44"><a href="#cb81-44" aria-hidden="true" tabindex="-1"></a>    total_popE, median_incomeE, per_cap_incomeE, PCBACHMORE, PCTPOVERTY  <span class="co"># ACS</span></span>
<span id="cb81-45"><a href="#cb81-45" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb81-46"><a href="#cb81-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-47"><a href="#cb81-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the complete dataset with Census indicators</span></span>
<span id="cb81-48"><a href="#cb81-48" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(opa_export, <span class="fu">here</span>(<span class="st">"opa_sales_final_complete.csv"</span>))</span>
<span id="cb81-49"><a href="#cb81-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-50"><a href="#cb81-50" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  ACS socioeconomic indicators added</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ACS socioeconomic indicators added</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Mean household income (USD):"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(opa_export<span class="sc">$</span>median_incomeE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Mean household income (USD): 66446 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Mean poverty rate (%):"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(opa_export<span class="sc">$</span>PCTPOVERTY, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Mean poverty rate (%): 20.85 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Mean share with bachelor's degree or higher (%):"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(opa_export<span class="sc">$</span>PCBACHMORE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Mean share with bachelor's degree or higher (%): 34.62 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Includes all features: price + crime + parks + transit + hospitals + socioeconomic</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Includes all features: price + crime + parks + transit + hospitals + socioeconomic</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Data saved to: opa_sales_final_complete.csv</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Data saved to: opa_sales_final_complete.csv</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 10: Add Education Accessibility Indicators (Schools)</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(units)</span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 1.Read the complete dataset saved from the previous step (including Census and accessibility features)</span></span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>opa_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">"opa_sales_final_complete.csv"</span>))</span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>opa_sf <span class="ot">&lt;-</span> opa_data <span class="sc">%&gt;%</span></span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x_coord"</span>, <span class="st">"y_coord"</span>), <span class="at">crs =</span> <span class="dv">2272</span>, <span class="at">remove =</span> <span class="cn">FALSE</span>)</span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Number of property records read:"</span>, <span class="fu">nrow</span>(opa_sf), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of property records read: 24123 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Data column names:"</span>, <span class="fu">paste</span>(<span class="fu">names</span>(opa_sf), <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Data column names: parcel_number, sale_date, sale_price, number_of_bedrooms, number_of_bathrooms, total_livable_area, year_built, zip_code, category_code, exterior_condition, interior_condition, census_tract, x_coord, y_coord, crime_count_15min_walk, dist_to_park_ft, park_within_15min_walk, dist_transit_ft, transit_15min_walk, dist_to_hospital_ft, hospitals_15min_walk, total_popE, median_incomeE, per_cap_incomeE, PCBACHMORE, PCTPOVERTY, geometry </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.Read the school data (only one file)）</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>schools <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">here</span>(<span class="st">"./data/Schools_Parcels.geojson"</span>), <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">2272</span>) <span class="sc">%&gt;%</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">st_is_empty</span>(geometry))  </span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"School data loaded:"</span>, <span class="fu">nrow</span>(schools), <span class="st">"records</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>School data loaded: 495 records</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"School data coordinate system:"</span>, <span class="fu">st_crs</span>(schools)<span class="sc">$</span>input, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>School data coordinate system: EPSG:2272 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Property data coordinate system:"</span>, <span class="fu">st_crs</span>(opa_sf)<span class="sc">$</span>input, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Property data coordinate system: EPSG:2272 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 3.Calculate education accessibility indicators</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Distance to the nearest school (in feet)</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Starting to calculate the nearest school distance...</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Starting to calculate the nearest school distance...</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>dist_matrix <span class="ot">&lt;-</span> <span class="fu">st_distance</span>(opa_sf, schools)</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Distance matrix dimensions:"</span>, <span class="fu">dim</span>(dist_matrix), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Distance matrix dimensions: 24123 495 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>opa_sf<span class="sc">$</span>dist_to_nearest_school_ft <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">apply</span>(dist_matrix, <span class="dv">1</span>, min))</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Nearest school distance calculation completed, range:"</span>,</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">min</span>(opa_sf<span class="sc">$</span>dist_to_nearest_school_ft), <span class="st">"-"</span>, </span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">max</span>(opa_sf<span class="sc">$</span>dist_to_nearest_school_ft), <span class="st">"feet</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Nearest school distance calculation completed, range: 0 - 5286.279 feet</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of schools within a 15-minute walking distance</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Starting to calculate the number of schools within a 15-minute walking distance...</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Starting to calculate the number of schools within a 15-minute walking distance...</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>buffer_3960ft <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(opa_sf, <span class="at">dist =</span> <span class="dv">3960</span>)  <span class="co"># 0.75 mile = 3960 feet</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>opa_sf<span class="sc">$</span>schools_within_15min_walk <span class="ot">&lt;-</span> <span class="fu">lengths</span>(<span class="fu">st_intersects</span>(buffer_3960ft, schools))</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Calculation of schools within a 15-minute walking distance completed, range:"</span>,</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">min</span>(opa_sf<span class="sc">$</span>schools_within_15min_walk), <span class="st">"-"</span>, </span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">max</span>(opa_sf<span class="sc">$</span>schools_within_15min_walk), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Calculation of schools within a 15-minute walking distance completed, range: 0 - 28 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 4.Extract coordinates and retain all columns</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">st_coordinates</span>(opa_sf)</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>opa_sf <span class="ot">&lt;-</span> opa_sf <span class="sc">%&gt;%</span></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x_coord =</span> coords[, <span class="dv">1</span>],</span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_coord =</span> coords[, <span class="dv">2</span>]</span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 5.Export the complete table with education accessibility indicators</span></span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>opa_export <span class="ot">&lt;-</span> opa_sf <span class="sc">%&gt;%</span></span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb113-17"><a href="#cb113-17" aria-hidden="true" tabindex="-1"></a>    parcel_number, sale_date, sale_price,</span>
<span id="cb113-18"><a href="#cb113-18" aria-hidden="true" tabindex="-1"></a>    number_of_bedrooms, number_of_bathrooms,</span>
<span id="cb113-19"><a href="#cb113-19" aria-hidden="true" tabindex="-1"></a>    total_livable_area, year_built,</span>
<span id="cb113-20"><a href="#cb113-20" aria-hidden="true" tabindex="-1"></a>    zip_code, category_code,</span>
<span id="cb113-21"><a href="#cb113-21" aria-hidden="true" tabindex="-1"></a>    exterior_condition, interior_condition,</span>
<span id="cb113-22"><a href="#cb113-22" aria-hidden="true" tabindex="-1"></a>    census_tract,</span>
<span id="cb113-23"><a href="#cb113-23" aria-hidden="true" tabindex="-1"></a>    x_coord, y_coord,</span>
<span id="cb113-24"><a href="#cb113-24" aria-hidden="true" tabindex="-1"></a>    crime_count_15min_walk,                  </span>
<span id="cb113-25"><a href="#cb113-25" aria-hidden="true" tabindex="-1"></a>    dist_to_park_ft, park_within_15min_walk, </span>
<span id="cb113-26"><a href="#cb113-26" aria-hidden="true" tabindex="-1"></a>    dist_transit_ft, transit_15min_walk,     </span>
<span id="cb113-27"><a href="#cb113-27" aria-hidden="true" tabindex="-1"></a>    dist_to_hospital_ft, hospitals_15min_walk, </span>
<span id="cb113-28"><a href="#cb113-28" aria-hidden="true" tabindex="-1"></a>    total_popE, median_incomeE, per_cap_incomeE, PCBACHMORE, PCTPOVERTY,  <span class="co"># Census</span></span>
<span id="cb113-29"><a href="#cb113-29" aria-hidden="true" tabindex="-1"></a>    dist_to_nearest_school_ft, schools_within_15min_walk                  </span>
<span id="cb113-30"><a href="#cb113-30" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb113-31"><a href="#cb113-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-32"><a href="#cb113-32" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb113-33"><a href="#cb113-33" aria-hidden="true" tabindex="-1"></a><span class="co"># 6.Clean the data: remove all rows containing empty or NA values</span></span>
<span id="cb113-34"><a href="#cb113-34" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------</span></span>
<span id="cb113-35"><a href="#cb113-35" aria-hidden="true" tabindex="-1"></a>rows_before <span class="ot">&lt;-</span> <span class="fu">nrow</span>(opa_export)</span>
<span id="cb113-36"><a href="#cb113-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-37"><a href="#cb113-37" aria-hidden="true" tabindex="-1"></a>opa_export <span class="ot">&lt;-</span> opa_export <span class="sc">%&gt;%</span></span>
<span id="cb113-38"><a href="#cb113-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> {</span>
<span id="cb113-39"><a href="#cb113-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.character</span>(.x)) {</span>
<span id="cb113-40"><a href="#cb113-40" aria-hidden="true" tabindex="-1"></a>      clean_val <span class="ot">&lt;-</span> <span class="fu">trimws</span>(<span class="fu">tolower</span>(<span class="fu">as.character</span>(.x)))</span>
<span id="cb113-41"><a href="#cb113-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(clean_val <span class="sc">==</span> <span class="st">""</span> <span class="sc">|</span> clean_val <span class="sc">==</span> <span class="st">"na"</span> <span class="sc">|</span> clean_val <span class="sc">==</span> <span class="st">"n/a"</span> <span class="sc">|</span> clean_val <span class="sc">==</span> <span class="st">"null"</span>, </span>
<span id="cb113-42"><a href="#cb113-42" aria-hidden="true" tabindex="-1"></a>             <span class="cn">NA</span>, .x)</span>
<span id="cb113-43"><a href="#cb113-43" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb113-44"><a href="#cb113-44" aria-hidden="true" tabindex="-1"></a>      .x</span>
<span id="cb113-45"><a href="#cb113-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb113-46"><a href="#cb113-46" aria-hidden="true" tabindex="-1"></a>  })) <span class="sc">%&gt;%</span></span>
<span id="cb113-47"><a href="#cb113-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb113-48"><a href="#cb113-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-49"><a href="#cb113-49" aria-hidden="true" tabindex="-1"></a>rows_after <span class="ot">&lt;-</span> <span class="fu">nrow</span>(opa_export)</span>
<span id="cb113-50"><a href="#cb113-50" aria-hidden="true" tabindex="-1"></a>rows_removed <span class="ot">&lt;-</span> rows_before <span class="sc">-</span> rows_after</span>
<span id="cb113-51"><a href="#cb113-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-52"><a href="#cb113-52" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(opa_export, <span class="fu">here</span>(<span class="st">"opa_sales_final_complete.csv"</span>))</span>
<span id="cb113-53"><a href="#cb113-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-54"><a href="#cb113-54" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Education accessibility indicators have been added</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Education accessibility indicators have been added</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Average distance to the nearest school:"</span>, </span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(<span class="fu">mean</span>(opa_export<span class="sc">$</span>dist_to_nearest_school_ft, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>), <span class="st">"ft</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Average distance to the nearest school: 949.6 ft</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Average number of schools within a 15-minute walking distance:"</span>, </span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(<span class="fu">mean</span>(opa_export<span class="sc">$</span>schools_within_15min_walk, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Average number of schools within a 15-minute walking distance: 10.56 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Data cleaning completed: removed"</span>, rows_removed, <span class="st">"rows containing empty or NA values</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Data cleaning completed: removed 100 rows containing empty or NA values</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Before cleaning:"</span>, rows_before, <span class="st">"rows → After cleaning:"</span>, rows_after, <span class="st">"rows</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Before cleaning: 24123 rows → After cleaning: 24023 rows</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Final complete dataset saved to: opa_sales_final_complete.csv</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Final complete dataset saved to: opa_sales_final_complete.csv</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Includes all features: housing price + crime + parks + transit + hospitals + Census + schools</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Includes all features: housing price + crime + parks + transit + hospitals + Census + schools</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Number of columns:"</span>, <span class="fu">ncol</span>(opa_export), <span class="st">"(including coordinate columns)</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Number of columns: 28 (including coordinate columns)</code></pre>
</div>
</div>
<p>Step1</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Skewness Detection + Log Transformation + Descriptive Statistics</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(e1071)</span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2025</span>)</span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"📊 Step 1: Data Cleaning, Transformation, and Descriptive Statistics</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>📊 Step 1: Data Cleaning, Transformation, and Descriptive Statistics</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === Read Data ===</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"opa_sales_final_complete.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Original sample size: %d</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">nrow</span>(df)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Original sample size: 24023</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Number of variables: %d</span><span class="sc">\n\n</span><span class="st">"</span>, <span class="fu">ncol</span>(df)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of variables: 28</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === Basic Processing ===</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="st">"year_built"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df)) {</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">age =</span> <span class="dv">2025</span> <span class="sc">-</span> year_built,</span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">age2 =</span> age<span class="sc">^</span><span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>year_built)</span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a>cat_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"interior_condition"</span>, <span class="st">"exterior_condition"</span>, <span class="st">"zip_code"</span>, <span class="st">"census_tract"</span>)</span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a>coord_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"x_coord"</span>, <span class="st">"y_coord"</span>)</span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a>df[cat_vars] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(df[cat_vars], factor)</span>
<span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-13"><a href="#cb139-13" aria-hidden="true" tabindex="-1"></a><span class="co"># === Skewness Detection ===</span></span>
<span id="cb139-14"><a href="#cb139-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Skewness Detection ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== Skewness Detection ===</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>num_vars <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">where</span>(is.numeric))</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>skews <span class="ot">&lt;-</span> <span class="fu">sapply</span>(num_vars, <span class="cf">function</span>(x) {</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">is.na</span>(x)) <span class="sc">||</span> <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">skewness</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>logged_vars <span class="ot">&lt;-</span> <span class="fu">names</span>(skews[<span class="fu">abs</span>(skews) <span class="sc">&gt;</span> <span class="dv">1</span>])</span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Variables with |skew| &gt; 1: %d</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">length</span>(logged_vars)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Variables with |skew| &gt; 1: 10</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === Apply log1p Transformation ===</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>df_trans <span class="ot">&lt;-</span> df</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (v <span class="cf">in</span> logged_vars) {</span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>  df_trans[[v]] <span class="ot">&lt;-</span> <span class="fu">log1p</span>(<span class="fu">pmax</span>(df[[v]], <span class="dv">0</span>))</span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Descriptive Statistics Table</span></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Generating Descriptive Statistics Table ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== Generating Descriptive Statistics Table ===</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify target variable</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>y_var <span class="ot">&lt;-</span> <span class="fu">case_when</span>(</span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sale_price_log"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df_trans) <span class="sc">~</span> <span class="st">"sale_price_log"</span>,</span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"log_sale_price"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df_trans) <span class="sc">~</span> <span class="st">"log_sale_price"</span>,</span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sale_price"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df_trans) <span class="sc">~</span> <span class="st">"sale_price"</span>,</span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>  <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Select key numeric variables</span></span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a>key_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a>  y_var,</span>
<span id="cb148-12"><a href="#cb148-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"total_livable_area"</span>, <span class="st">"number_of_bedrooms"</span>, <span class="st">"number_of_bathrooms"</span>, <span class="st">"age"</span>,</span>
<span id="cb148-13"><a href="#cb148-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"median_incomeE"</span>, <span class="st">"per_cap_incomeE"</span>, <span class="st">"PCTPOVERTY"</span>, <span class="st">"PCBACHMORE"</span></span>
<span id="cb148-14"><a href="#cb148-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb148-15"><a href="#cb148-15" aria-hidden="true" tabindex="-1"></a>key_vars <span class="ot">&lt;-</span> <span class="fu">intersect</span>(key_vars, <span class="fu">names</span>(df_trans))</span>
<span id="cb148-16"><a href="#cb148-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-17"><a href="#cb148-17" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(key_vars) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb148-18"><a href="#cb148-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute descriptive statistics (more meaningful on pre-transformation data)</span></span>
<span id="cb148-19"><a href="#cb148-19" aria-hidden="true" tabindex="-1"></a>  desc_stats <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb148-20"><a href="#cb148-20" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">all_of</span>(key_vars)) <span class="sc">%&gt;%</span></span>
<span id="cb148-21"><a href="#cb148-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="fu">list</span>(</span>
<span id="cb148-22"><a href="#cb148-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">N =</span> <span class="sc">~</span><span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(.)),</span>
<span id="cb148-23"><a href="#cb148-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">Mean =</span> <span class="sc">~</span><span class="fu">mean</span>(., <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb148-24"><a href="#cb148-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">SD =</span> <span class="sc">~</span><span class="fu">sd</span>(., <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb148-25"><a href="#cb148-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">Min =</span> <span class="sc">~</span><span class="fu">min</span>(., <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb148-26"><a href="#cb148-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">Q25 =</span> <span class="sc">~</span><span class="fu">quantile</span>(., <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb148-27"><a href="#cb148-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">Median =</span> <span class="sc">~</span><span class="fu">median</span>(., <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb148-28"><a href="#cb148-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">Q75 =</span> <span class="sc">~</span><span class="fu">quantile</span>(., <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb148-29"><a href="#cb148-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">Max =</span> <span class="sc">~</span><span class="fu">max</span>(., <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb148-30"><a href="#cb148-30" aria-hidden="true" tabindex="-1"></a>    ), <span class="at">.names =</span> <span class="st">"{.col}_{.fn}"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb148-31"><a href="#cb148-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(), <span class="at">names_to =</span> <span class="st">"stat"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb148-32"><a href="#cb148-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">separate</span>(stat, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"Variable"</span>, <span class="st">"Statistic"</span>), <span class="at">sep =</span> <span class="st">"_(?=[^_]+$)"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb148-33"><a href="#cb148-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> Statistic, <span class="at">values_from =</span> value) <span class="sc">%&gt;%</span></span>
<span id="cb148-34"><a href="#cb148-34" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(Variable, N, Mean, SD, Min, Q25, Median, Q75, Max) <span class="sc">%&gt;%</span></span>
<span id="cb148-35"><a href="#cb148-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(Mean, SD, Min, Q25, Median, Q75, Max), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">3</span>)))</span>
<span id="cb148-36"><a href="#cb148-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb148-37"><a href="#cb148-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"file"</span>)) <span class="fu">dir.create</span>(<span class="st">"file"</span>)</span>
<span id="cb148-38"><a href="#cb148-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(desc_stats, <span class="st">"file/descriptive_statistics.csv"</span>)</span>
<span id="cb148-39"><a href="#cb148-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  ✓ file/descriptive_statistics.csv</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb148-40"><a href="#cb148-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">as.data.frame</span>(desc_stats), <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb148-41"><a href="#cb148-41" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ✓ file/descriptive_statistics.csv
            Variable     N       Mean         SD       Min        Q25
          sale_price 24023 340590.503 466810.992 10000.000 151970.000
  total_livable_area 24023   1359.120    576.839   308.000   1050.000
  number_of_bedrooms 24023      2.972      0.789     1.000      3.000
 number_of_bathrooms 24023      1.444      0.686     1.000      1.000
                 age 24023     85.799     32.549     0.000     72.000
      median_incomeE 24023  66445.992  31346.114 14983.000  41325.000
     per_cap_incomeE 24023  39700.301  25344.230  7802.000  21372.000
          PCTPOVERTY 24023     20.826     13.396     0.719     10.596
          PCBACHMORE 24023     34.706     24.837     0.530     15.362
     Median        Q75          Max
 248000.000 370000.000 15428633.000
   1208.000   1492.000    14150.000
      3.000      3.000       12.000
      1.000      2.000       12.000
    100.000    105.000      275.000
  59837.000  86989.000   181066.000
  31406.000  48558.000   173777.000
     17.939     29.449       77.833
     27.435     53.441       95.598</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Distribution Plots</span></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Generating distribution comparison plots ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== Generating distribution comparison plots ===</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>plot_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(num_vars), <span class="cf">function</span>(v) {</span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>  is_transformed <span class="ot">&lt;-</span> v <span class="sc">%in%</span> logged_vars</span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Original distribution</span></span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> <span class="sc">!!</span><span class="fu">sym</span>(v))) <span class="sc">+</span></span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">fill =</span> <span class="st">"#053061"</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">alpha =</span> <span class="fl">0.85</span>) <span class="sc">+</span></span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(v, <span class="st">" (Original)"</span>), <span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Count"</span>) <span class="sc">+</span></span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">9</span>) <span class="sc">+</span></span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"#E5E5E5"</span>, <span class="at">linewidth =</span> <span class="fl">0.3</span>),</span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>),</span>
<span id="cb154-14"><a href="#cb154-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb154-15"><a href="#cb154-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb154-16"><a href="#cb154-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb154-17"><a href="#cb154-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-18"><a href="#cb154-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transformed distribution</span></span>
<span id="cb154-19"><a href="#cb154-19" aria-hidden="true" tabindex="-1"></a>  fill_color <span class="ot">&lt;-</span> <span class="cf">if</span> (is_transformed) <span class="st">"#67001F"</span> <span class="cf">else</span> <span class="st">"#4393C3"</span></span>
<span id="cb154-20"><a href="#cb154-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-21"><a href="#cb154-21" aria-hidden="true" tabindex="-1"></a>  p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_trans, <span class="fu">aes</span>(<span class="at">x =</span> <span class="sc">!!</span><span class="fu">sym</span>(v))) <span class="sc">+</span></span>
<span id="cb154-22"><a href="#cb154-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">fill =</span> fill_color, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">alpha =</span> <span class="fl">0.85</span>) <span class="sc">+</span></span>
<span id="cb154-23"><a href="#cb154-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb154-24"><a href="#cb154-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="fu">paste0</span>(v, <span class="cf">if</span> (is_transformed) <span class="st">" (Log-transformed)"</span> <span class="cf">else</span> <span class="st">" (No transformation)"</span>),</span>
<span id="cb154-25"><a href="#cb154-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Count"</span></span>
<span id="cb154-26"><a href="#cb154-26" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb154-27"><a href="#cb154-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">9</span>) <span class="sc">+</span></span>
<span id="cb154-28"><a href="#cb154-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb154-29"><a href="#cb154-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb154-30"><a href="#cb154-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb154-31"><a href="#cb154-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"#E5E5E5"</span>, <span class="at">linewidth =</span> <span class="fl">0.3</span>),</span>
<span id="cb154-32"><a href="#cb154-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>),</span>
<span id="cb154-33"><a href="#cb154-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb154-34"><a href="#cb154-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb154-35"><a href="#cb154-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb154-36"><a href="#cb154-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-37"><a href="#cb154-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add skewness annotation</span></span>
<span id="cb154-38"><a href="#cb154-38" aria-hidden="true" tabindex="-1"></a>  skew_val <span class="ot">&lt;-</span> <span class="fu">round</span>(skews[v], <span class="dv">2</span>)</span>
<span id="cb154-39"><a href="#cb154-39" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> p1 <span class="sc">+</span> <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="cn">Inf</span>, <span class="at">y =</span> <span class="cn">Inf</span>, </span>
<span id="cb154-40"><a href="#cb154-40" aria-hidden="true" tabindex="-1"></a>                      <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Skewness: "</span>, skew_val),</span>
<span id="cb154-41"><a href="#cb154-41" aria-hidden="true" tabindex="-1"></a>                      <span class="at">hjust =</span> <span class="fl">1.1</span>, <span class="at">vjust =</span> <span class="fl">1.5</span>, <span class="at">size =</span> <span class="fl">2.5</span>, <span class="at">color =</span> <span class="st">"gray30"</span>)</span>
<span id="cb154-42"><a href="#cb154-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-43"><a href="#cb154-43" aria-hidden="true" tabindex="-1"></a>  pair_plot <span class="ot">&lt;-</span> (p1 <span class="sc">|</span> p2) <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">widths =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>)) <span class="sc">&amp;</span></span>
<span id="cb154-44"><a href="#cb154-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>))</span>
<span id="cb154-45"><a href="#cb154-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb154-46"><a href="#cb154-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">wrap_elements</span>(pair_plot) <span class="sc">+</span> </span>
<span id="cb154-47"><a href="#cb154-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb154-48"><a href="#cb154-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="st">"#B0B0B0"</span>, <span class="at">linewidth =</span> <span class="fl">1.2</span>),</span>
<span id="cb154-49"><a href="#cb154-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="dv">6</span>, <span class="dv">6</span>, <span class="dv">6</span>, <span class="dv">6</span>)</span>
<span id="cb154-50"><a href="#cb154-50" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb154-51"><a href="#cb154-51" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb154-52"><a href="#cb154-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-53"><a href="#cb154-53" aria-hidden="true" tabindex="-1"></a>all_plot <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plot_list, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb154-54"><a href="#cb154-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_annotation</span>(</span>
<span id="cb154-55"><a href="#cb154-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Variable Distributions: Original vs. Transformed"</span>,</span>
<span id="cb154-56"><a href="#cb154-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste0</span>(</span>
<span id="cb154-57"><a href="#cb154-57" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Dark Blue = Original | Dark Red = Log-transformed (|skew| &gt; 1) | Medium Blue = No transformation"</span></span>
<span id="cb154-58"><a href="#cb154-58" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb154-59"><a href="#cb154-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(</span>
<span id="cb154-60"><a href="#cb154-60" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb154-61"><a href="#cb154-61" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"gray30"</span>),</span>
<span id="cb154-62"><a href="#cb154-62" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb154-63"><a href="#cb154-63" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb154-64"><a href="#cb154-64" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Skewness Summary Plot</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>skew_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable =</span> <span class="fu">names</span>(skews),</span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">skewness =</span> skews,</span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">transformed =</span> <span class="fu">names</span>(skews) <span class="sc">%in%</span> logged_vars</span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(skewness)))</span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>p_skew <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(skew_df, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(variable, <span class="fu">abs</span>(skewness)), <span class="at">y =</span> skewness, <span class="at">fill =</span> transformed)) <span class="sc">+</span></span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">alpha =</span> <span class="fl">0.85</span>) <span class="sc">+</span></span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"#67001F"</span>, <span class="at">linewidth =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"solid"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>, <span class="at">linewidth =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb155-13"><a href="#cb155-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"#053061"</span>, <span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"#67001F"</span>),</span>
<span id="cb155-14"><a href="#cb155-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"No transformation"</span>, <span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"Log-transformed"</span>),</span>
<span id="cb155-15"><a href="#cb155-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="cn">NULL</span></span>
<span id="cb155-16"><a href="#cb155-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb155-17"><a href="#cb155-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb155-18"><a href="#cb155-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb155-19"><a href="#cb155-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Skewness of All Variables"</span>,</span>
<span id="cb155-20"><a href="#cb155-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Variables with |skewness| &gt; 1 are log-transformed"</span>,</span>
<span id="cb155-21"><a href="#cb155-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Variable"</span>, <span class="at">y =</span> <span class="st">"Skewness"</span>,</span>
<span id="cb155-22"><a href="#cb155-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Dashed lines indicate skewness thresholds at ±1"</span></span>
<span id="cb155-23"><a href="#cb155-23" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb155-24"><a href="#cb155-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb155-25"><a href="#cb155-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb155-26"><a href="#cb155-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb155-27"><a href="#cb155-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">"gray40"</span>),</span>
<span id="cb155-28"><a href="#cb155-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb155-29"><a href="#cb155-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb155-30"><a href="#cb155-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb155-31"><a href="#cb155-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb155-32"><a href="#cb155-32" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Categorical Variable Distribution Plots</span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Generating categorical variable distribution plots ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== Generating categorical variable distribution plots ===</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>cat_vars_viz <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"interior_condition"</span>, <span class="st">"exterior_condition"</span>)</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>cat_vars_viz <span class="ot">&lt;-</span> <span class="fu">intersect</span>(cat_vars_viz, <span class="fu">names</span>(df_trans))</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(cat_vars_viz) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(y_var)) {</span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>  plot_list_cat <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (var <span class="cf">in</span> cat_vars_viz) {</span>
<span id="cb160-8"><a href="#cb160-8" aria-hidden="true" tabindex="-1"></a>    cat_summary <span class="ot">&lt;-</span> df_trans <span class="sc">%&gt;%</span></span>
<span id="cb160-9"><a href="#cb160-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(<span class="sc">!!</span><span class="fu">sym</span>(var)) <span class="sc">%&gt;%</span></span>
<span id="cb160-10"><a href="#cb160-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(</span>
<span id="cb160-11"><a href="#cb160-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">count =</span> <span class="fu">n</span>(),</span>
<span id="cb160-12"><a href="#cb160-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean_price =</span> <span class="fu">mean</span>(.data[[y_var]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb160-13"><a href="#cb160-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb160-14"><a href="#cb160-14" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb160-15"><a href="#cb160-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="sc">!!</span><span class="fu">sym</span>(var))) <span class="sc">%&gt;%</span></span>
<span id="cb160-16"><a href="#cb160-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">arrange</span>(<span class="fu">desc</span>(mean_price))</span>
<span id="cb160-17"><a href="#cb160-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-18"><a href="#cb160-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(cat_summary) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb160-19"><a href="#cb160-19" aria-hidden="true" tabindex="-1"></a>      p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(cat_summary, <span class="fu">aes</span>(<span class="fu">reorder</span>(<span class="sc">!!</span><span class="fu">sym</span>(var), mean_price), mean_price, <span class="at">fill =</span> mean_price)) <span class="sc">+</span></span>
<span id="cb160-20"><a href="#cb160-20" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_col</span>(<span class="at">alpha =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb160-21"><a href="#cb160-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> count), <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb160-22"><a href="#cb160-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scale_fill_gradient2</span>(</span>
<span id="cb160-23"><a href="#cb160-23" aria-hidden="true" tabindex="-1"></a>          <span class="at">low =</span> <span class="st">"#053061"</span>, <span class="at">mid =</span> <span class="st">"#F7F7F7"</span>, <span class="at">high =</span> <span class="st">"#67001F"</span>,</span>
<span id="cb160-24"><a href="#cb160-24" aria-hidden="true" tabindex="-1"></a>          <span class="at">midpoint =</span> <span class="fu">median</span>(cat_summary<span class="sc">$</span>mean_price, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb160-25"><a href="#cb160-25" aria-hidden="true" tabindex="-1"></a>          <span class="at">guide =</span> <span class="st">"none"</span></span>
<span id="cb160-26"><a href="#cb160-26" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">+</span></span>
<span id="cb160-27"><a href="#cb160-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb160-28"><a href="#cb160-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb160-29"><a href="#cb160-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme</span>(</span>
<span id="cb160-30"><a href="#cb160-30" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb160-31"><a href="#cb160-31" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb160-32"><a href="#cb160-32" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb160-33"><a href="#cb160-33" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb160-34"><a href="#cb160-34" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">+</span></span>
<span id="cb160-35"><a href="#cb160-35" aria-hidden="true" tabindex="-1"></a>        <span class="fu">labs</span>(</span>
<span id="cb160-36"><a href="#cb160-36" aria-hidden="true" tabindex="-1"></a>          <span class="at">title =</span> <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, <span class="fu">toupper</span>(var)),</span>
<span id="cb160-37"><a href="#cb160-37" aria-hidden="true" tabindex="-1"></a>          <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb160-38"><a href="#cb160-38" aria-hidden="true" tabindex="-1"></a>          <span class="at">y =</span> <span class="st">"Average Sale Price (log)"</span>,</span>
<span id="cb160-39"><a href="#cb160-39" aria-hidden="true" tabindex="-1"></a>          <span class="at">caption =</span> <span class="st">"Numbers indicate the count in each category"</span></span>
<span id="cb160-40"><a href="#cb160-40" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb160-41"><a href="#cb160-41" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb160-42"><a href="#cb160-42" aria-hidden="true" tabindex="-1"></a>      plot_list_cat[[var]] <span class="ot">&lt;-</span> p</span>
<span id="cb160-43"><a href="#cb160-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb160-44"><a href="#cb160-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb160-45"><a href="#cb160-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-46"><a href="#cb160-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(plot_list_cat) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb160-47"><a href="#cb160-47" aria-hidden="true" tabindex="-1"></a>    p_cat_combined <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plot_list_cat, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb160-48"><a href="#cb160-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot_annotation</span>(</span>
<span id="cb160-49"><a href="#cb160-49" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Average Sale Price by Property Condition"</span>,</span>
<span id="cb160-50"><a href="#cb160-50" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"Log-transformed sale prices"</span>,</span>
<span id="cb160-51"><a href="#cb160-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">theme =</span> <span class="fu">theme</span>(</span>
<span id="cb160-52"><a href="#cb160-52" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb160-53"><a href="#cb160-53" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb160-54"><a href="#cb160-54" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb160-55"><a href="#cb160-55" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb160-56"><a href="#cb160-56" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb160-57"><a href="#cb160-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-58"><a href="#cb160-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"plot"</span>)) <span class="fu">dir.create</span>(<span class="st">"plot"</span>)</span>
<span id="cb160-59"><a href="#cb160-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="st">"plot/categorical_price_comparison.png"</span>, p_cat_combined,</span>
<span id="cb160-60"><a href="#cb160-60" aria-hidden="true" tabindex="-1"></a>           <span class="at">width =</span> <span class="dv">12</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb160-61"><a href="#cb160-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  ✓ plot/categorical_price_comparison.png</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-62"><a href="#cb160-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb160-63"><a href="#cb160-63" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ✓ plot/categorical_price_comparison.png</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Output Files</span></span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"plot"</span>)) <span class="fu">dir.create</span>(<span class="st">"plot"</span>)</span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"file"</span>)) <span class="fu">dir.create</span>(<span class="st">"file"</span>)</span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"plot/all_variables_distribution.png"</span>, <span class="at">plot =</span> all_plot, <span class="at">width =</span> <span class="dv">20</span>, <span class="at">height =</span> <span class="dv">12</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"plot/skewness_summary.png"</span>, <span class="at">plot =</span> p_skew, <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(logged_vars, <span class="st">"file/logged_variables.txt"</span>)</span>
<span id="cb162-11"><a href="#cb162-11" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(df_trans, <span class="st">"file/opa_sales_step1_clean.csv"</span>)</span>
<span id="cb162-12"><a href="#cb162-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-13"><a href="#cb162-13" aria-hidden="true" tabindex="-1"></a>transform_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb162-14"><a href="#cb162-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">Variable =</span> <span class="fu">names</span>(skews),</span>
<span id="cb162-15"><a href="#cb162-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">Original_Skewness =</span> <span class="fu">round</span>(skews, <span class="dv">3</span>),</span>
<span id="cb162-16"><a href="#cb162-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">Transformed =</span> <span class="fu">names</span>(skews) <span class="sc">%in%</span> logged_vars</span>
<span id="cb162-17"><a href="#cb162-17" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(Original_Skewness)))</span>
<span id="cb162-18"><a href="#cb162-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-19"><a href="#cb162-19" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(transform_summary, <span class="st">"file/transformation_summary.csv"</span>)</span>
<span id="cb162-20"><a href="#cb162-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-21"><a href="#cb162-21" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb162-22"><a href="#cb162-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary</span></span>
<span id="cb162-23"><a href="#cb162-23" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb162-24"><a href="#cb162-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-25"><a href="#cb162-25" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb164"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">" Step 1 Completed</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> Step 1 Completed</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb168"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">" Output Files:</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> Output Files:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb170"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Tables:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Tables:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb172"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • file/descriptive_statistics.csv - Descriptive statistics</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • file/descriptive_statistics.csv - Descriptive statistics</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb174"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • file/transformation_summary.csv - Transformation summary</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • file/transformation_summary.csv - Transformation summary</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb176"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • file/logged_variables.txt - List of log-transformed variables</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • file/logged_variables.txt - List of log-transformed variables</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb178"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • file/opa_sales_step1_clean.csv - Cleaned dataset</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • file/opa_sales_step1_clean.csv - Cleaned dataset</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb180"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Figures:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Figures:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb182"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • plot/all_variables_distribution.png - All variables: original vs. transformed</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • plot/all_variables_distribution.png - All variables: original vs. transformed</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb184"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • plot/skewness_summary.png - Skewness summary</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • plot/skewness_summary.png - Skewness summary</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb186"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • plot/categorical_price_comparison.png - Categorical variables vs. sale price</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • plot/categorical_price_comparison.png - Categorical variables vs. sale price</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb188"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"📈 Stats:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>📈 Stats:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb190"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  • Variables with |skew| &gt; 1: %d</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">length</span>(logged_vars)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • Variables with |skew| &gt; 1: 10</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb192"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  • Final number of variables: %d</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">ncol</span>(df_trans)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • Final number of variables: 29</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb194"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  • Final sample size: %d</span><span class="sc">\n\n</span><span class="st">"</span>, <span class="fu">nrow</span>(df_trans)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • Final sample size: 24023</code></pre>
</div>
</div>
<p>Step2</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb196"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2 Enhanced: Correlation Matrix + VIF + Spatial Visualization + Scatterplots</span></span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb196-6"><a href="#cb196-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb196-7"><a href="#cb196-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)</span>
<span id="cb196-8"><a href="#cb196-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span>
<span id="cb196-9"><a href="#cb196-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb196-10"><a href="#cb196-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb196-11"><a href="#cb196-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-12"><a href="#cb196-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb198"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Step 2: Correlation Analysis, Multicollinearity, and Spatial Exploration</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Step 2: Correlation Analysis, Multicollinearity, and Spatial Exploration</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb200"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb202"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === Read Data ===</span></span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"file/opa_sales_step1_clean.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-4"><a href="#cb202-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Sample size: %d</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">nrow</span>(df)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sample size: 24023</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb204"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Number of variables: %d</span><span class="sc">\n\n</span><span class="st">"</span>, <span class="fu">ncol</span>(df)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of variables: 29</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb206"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === Auto-detect target variable ===</span></span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a>y_var <span class="ot">&lt;-</span> <span class="fu">case_when</span>(</span>
<span id="cb206-3"><a href="#cb206-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sale_price_log"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df) <span class="sc">~</span> <span class="st">"sale_price_log"</span>,</span>
<span id="cb206-4"><a href="#cb206-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"log_sale_price"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df) <span class="sc">~</span> <span class="st">"log_sale_price"</span>,</span>
<span id="cb206-5"><a href="#cb206-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sale_price"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df) <span class="sc">~</span> <span class="st">"sale_price"</span>,</span>
<span id="cb206-6"><a href="#cb206-6" aria-hidden="true" tabindex="-1"></a>  <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb206-7"><a href="#cb206-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb206-8"><a href="#cb206-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.na</span>(y_var)) <span class="fu">stop</span>(<span class="st">" Target variable not found"</span>)</span>
<span id="cb206-9"><a href="#cb206-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-10"><a href="#cb206-10" aria-hidden="true" tabindex="-1"></a>cat_vars <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">c</span>(<span class="st">"interior_condition"</span>, <span class="st">"exterior_condition"</span>, <span class="st">"zip_code"</span>, <span class="st">"census_tract"</span>), <span class="fu">names</span>(df))</span>
<span id="cb206-11"><a href="#cb206-11" aria-hidden="true" tabindex="-1"></a>coord_vars <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">c</span>(<span class="st">"x_coord"</span>, <span class="st">"y_coord"</span>), <span class="fu">names</span>(df))</span>
<span id="cb206-12"><a href="#cb206-12" aria-hidden="true" tabindex="-1"></a>df[cat_vars] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(df[cat_vars], factor)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb207"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Correlation Matrix</span></span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Generating correlation matrix ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== Generating correlation matrix ===</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb209"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a>num_df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">where</span>(is.numeric))</span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a>num_df <span class="ot">&lt;-</span> num_df[, <span class="fu">sapply</span>(num_df, <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">0</span>), drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-4"><a href="#cb209-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">ncol</span>(num_df) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb209-5"><a href="#cb209-5" aria-hidden="true" tabindex="-1"></a>  corr_mat <span class="ot">&lt;-</span> <span class="fu">cor</span>(num_df, <span class="at">use =</span> <span class="st">"pairwise.complete.obs"</span>)</span>
<span id="cb209-6"><a href="#cb209-6" aria-hidden="true" tabindex="-1"></a>  corr_mat[<span class="fu">upper.tri</span>(corr_mat)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb209-7"><a href="#cb209-7" aria-hidden="true" tabindex="-1"></a>  corr_melt <span class="ot">&lt;-</span> <span class="fu">melt</span>(corr_mat, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb209-8"><a href="#cb209-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb209-9"><a href="#cb209-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If there are too many variables, keep only the first 50</span></span>
<span id="cb209-10"><a href="#cb209-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">ncol</span>(num_df) <span class="sc">&gt;</span> <span class="dv">50</span>) {</span>
<span id="cb209-11"><a href="#cb209-11" aria-hidden="true" tabindex="-1"></a>    vars_top <span class="ot">&lt;-</span> <span class="fu">names</span>(num_df)[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>]</span>
<span id="cb209-12"><a href="#cb209-12" aria-hidden="true" tabindex="-1"></a>    corr_melt <span class="ot">&lt;-</span> corr_melt <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Var1 <span class="sc">%in%</span> vars_top <span class="sc">&amp;</span> Var2 <span class="sc">%in%</span> vars_top)</span>
<span id="cb209-13"><a href="#cb209-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb209-14"><a href="#cb209-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb209-15"><a href="#cb209-15" aria-hidden="true" tabindex="-1"></a>  p_corr <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(corr_melt, <span class="fu">aes</span>(Var2, Var1, <span class="at">fill =</span> value, <span class="at">size =</span> <span class="fu">abs</span>(value))) <span class="sc">+</span></span>
<span id="cb209-16"><a href="#cb209-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="dv">21</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">stroke =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb209-17"><a href="#cb209-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradient2</span>(</span>
<span id="cb209-18"><a href="#cb209-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">low =</span> <span class="st">"#053061"</span>, <span class="at">mid =</span> <span class="st">"#F7F7F7"</span>, <span class="at">high =</span> <span class="st">"#67001F"</span>,</span>
<span id="cb209-19"><a href="#cb209-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">midpoint =</span> <span class="dv">0</span>, <span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>), <span class="at">name =</span> <span class="cn">NULL</span>,</span>
<span id="cb209-20"><a href="#cb209-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">0.2</span>)</span>
<span id="cb209-21"><a href="#cb209-21" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb209-22"><a href="#cb209-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">10</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb209-23"><a href="#cb209-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_discrete</span>(<span class="at">position =</span> <span class="st">"top"</span>) <span class="sc">+</span></span>
<span id="cb209-24"><a href="#cb209-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_discrete</span>(<span class="at">limits =</span> rev) <span class="sc">+</span></span>
<span id="cb209-25"><a href="#cb209-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb209-26"><a href="#cb209-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb209-27"><a href="#cb209-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.x.top =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">vjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">9</span>, <span class="at">color =</span> <span class="st">"black"</span>),</span>
<span id="cb209-28"><a href="#cb209-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>, <span class="at">color =</span> <span class="st">"black"</span>),</span>
<span id="cb209-29"><a href="#cb209-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb209-30"><a href="#cb209-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"#E0E0E0"</span>, <span class="at">linewidth =</span> <span class="fl">0.5</span>),</span>
<span id="cb209-31"><a href="#cb209-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb209-32"><a href="#cb209-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb209-33"><a href="#cb209-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb209-34"><a href="#cb209-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb209-35"><a href="#cb209-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb209-36"><a href="#cb209-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.key.width =</span> <span class="fu">unit</span>(<span class="dv">3</span>, <span class="st">"cm"</span>),</span>
<span id="cb209-37"><a href="#cb209-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.key.height =</span> <span class="fu">unit</span>(<span class="fl">0.4</span>, <span class="st">"cm"</span>),</span>
<span id="cb209-38"><a href="#cb209-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb209-39"><a href="#cb209-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">10</span>)</span>
<span id="cb209-40"><a href="#cb209-40" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb209-41"><a href="#cb209-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Correlation Matrix"</span>) <span class="sc">+</span></span>
<span id="cb209-42"><a href="#cb209-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_fixed</span>()</span>
<span id="cb209-43"><a href="#cb209-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb209-44"><a href="#cb209-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"plot"</span>)) <span class="fu">dir.create</span>(<span class="st">"plot"</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb209-45"><a href="#cb209-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="st">"plot/corr_matrix_enhanced.png"</span>, p_corr, <span class="at">width =</span> <span class="dv">12</span>, <span class="at">height =</span> <span class="dv">10</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb209-46"><a href="#cb209-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"   plot/corr_matrix_enhanced.png</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb209-47"><a href="#cb209-47" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>   plot/corr_matrix_enhanced.png</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb211"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. VIF Analysis</span></span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb211-4"><a href="#cb211-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-5"><a href="#cb211-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb213"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== VIF Analysis ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== VIF Analysis ===</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb215"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a>vif_vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(df), <span class="fu">c</span>(y_var, cat_vars, coord_vars))</span>
<span id="cb215-2"><a href="#cb215-2" aria-hidden="true" tabindex="-1"></a>num_vif <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">all_of</span>(vif_vars)) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">where</span>(is.numeric))</span>
<span id="cb215-3"><a href="#cb215-3" aria-hidden="true" tabindex="-1"></a>num_vif <span class="ot">&lt;-</span> num_vif[, <span class="fu">sapply</span>(num_vif, <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">0</span>), drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb215-4"><a href="#cb215-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-5"><a href="#cb215-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">ncol</span>(num_vif) <span class="sc">&gt;=</span> <span class="dv">2</span>) {</span>
<span id="cb215-6"><a href="#cb215-6" aria-hidden="true" tabindex="-1"></a>  df_vif <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(y_var, <span class="fu">names</span>(num_vif)))) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>()</span>
<span id="cb215-7"><a href="#cb215-7" aria-hidden="true" tabindex="-1"></a>  f_vif <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(y_var, <span class="st">"~ ."</span>))</span>
<span id="cb215-8"><a href="#cb215-8" aria-hidden="true" tabindex="-1"></a>  vif_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(f_vif, <span class="at">data =</span> df_vif)</span>
<span id="cb215-9"><a href="#cb215-9" aria-hidden="true" tabindex="-1"></a>  vif_vals <span class="ot">&lt;-</span> car<span class="sc">::</span><span class="fu">vif</span>(vif_model)</span>
<span id="cb215-10"><a href="#cb215-10" aria-hidden="true" tabindex="-1"></a>  vif_tbl <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">variable =</span> <span class="fu">names</span>(vif_vals), <span class="at">VIF =</span> <span class="fu">round</span>(vif_vals, <span class="dv">3</span>))</span>
<span id="cb215-11"><a href="#cb215-11" aria-hidden="true" tabindex="-1"></a>  vif_tbl <span class="ot">&lt;-</span> vif_tbl <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(VIF))</span>
<span id="cb215-12"><a href="#cb215-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb215-13"><a href="#cb215-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"file"</span>)) <span class="fu">dir.create</span>(<span class="st">"file"</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb215-14"><a href="#cb215-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(vif_tbl, <span class="st">"file/vif_values.csv"</span>)</span>
<span id="cb215-15"><a href="#cb215-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  ✓ file/vif_values.csv</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb215-16"><a href="#cb215-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb215-17"><a href="#cb215-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># High VIF warning</span></span>
<span id="cb215-18"><a href="#cb215-18" aria-hidden="true" tabindex="-1"></a>  high_vif <span class="ot">&lt;-</span> vif_tbl <span class="sc">%&gt;%</span> <span class="fu">filter</span>(VIF <span class="sc">&gt;</span> <span class="dv">10</span>)</span>
<span id="cb215-19"><a href="#cb215-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(high_vif) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb215-20"><a href="#cb215-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">  Variables with high multicollinearity (VIF &gt; 10):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb215-21"><a href="#cb215-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">as.data.frame</span>(high_vif), <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb215-22"><a href="#cb215-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb215-23"><a href="#cb215-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb215-24"><a href="#cb215-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># VIF visualization</span></span>
<span id="cb215-25"><a href="#cb215-25" aria-hidden="true" tabindex="-1"></a>  vif_top20 <span class="ot">&lt;-</span> vif_tbl <span class="sc">%&gt;%</span> <span class="fu">top_n</span>(<span class="dv">20</span>, VIF)</span>
<span id="cb215-26"><a href="#cb215-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb215-27"><a href="#cb215-27" aria-hidden="true" tabindex="-1"></a>  p_vif <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(vif_top20, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(variable, VIF), <span class="at">y =</span> VIF, <span class="at">fill =</span> VIF)) <span class="sc">+</span></span>
<span id="cb215-28"><a href="#cb215-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_col</span>(<span class="at">alpha =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb215-29"><a href="#cb215-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradient2</span>(</span>
<span id="cb215-30"><a href="#cb215-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">low =</span> <span class="st">"#053061"</span>, <span class="at">mid =</span> <span class="st">"#F7F7F7"</span>, <span class="at">high =</span> <span class="st">"#67001F"</span>,</span>
<span id="cb215-31"><a href="#cb215-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">midpoint =</span> <span class="dv">5</span>, <span class="at">name =</span> <span class="st">"VIF Value"</span></span>
<span id="cb215-32"><a href="#cb215-32" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb215-33"><a href="#cb215-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">10</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"#67001F"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb215-34"><a href="#cb215-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">5</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>, <span class="at">linewidth =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb215-35"><a href="#cb215-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb215-36"><a href="#cb215-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb215-37"><a href="#cb215-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb215-38"><a href="#cb215-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb215-39"><a href="#cb215-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb215-40"><a href="#cb215-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">"gray40"</span>),</span>
<span id="cb215-41"><a href="#cb215-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb215-42"><a href="#cb215-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb215-43"><a href="#cb215-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb215-44"><a href="#cb215-44" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb215-45"><a href="#cb215-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb215-46"><a href="#cb215-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Variance Inflation Factor (VIF) - Top 20"</span>,</span>
<span id="cb215-47"><a href="#cb215-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="st">"Color gradient: Blue (low VIF) → Red (high VIF)"</span>,</span>
<span id="cb215-48"><a href="#cb215-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Variable"</span>, <span class="at">y =</span> <span class="st">"VIF Value"</span>,</span>
<span id="cb215-49"><a href="#cb215-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption =</span> <span class="st">"Dark red line: VIF=10 (High multicollinearity) | Gray line: VIF=5 (Moderate)"</span></span>
<span id="cb215-50"><a href="#cb215-50" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb215-51"><a href="#cb215-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb215-52"><a href="#cb215-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="st">"plot/vif_analysis.png"</span>, p_vif, <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb215-53"><a href="#cb215-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"   plot/vif_analysis.png</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb215-54"><a href="#cb215-54" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ✓ file/vif_values.csv

  Variables with high multicollinearity (VIF &gt; 10):
        variable    VIF
 per_cap_incomeE 10.608</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>   plot/vif_analysis.png</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb218"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Spatial Visualization</span></span>
<span id="cb218-3"><a href="#cb218-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb218-4"><a href="#cb218-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-5"><a href="#cb218-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"x_coord"</span>, <span class="st">"y_coord"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(df))) {</span>
<span id="cb218-6"><a href="#cb218-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb218-7"><a href="#cb218-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"=== Spatial Distribution Visualization ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb218-8"><a href="#cb218-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb218-9"><a href="#cb218-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3.1 Spatial distribution of sale prices</span></span>
<span id="cb218-10"><a href="#cb218-10" aria-hidden="true" tabindex="-1"></a>  p_spatial_price <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(x_coord, y_coord, <span class="at">color =</span> .data[[y_var]])) <span class="sc">+</span></span>
<span id="cb218-11"><a href="#cb218-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">size =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb218-12"><a href="#cb218-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_gradient2</span>(</span>
<span id="cb218-13"><a href="#cb218-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">low =</span> <span class="st">"#053061"</span>, <span class="at">mid =</span> <span class="st">"#F7F7F7"</span>, <span class="at">high =</span> <span class="st">"#67001F"</span>,</span>
<span id="cb218-14"><a href="#cb218-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">midpoint =</span> <span class="fu">median</span>(df[[y_var]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb218-15"><a href="#cb218-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Sale Price</span><span class="sc">\n</span><span class="st">(log)"</span></span>
<span id="cb218-16"><a href="#cb218-16" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb218-17"><a href="#cb218-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb218-18"><a href="#cb218-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb218-19"><a href="#cb218-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb218-20"><a href="#cb218-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb218-21"><a href="#cb218-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">11</span>),</span>
<span id="cb218-22"><a href="#cb218-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb218-23"><a href="#cb218-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"right"</span></span>
<span id="cb218-24"><a href="#cb218-24" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb218-25"><a href="#cb218-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb218-26"><a href="#cb218-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Spatial Distribution of Sale Prices"</span>,</span>
<span id="cb218-27"><a href="#cb218-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="st">"Philadelphia housing market"</span>,</span>
<span id="cb218-28"><a href="#cb218-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"X Coordinate"</span>, <span class="at">y =</span> <span class="st">"Y Coordinate"</span></span>
<span id="cb218-29"><a href="#cb218-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb218-30"><a href="#cb218-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb218-31"><a href="#cb218-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="st">"plot/spatial_price_distribution.png"</span>, p_spatial_price,</span>
<span id="cb218-32"><a href="#cb218-32" aria-hidden="true" tabindex="-1"></a>         <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb218-33"><a href="#cb218-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"   plot/spatial_price_distribution.png</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb218-34"><a href="#cb218-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb218-35"><a href="#cb218-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3.2 Hexbin density map</span></span>
<span id="cb218-36"><a href="#cb218-36" aria-hidden="true" tabindex="-1"></a>  p_hex <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(x_coord, y_coord)) <span class="sc">+</span></span>
<span id="cb218-37"><a href="#cb218-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hex</span>(<span class="fu">aes</span>(<span class="at">fill =</span> <span class="fu">after_stat</span>(count)), <span class="at">bins =</span> <span class="dv">40</span>) <span class="sc">+</span></span>
<span id="cb218-38"><a href="#cb218-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradient</span>(</span>
<span id="cb218-39"><a href="#cb218-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">low =</span> <span class="st">"#F7F7F7"</span>, <span class="at">high =</span> <span class="st">"#67001F"</span>,</span>
<span id="cb218-40"><a href="#cb218-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Count"</span></span>
<span id="cb218-41"><a href="#cb218-41" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb218-42"><a href="#cb218-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb218-43"><a href="#cb218-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb218-44"><a href="#cb218-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb218-45"><a href="#cb218-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb218-46"><a href="#cb218-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">11</span>),</span>
<span id="cb218-47"><a href="#cb218-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb218-48"><a href="#cb218-48" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb218-49"><a href="#cb218-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb218-50"><a href="#cb218-50" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Housing Density Heatmap"</span>,</span>
<span id="cb218-51"><a href="#cb218-51" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="st">"Hexagonal binning of property locations"</span>,</span>
<span id="cb218-52"><a href="#cb218-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"X Coordinate"</span>, <span class="at">y =</span> <span class="st">"Y Coordinate"</span></span>
<span id="cb218-53"><a href="#cb218-53" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb218-54"><a href="#cb218-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb218-55"><a href="#cb218-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="st">"plot/spatial_density_hexbin.png"</span>, p_hex,</span>
<span id="cb218-56"><a href="#cb218-56" aria-hidden="true" tabindex="-1"></a>         <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb218-57"><a href="#cb218-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"   plot/spatial_density_hexbin.png</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb218-58"><a href="#cb218-58" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================
=== Spatial Distribution Visualization ===</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>   plot/spatial_price_distribution.png</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>   plot/spatial_density_hexbin.png</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb222"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Key Variable Scatterplots</span></span>
<span id="cb222-3"><a href="#cb222-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb222-4"><a href="#cb222-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-5"><a href="#cb222-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb224"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Scatterplots: Key Variables vs. Sale Price ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== Scatterplots: Key Variables vs. Sale Price ===</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb226"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a>key_numeric <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"total_livable_area"</span>, <span class="st">"median_incomeE"</span>, <span class="st">"age"</span>, <span class="st">"number_of_bathrooms"</span>)</span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a>key_numeric <span class="ot">&lt;-</span> <span class="fu">intersect</span>(key_numeric, <span class="fu">names</span>(df))</span>
<span id="cb226-3"><a href="#cb226-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-4"><a href="#cb226-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(key_numeric) <span class="sc">&gt;=</span> <span class="dv">4</span>) {</span>
<span id="cb226-5"><a href="#cb226-5" aria-hidden="true" tabindex="-1"></a>  scatter_plots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb226-6"><a href="#cb226-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb226-7"><a href="#cb226-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (var <span class="cf">in</span> key_numeric[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]) {</span>
<span id="cb226-8"><a href="#cb226-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Correlation coefficient</span></span>
<span id="cb226-9"><a href="#cb226-9" aria-hidden="true" tabindex="-1"></a>    corr_val <span class="ot">&lt;-</span> <span class="fu">cor</span>(df[[var]], df[[y_var]], <span class="at">use =</span> <span class="st">"pairwise.complete.obs"</span>)</span>
<span id="cb226-10"><a href="#cb226-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb226-11"><a href="#cb226-11" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(.data[[var]], .data[[y_var]])) <span class="sc">+</span></span>
<span id="cb226-12"><a href="#cb226-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size =</span> <span class="fl">0.8</span>, <span class="at">color =</span> <span class="st">"#053061"</span>) <span class="sc">+</span></span>
<span id="cb226-13"><a href="#cb226-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">color =</span> <span class="st">"#67001F"</span>, <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb226-14"><a href="#cb226-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="cn">Inf</span>, <span class="at">y =</span> <span class="sc">-</span><span class="cn">Inf</span>, </span>
<span id="cb226-15"><a href="#cb226-15" aria-hidden="true" tabindex="-1"></a>               <span class="at">label =</span> <span class="fu">sprintf</span>(<span class="st">"r = %.3f"</span>, corr_val),</span>
<span id="cb226-16"><a href="#cb226-16" aria-hidden="true" tabindex="-1"></a>               <span class="at">hjust =</span> <span class="fl">1.1</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">color =</span> <span class="st">"#67001F"</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb226-17"><a href="#cb226-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb226-18"><a href="#cb226-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(</span>
<span id="cb226-19"><a href="#cb226-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb226-20"><a href="#cb226-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">11</span>),</span>
<span id="cb226-21"><a href="#cb226-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb226-22"><a href="#cb226-22" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb226-23"><a href="#cb226-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(</span>
<span id="cb226-24"><a href="#cb226-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, var),</span>
<span id="cb226-25"><a href="#cb226-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, var),</span>
<span id="cb226-26"><a href="#cb226-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Sale Price (log)"</span></span>
<span id="cb226-27"><a href="#cb226-27" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb226-28"><a href="#cb226-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb226-29"><a href="#cb226-29" aria-hidden="true" tabindex="-1"></a>    scatter_plots[[var]] <span class="ot">&lt;-</span> p</span>
<span id="cb226-30"><a href="#cb226-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb226-31"><a href="#cb226-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb226-32"><a href="#cb226-32" aria-hidden="true" tabindex="-1"></a>  p_scatter <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(scatter_plots, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb226-33"><a href="#cb226-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_annotation</span>(</span>
<span id="cb226-34"><a href="#cb226-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Key Variables vs. Sale Price"</span>,</span>
<span id="cb226-35"><a href="#cb226-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="st">"Linear fit (OLS) with correlation coefficients"</span>,</span>
<span id="cb226-36"><a href="#cb226-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">theme =</span> <span class="fu">theme</span>(</span>
<span id="cb226-37"><a href="#cb226-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb226-38"><a href="#cb226-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb226-39"><a href="#cb226-39" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb226-40"><a href="#cb226-40" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb226-41"><a href="#cb226-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb226-42"><a href="#cb226-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb226-43"><a href="#cb226-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="st">"plot/key_variables_scatter.png"</span>, p_scatter,</span>
<span id="cb226-44"><a href="#cb226-44" aria-hidden="true" tabindex="-1"></a>         <span class="at">width =</span> <span class="dv">12</span>, <span class="at">height =</span> <span class="dv">10</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb226-45"><a href="#cb226-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"   plot/key_variables_scatter.png</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb226-46"><a href="#cb226-46" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>   plot/key_variables_scatter.png</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb228"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb228-2"><a href="#cb228-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Save cleaned data</span></span>
<span id="cb228-3"><a href="#cb228-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb228-4"><a href="#cb228-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-5"><a href="#cb228-5" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(df, <span class="st">"file/opa_sales_step2_clean.csv"</span>)</span>
<span id="cb228-6"><a href="#cb228-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-7"><a href="#cb228-7" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb228-8"><a href="#cb228-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary</span></span>
<span id="cb228-9"><a href="#cb228-9" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb228-10"><a href="#cb228-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-11"><a href="#cb228-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb230"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Step 2 Completed</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Step 2 Completed</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb232"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb234"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Output files:</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Output files:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb236"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Tables:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Tables:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb238"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • file/vif_values.csv - VIF analysis results</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • file/vif_values.csv - VIF analysis results</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb240"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • file/opa_sales_step2_clean.csv - Cleaned dataset</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • file/opa_sales_step2_clean.csv - Cleaned dataset</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb242"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Figures:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Figures:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb244"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • plot/corr_matrix_enhanced.png - Correlation matrix</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • plot/corr_matrix_enhanced.png - Correlation matrix</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb246"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • plot/vif_analysis.png - VIF analysis</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • plot/vif_analysis.png - VIF analysis</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb248"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"x_coord"</span>, <span class="st">"y_coord"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(df))) {</span>
<span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  • plot/spatial_price_distribution.png - Spatial distribution of sale prices</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb248-3"><a href="#cb248-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  • plot/spatial_density_hexbin.png - Housing density heatmap</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb248-4"><a href="#cb248-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • plot/spatial_price_distribution.png - Spatial distribution of sale prices
  • plot/spatial_density_hexbin.png - Housing density heatmap</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb250"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(key_numeric) <span class="sc">&gt;=</span> <span class="dv">4</span>) {</span>
<span id="cb250-2"><a href="#cb250-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  • plot/key_variables_scatter.png - Key variables vs. sale price (scatterplots)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb250-3"><a href="#cb250-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • plot/key_variables_scatter.png - Key variables vs. sale price (scatterplots)</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb252"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Step3</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb253"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: VIF-based Filtering + LASSO Feature Selection (Streamlined)</span></span>
<span id="cb253-3"><a href="#cb253-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb253-4"><a href="#cb253-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-5"><a href="#cb253-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span>
<span id="cb253-6"><a href="#cb253-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb253-7"><a href="#cb253-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb253-8"><a href="#cb253-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb253-9"><a href="#cb253-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-10"><a href="#cb253-10" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2025</span>)</span>
<span id="cb253-11"><a href="#cb253-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-12"><a href="#cb253-12" aria-hidden="true" tabindex="-1"></a><span class="co"># === Read data and VIF results ===</span></span>
<span id="cb253-13"><a href="#cb253-13" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"file/opa_sales_step2_clean.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb253-14"><a href="#cb253-14" aria-hidden="true" tabindex="-1"></a>vif_path <span class="ot">&lt;-</span> <span class="st">"file/vif_values.csv"</span></span>
<span id="cb253-15"><a href="#cb253-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(vif_path)) <span class="fu">stop</span>(<span class="st">"  file/vif_values.csv not found. Please run step2.R first."</span>)</span>
<span id="cb253-16"><a href="#cb253-16" aria-hidden="true" tabindex="-1"></a>vif_table <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(vif_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb253-17"><a href="#cb253-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-18"><a href="#cb253-18" aria-hidden="true" tabindex="-1"></a><span class="co"># === Determine target variable ===</span></span>
<span id="cb253-19"><a href="#cb253-19" aria-hidden="true" tabindex="-1"></a>y_var <span class="ot">&lt;-</span> <span class="fu">case_when</span>(</span>
<span id="cb253-20"><a href="#cb253-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sale_price_log"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df) <span class="sc">~</span> <span class="st">"sale_price_log"</span>,</span>
<span id="cb253-21"><a href="#cb253-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"log_sale_price"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df) <span class="sc">~</span> <span class="st">"log_sale_price"</span>,</span>
<span id="cb253-22"><a href="#cb253-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sale_price"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df) <span class="sc">~</span> <span class="st">"sale_price"</span>,</span>
<span id="cb253-23"><a href="#cb253-23" aria-hidden="true" tabindex="-1"></a>  <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb253-24"><a href="#cb253-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb253-25"><a href="#cb253-25" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.na</span>(y_var)) <span class="fu">stop</span>(<span class="st">"  Target variable sale_price_log or sale_price not found"</span>)</span>
<span id="cb253-26"><a href="#cb253-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-27"><a href="#cb253-27" aria-hidden="true" tabindex="-1"></a><span class="co"># === Variable filtering (VIF) ===</span></span>
<span id="cb253-28"><a href="#cb253-28" aria-hidden="true" tabindex="-1"></a>vif_threshold <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb253-29"><a href="#cb253-29" aria-hidden="true" tabindex="-1"></a>vars_keep <span class="ot">&lt;-</span> vif_table <span class="sc">%&gt;%</span></span>
<span id="cb253-30"><a href="#cb253-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(VIF <span class="sc">&lt;=</span> vif_threshold) <span class="sc">%&gt;%</span></span>
<span id="cb253-31"><a href="#cb253-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(variable)</span>
<span id="cb253-32"><a href="#cb253-32" aria-hidden="true" tabindex="-1"></a>vars_keep <span class="ot">&lt;-</span> <span class="fu">intersect</span>(vars_keep, <span class="fu">names</span>(df))</span>
<span id="cb253-33"><a href="#cb253-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-34"><a href="#cb253-34" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Number of variables passing VIF ≤"</span>, vif_threshold, <span class="st">":"</span>, <span class="fu">length</span>(vars_keep), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Number of variables passing VIF ≤ 5 : 13 </code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb255"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === Prepare data matrix ===</span></span>
<span id="cb255-2"><a href="#cb255-2" aria-hidden="true" tabindex="-1"></a>df_lasso <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb255-3"><a href="#cb255-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(y_var, vars_keep))) <span class="sc">%&gt;%</span></span>
<span id="cb255-4"><a href="#cb255-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>()</span>
<span id="cb255-5"><a href="#cb255-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-6"><a href="#cb255-6" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(df_lasso <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">all_of</span>(y_var)))</span>
<span id="cb255-7"><a href="#cb255-7" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> df_lasso[[y_var]]</span>
<span id="cb255-8"><a href="#cb255-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-9"><a href="#cb255-9" aria-hidden="true" tabindex="-1"></a><span class="co"># === Run LASSO regression ===</span></span>
<span id="cb255-10"><a href="#cb255-10" aria-hidden="true" tabindex="-1"></a>cvfit <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(</span>
<span id="cb255-11"><a href="#cb255-11" aria-hidden="true" tabindex="-1"></a>  x, y,</span>
<span id="cb255-12"><a href="#cb255-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">alpha =</span> <span class="dv">1</span>,            <span class="co"># LASSO</span></span>
<span id="cb255-13"><a href="#cb255-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">nfolds =</span> <span class="dv">10</span>,</span>
<span id="cb255-14"><a href="#cb255-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">standardize =</span> <span class="cn">TRUE</span></span>
<span id="cb255-15"><a href="#cb255-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb255-16"><a href="#cb255-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-17"><a href="#cb255-17" aria-hidden="true" tabindex="-1"></a>lambda_min <span class="ot">&lt;-</span> cvfit<span class="sc">$</span>lambda.min</span>
<span id="cb255-18"><a href="#cb255-18" aria-hidden="true" tabindex="-1"></a>lambda_1se <span class="ot">&lt;-</span> cvfit<span class="sc">$</span>lambda<span class="fl">.1</span>se</span>
<span id="cb255-19"><a href="#cb255-19" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"λ_min ="</span>, <span class="fu">signif</span>(lambda_min, <span class="dv">5</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>λ_min = 0.00085507 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb257"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"λ_1se ="</span>, <span class="fu">signif</span>(lambda_1se, <span class="dv">5</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>λ_1se = 0.026727 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb259"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === Extract non-zero coefficients ===</span></span>
<span id="cb259-2"><a href="#cb259-2" aria-hidden="true" tabindex="-1"></a>coef_min <span class="ot">&lt;-</span> <span class="fu">coef</span>(cvfit, <span class="at">s =</span> <span class="st">"lambda.min"</span>)</span>
<span id="cb259-3"><a href="#cb259-3" aria-hidden="true" tabindex="-1"></a>selected <span class="ot">&lt;-</span> <span class="fu">rownames</span>(coef_min)[coef_min[, <span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>]</span>
<span id="cb259-4"><a href="#cb259-4" aria-hidden="true" tabindex="-1"></a>selected <span class="ot">&lt;-</span> selected[selected <span class="sc">!=</span> <span class="st">"(Intercept)"</span>]</span>
<span id="cb259-5"><a href="#cb259-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-6"><a href="#cb259-6" aria-hidden="true" tabindex="-1"></a>selected_tbl <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb259-7"><a href="#cb259-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable =</span> selected,</span>
<span id="cb259-8"><a href="#cb259-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">coefficient =</span> <span class="fu">as.numeric</span>(coef_min[selected, <span class="dv">1</span>])</span>
<span id="cb259-9"><a href="#cb259-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb259-10"><a href="#cb259-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-11"><a href="#cb259-11" aria-hidden="true" tabindex="-1"></a><span class="co"># === Remove variables with near-zero coefficients ===</span></span>
<span id="cb259-12"><a href="#cb259-12" aria-hidden="true" tabindex="-1"></a>selected_tbl <span class="ot">&lt;-</span> selected_tbl <span class="sc">%&gt;%</span></span>
<span id="cb259-13"><a href="#cb259-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">abs</span>(coefficient) <span class="sc">&gt;=</span> <span class="fl">1e-5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb259-14"><a href="#cb259-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(coefficient)))</span>
<span id="cb259-15"><a href="#cb259-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-16"><a href="#cb259-16" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Number of variables retained after LASSO:"</span>, <span class="fu">nrow</span>(selected_tbl), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Number of variables retained after LASSO: 12 </code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb261"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === Output files ===</span></span>
<span id="cb261-2"><a href="#cb261-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"file"</span>)) <span class="fu">dir.create</span>(<span class="st">"file"</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb261-3"><a href="#cb261-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"plot"</span>)) <span class="fu">dir.create</span>(<span class="st">"plot"</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb261-4"><a href="#cb261-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-5"><a href="#cb261-5" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(selected_tbl, <span class="st">"file/lasso_selected_variables.csv"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb262"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === Visualization 1: LASSO Coefficient Importance (Top 20) ===</span></span>
<span id="cb262-2"><a href="#cb262-2" aria-hidden="true" tabindex="-1"></a>top_n_vars <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="dv">20</span>, <span class="fu">nrow</span>(selected_tbl))</span>
<span id="cb262-3"><a href="#cb262-3" aria-hidden="true" tabindex="-1"></a>selected_top <span class="ot">&lt;-</span> selected_tbl <span class="sc">%&gt;%</span> </span>
<span id="cb262-4"><a href="#cb262-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">top_n</span>(top_n_vars, <span class="fu">abs</span>(coefficient)) <span class="sc">%&gt;%</span></span>
<span id="cb262-5"><a href="#cb262-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(coefficient)</span>
<span id="cb262-6"><a href="#cb262-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-7"><a href="#cb262-7" aria-hidden="true" tabindex="-1"></a>p_coef <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(selected_top, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(variable, coefficient), <span class="at">y =</span> coefficient, <span class="at">fill =</span> coefficient)) <span class="sc">+</span></span>
<span id="cb262-8"><a href="#cb262-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">alpha =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb262-9"><a href="#cb262-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(</span>
<span id="cb262-10"><a href="#cb262-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">low =</span> <span class="st">"#053061"</span>,      </span>
<span id="cb262-11"><a href="#cb262-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">mid =</span> <span class="st">"#F7F7F7"</span>,      </span>
<span id="cb262-12"><a href="#cb262-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">high =</span> <span class="st">"#67001F"</span>,     </span>
<span id="cb262-13"><a href="#cb262-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">midpoint =</span> <span class="dv">0</span>,</span>
<span id="cb262-14"><a href="#cb262-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Coefficient"</span></span>
<span id="cb262-15"><a href="#cb262-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb262-16"><a href="#cb262-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"solid"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>, <span class="at">linewidth =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb262-17"><a href="#cb262-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb262-18"><a href="#cb262-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb262-19"><a href="#cb262-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb262-20"><a href="#cb262-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb262-21"><a href="#cb262-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"#E5E5E5"</span>, <span class="at">linewidth =</span> <span class="fl">0.5</span>),</span>
<span id="cb262-22"><a href="#cb262-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb262-23"><a href="#cb262-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">"gray40"</span>),</span>
<span id="cb262-24"><a href="#cb262-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb262-25"><a href="#cb262-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb262-26"><a href="#cb262-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb262-27"><a href="#cb262-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb262-28"><a href="#cb262-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb262-29"><a href="#cb262-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"LASSO Selected Variables - Coefficient Importance"</span>,</span>
<span id="cb262-30"><a href="#cb262-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"Top "</span>, top_n_vars, <span class="st">" variables by absolute coefficient value"</span>),</span>
<span id="cb262-31"><a href="#cb262-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Variable"</span>,</span>
<span id="cb262-32"><a href="#cb262-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Coefficient"</span>,</span>
<span id="cb262-33"><a href="#cb262-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="fu">paste0</span>(<span class="st">"λ_min = "</span>, <span class="fu">signif</span>(lambda_min, <span class="dv">4</span>), <span class="st">" | Total selected: "</span>, <span class="fu">nrow</span>(selected_tbl), <span class="st">" variables"</span>)</span>
<span id="cb262-34"><a href="#cb262-34" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb262-35"><a href="#cb262-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-36"><a href="#cb262-36" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"plot/lasso_coefficients.png"</span>, p_coef, <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb263"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === Visualization 2: Cross-Validation Curve (λ Selection) ===</span></span>
<span id="cb263-2"><a href="#cb263-2" aria-hidden="true" tabindex="-1"></a>cv_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb263-3"><a href="#cb263-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">lambda =</span> cvfit<span class="sc">$</span>lambda,</span>
<span id="cb263-4"><a href="#cb263-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">cvm =</span> cvfit<span class="sc">$</span>cvm,</span>
<span id="cb263-5"><a href="#cb263-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">cvsd =</span> cvfit<span class="sc">$</span>cvsd,</span>
<span id="cb263-6"><a href="#cb263-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">cvlo =</span> cvfit<span class="sc">$</span>cvm <span class="sc">-</span> cvfit<span class="sc">$</span>cvsd,</span>
<span id="cb263-7"><a href="#cb263-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">cvup =</span> cvfit<span class="sc">$</span>cvm <span class="sc">+</span> cvfit<span class="sc">$</span>cvsd</span>
<span id="cb263-8"><a href="#cb263-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb263-9"><a href="#cb263-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-10"><a href="#cb263-10" aria-hidden="true" tabindex="-1"></a>p_cv <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(cv_df, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(lambda), <span class="at">y =</span> cvm)) <span class="sc">+</span></span>
<span id="cb263-11"><a href="#cb263-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> cvlo, <span class="at">ymax =</span> cvup), <span class="at">fill =</span> <span class="st">"#4393C3"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb263-12"><a href="#cb263-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"#053061"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb263-13"><a href="#cb263-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"#053061"</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb263-14"><a href="#cb263-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">log</span>(lambda_min), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"#67001F"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb263-15"><a href="#cb263-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">log</span>(lambda_1se), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"#D73027"</span>, <span class="at">linewidth =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb263-16"><a href="#cb263-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">log</span>(lambda_min), <span class="at">y =</span> <span class="fu">max</span>(cv_df<span class="sc">$</span>cvm) <span class="sc">*</span> <span class="fl">0.95</span>, </span>
<span id="cb263-17"><a href="#cb263-17" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"λ_min = "</span>, <span class="fu">signif</span>(lambda_min, <span class="dv">3</span>)), </span>
<span id="cb263-18"><a href="#cb263-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.1</span>, <span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">color =</span> <span class="st">"#67001F"</span>) <span class="sc">+</span></span>
<span id="cb263-19"><a href="#cb263-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">log</span>(lambda_1se), <span class="at">y =</span> <span class="fu">max</span>(cv_df<span class="sc">$</span>cvm) <span class="sc">*</span> <span class="fl">0.90</span>, </span>
<span id="cb263-20"><a href="#cb263-20" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"λ_1se = "</span>, <span class="fu">signif</span>(lambda_1se, <span class="dv">3</span>)), </span>
<span id="cb263-21"><a href="#cb263-21" aria-hidden="true" tabindex="-1"></a>           <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.1</span>, <span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">color =</span> <span class="st">"#D73027"</span>) <span class="sc">+</span></span>
<span id="cb263-22"><a href="#cb263-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb263-23"><a href="#cb263-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb263-24"><a href="#cb263-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb263-25"><a href="#cb263-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"#E5E5E5"</span>, <span class="at">linewidth =</span> <span class="fl">0.5</span>),</span>
<span id="cb263-26"><a href="#cb263-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb263-27"><a href="#cb263-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">"gray40"</span>),</span>
<span id="cb263-28"><a href="#cb263-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb263-29"><a href="#cb263-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb263-30"><a href="#cb263-30" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb263-31"><a href="#cb263-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb263-32"><a href="#cb263-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"LASSO Cross-Validation Curve"</span>,</span>
<span id="cb263-33"><a href="#cb263-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Mean Squared Error vs. log(λ)"</span>,</span>
<span id="cb263-34"><a href="#cb263-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"log(λ)"</span>,</span>
<span id="cb263-35"><a href="#cb263-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Mean Squared Error"</span>,</span>
<span id="cb263-36"><a href="#cb263-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Shaded area represents ±1 standard error"</span></span>
<span id="cb263-37"><a href="#cb263-37" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb263-38"><a href="#cb263-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-39"><a href="#cb263-39" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"plot/lasso_cv_curve.png"</span>, p_cv, <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">7</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb264"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === Selection Summary ===</span></span>
<span id="cb264-2"><a href="#cb264-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">60</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
============================================================</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb266"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb266-1"><a href="#cb266-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">" Summary of Feature Selection Results</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> Summary of Feature Selection Results</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb268"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb268-1"><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">60</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb270"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Initial number of predictors:"</span>, <span class="fu">ncol</span>(x), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Initial number of predictors: 13 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb272"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"After VIF ≤"</span>, vif_threshold, <span class="st">":"</span>, <span class="fu">length</span>(vars_keep), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>After VIF ≤ 5 : 13 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb274"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb274-1"><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Retained after LASSO:"</span>, <span class="fu">nrow</span>(selected_tbl), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Retained after LASSO: 12 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb276"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb276-1"><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Selection rate:"</span>, <span class="fu">round</span>((<span class="dv">1</span> <span class="sc">-</span> <span class="fu">nrow</span>(selected_tbl) <span class="sc">/</span> <span class="fu">ncol</span>(x)) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Selection rate: 7.7 %</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb278"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">60</span>), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb280"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">" Step 3 Completed</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> Step 3 Completed</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb282"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">" LASSO results: file/lasso_selected_variables.csv</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> LASSO results: file/lasso_selected_variables.csv</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb284"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">" Coefficient importance: plot/lasso_coeff_importance_top20.png</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> Coefficient importance: plot/lasso_coeff_importance_top20.png</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb286"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb286-1"><a href="#cb286-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">" CV curve: plot/lasso_cv_curve.png</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> CV curve: plot/lasso_cv_curve.png</code></pre>
</div>
</div>
<p>Step4</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb288"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb288-1"><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb288-2"><a href="#cb288-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4 Enhanced: Four Progressive Models + Coefficient Tables + Feature Importance</span></span>
<span id="cb288-3"><a href="#cb288-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb288-4"><a href="#cb288-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-5"><a href="#cb288-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb288-6"><a href="#cb288-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb288-7"><a href="#cb288-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb288-8"><a href="#cb288-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb288-9"><a href="#cb288-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb288-10"><a href="#cb288-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb288-11"><a href="#cb288-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sandwich)</span>
<span id="cb288-12"><a href="#cb288-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtest)</span>
<span id="cb288-13"><a href="#cb288-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)</span>
<span id="cb288-14"><a href="#cb288-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-15"><a href="#cb288-15" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2025</span>)</span>
<span id="cb288-16"><a href="#cb288-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-17"><a href="#cb288-17" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb290"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb290-1"><a href="#cb290-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Step 4: OLS Progressive Modeling and Full Analysis</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Step 4: OLS Progressive Modeling and Full Analysis</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb292"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb292-1"><a href="#cb292-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = </code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb294"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb294-1"><a href="#cb294-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === Read Data ===</span></span>
<span id="cb294-2"><a href="#cb294-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"file/opa_sales_step2_clean.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb294-3"><a href="#cb294-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-4"><a href="#cb294-4" aria-hidden="true" tabindex="-1"></a>y_var <span class="ot">&lt;-</span> <span class="fu">case_when</span>(</span>
<span id="cb294-5"><a href="#cb294-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sale_price_log"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df) <span class="sc">~</span> <span class="st">"sale_price_log"</span>,</span>
<span id="cb294-6"><a href="#cb294-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"log_sale_price"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df) <span class="sc">~</span> <span class="st">"log_sale_price"</span>,</span>
<span id="cb294-7"><a href="#cb294-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sale_price"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df) <span class="sc">~</span> <span class="st">"sale_price"</span>,</span>
<span id="cb294-8"><a href="#cb294-8" aria-hidden="true" tabindex="-1"></a>  <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb294-9"><a href="#cb294-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb294-10"><a href="#cb294-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.na</span>(y_var)) <span class="fu">stop</span>(<span class="st">" Target variable not found"</span>)</span>
<span id="cb294-11"><a href="#cb294-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-12"><a href="#cb294-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Target variable: %s</span><span class="sc">\n</span><span class="st">"</span>, y_var))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Target variable: sale_price</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb296"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb296-1"><a href="#cb296-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Sample size: %d</span><span class="sc">\n\n</span><span class="st">"</span>, <span class="fu">nrow</span>(df)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sample size: 24023</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb298"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb298-1"><a href="#cb298-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === Data preprocessing ===</span></span>
<span id="cb298-2"><a href="#cb298-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Data preprocessing ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== Data preprocessing ===</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb300"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb300-1"><a href="#cb300-1" aria-hidden="true" tabindex="-1"></a>cat_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"interior_condition"</span>, <span class="st">"exterior_condition"</span>, <span class="st">"zip_code"</span>, <span class="st">"census_tract"</span>)</span>
<span id="cb300-2"><a href="#cb300-2" aria-hidden="true" tabindex="-1"></a>cat_vars <span class="ot">&lt;-</span> <span class="fu">intersect</span>(cat_vars, <span class="fu">names</span>(df))</span>
<span id="cb300-3"><a href="#cb300-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb300-4"><a href="#cb300-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (cat_var <span class="cf">in</span> cat_vars) {</span>
<span id="cb300-5"><a href="#cb300-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (cat_var <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"zip_code"</span>, <span class="st">"census_tract"</span>)) {</span>
<span id="cb300-6"><a href="#cb300-6" aria-hidden="true" tabindex="-1"></a>    freq_table <span class="ot">&lt;-</span> <span class="fu">table</span>(df[[cat_var]])</span>
<span id="cb300-7"><a href="#cb300-7" aria-hidden="true" tabindex="-1"></a>    sparse_levels <span class="ot">&lt;-</span> <span class="fu">names</span>(freq_table[freq_table <span class="sc">&lt;</span> <span class="dv">100</span>])</span>
<span id="cb300-8"><a href="#cb300-8" aria-hidden="true" tabindex="-1"></a>    df[[cat_var]] <span class="ot">&lt;-</span> <span class="fu">as.character</span>(df[[cat_var]])</span>
<span id="cb300-9"><a href="#cb300-9" aria-hidden="true" tabindex="-1"></a>    df[[cat_var]][df[[cat_var]] <span class="sc">%in%</span> sparse_levels] <span class="ot">&lt;-</span> <span class="st">"Other"</span></span>
<span id="cb300-10"><a href="#cb300-10" aria-hidden="true" tabindex="-1"></a>    df[[cat_var]] <span class="ot">&lt;-</span> <span class="fu">factor</span>(df[[cat_var]])</span>
<span id="cb300-11"><a href="#cb300-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  %s: %d → %d categories</span><span class="sc">\n</span><span class="st">"</span>, cat_var, <span class="fu">length</span>(freq_table), <span class="fu">length</span>(<span class="fu">levels</span>(df[[cat_var]]))))</span>
<span id="cb300-12"><a href="#cb300-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb300-13"><a href="#cb300-13" aria-hidden="true" tabindex="-1"></a>    df[[cat_var]] <span class="ot">&lt;-</span> <span class="fu">factor</span>(df[[cat_var]])</span>
<span id="cb300-14"><a href="#cb300-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb300-15"><a href="#cb300-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  zip_code: 46 → 46 categories
  census_tract: 310 → 86 categories</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb302"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb302-1"><a href="#cb302-1" aria-hidden="true" tabindex="-1"></a>coord_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"x_coord"</span>, <span class="st">"y_coord"</span>)</span>
<span id="cb302-2"><a href="#cb302-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">all</span>(coord_vars <span class="sc">%in%</span> <span class="fu">names</span>(df))) {</span>
<span id="cb302-3"><a href="#cb302-3" aria-hidden="true" tabindex="-1"></a>  center_x <span class="ot">&lt;-</span> <span class="fu">median</span>(df<span class="sc">$</span>x_coord, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb302-4"><a href="#cb302-4" aria-hidden="true" tabindex="-1"></a>  center_y <span class="ot">&lt;-</span> <span class="fu">median</span>(df<span class="sc">$</span>y_coord, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb302-5"><a href="#cb302-5" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>dist_to_center <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((df<span class="sc">$</span>x_coord <span class="sc">-</span> center_x)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (df<span class="sc">$</span>y_coord <span class="sc">-</span> center_y)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb302-6"><a href="#cb302-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  Added: dist_to_center</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb302-7"><a href="#cb302-7" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb302-8"><a href="#cb302-8" aria-hidden="true" tabindex="-1"></a>  coord_vars <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb302-9"><a href="#cb302-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Added: dist_to_center</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb304"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb304-1"><a href="#cb304-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify variable groups</span></span>
<span id="cb304-2"><a href="#cb304-2" aria-hidden="true" tabindex="-1"></a>structural_vars <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb304-3"><a href="#cb304-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (pattern <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"livable_area"</span>, <span class="st">"bedroom"</span>, <span class="st">"bathroom"</span>, <span class="st">"stories"</span>, <span class="st">"garage"</span>, <span class="st">"age"</span>)) {</span>
<span id="cb304-4"><a href="#cb304-4" aria-hidden="true" tabindex="-1"></a>  matched <span class="ot">&lt;-</span> <span class="fu">grep</span>(pattern, <span class="fu">names</span>(df), <span class="at">value =</span> <span class="cn">TRUE</span>, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)</span>
<span id="cb304-5"><a href="#cb304-5" aria-hidden="true" tabindex="-1"></a>  structural_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(structural_vars, matched)</span>
<span id="cb304-6"><a href="#cb304-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb304-7"><a href="#cb304-7" aria-hidden="true" tabindex="-1"></a>structural_vars <span class="ot">&lt;-</span> <span class="fu">unique</span>(structural_vars)</span>
<span id="cb304-8"><a href="#cb304-8" aria-hidden="true" tabindex="-1"></a>structural_vars <span class="ot">&lt;-</span> structural_vars[<span class="fu">sapply</span>(df[structural_vars], is.numeric)]</span>
<span id="cb304-9"><a href="#cb304-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-10"><a href="#cb304-10" aria-hidden="true" tabindex="-1"></a>census_vars <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb304-11"><a href="#cb304-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (pattern <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"income"</span>, <span class="st">"poverty"</span>, <span class="st">"education"</span>, <span class="st">"bachelor"</span>, <span class="st">"population"</span>, <span class="st">"household"</span>)) {</span>
<span id="cb304-12"><a href="#cb304-12" aria-hidden="true" tabindex="-1"></a>  matched <span class="ot">&lt;-</span> <span class="fu">grep</span>(pattern, <span class="fu">names</span>(df), <span class="at">value =</span> <span class="cn">TRUE</span>, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)</span>
<span id="cb304-13"><a href="#cb304-13" aria-hidden="true" tabindex="-1"></a>  census_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(census_vars, matched)</span>
<span id="cb304-14"><a href="#cb304-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb304-15"><a href="#cb304-15" aria-hidden="true" tabindex="-1"></a>census_vars <span class="ot">&lt;-</span> <span class="fu">unique</span>(census_vars)</span>
<span id="cb304-16"><a href="#cb304-16" aria-hidden="true" tabindex="-1"></a>census_vars <span class="ot">&lt;-</span> census_vars[<span class="fu">sapply</span>(df[census_vars], is.numeric)]</span>
<span id="cb304-17"><a href="#cb304-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-18"><a href="#cb304-18" aria-hidden="true" tabindex="-1"></a>spatial_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(coord_vars, <span class="st">"dist_to_center"</span>)</span>
<span id="cb304-19"><a href="#cb304-19" aria-hidden="true" tabindex="-1"></a>spatial_vars <span class="ot">&lt;-</span> <span class="fu">intersect</span>(spatial_vars, <span class="fu">names</span>(df))</span>
<span id="cb304-20"><a href="#cb304-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-21"><a href="#cb304-21" aria-hidden="true" tabindex="-1"></a>fixed_effects <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"zip_code"</span>, <span class="st">"census_tract"</span>)</span>
<span id="cb304-22"><a href="#cb304-22" aria-hidden="true" tabindex="-1"></a>fixed_effects <span class="ot">&lt;-</span> <span class="fu">intersect</span>(fixed_effects, <span class="fu">names</span>(df))</span>
<span id="cb304-23"><a href="#cb304-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-24"><a href="#cb304-24" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">  Structural features: %d</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">length</span>(structural_vars)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  Structural features: 5</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb306"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb306-1"><a href="#cb306-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Census features: %d</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">length</span>(census_vars)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Census features: 3</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb308"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb308-1"><a href="#cb308-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Spatial features: %d</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">length</span>(spatial_vars)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Spatial features: 3</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb310"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb310-1"><a href="#cb310-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Fixed effects: %d</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">length</span>(fixed_effects)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Fixed effects: 2</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb312"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb312-1"><a href="#cb312-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb312-2"><a href="#cb312-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Build 4 Progressive Models</span></span>
<span id="cb312-3"><a href="#cb312-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb312-4"><a href="#cb312-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb312-5"><a href="#cb312-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb314"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb314-1"><a href="#cb314-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Building 4 Progressive Models ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== Building 4 Progressive Models ===</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb316"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb316-1"><a href="#cb316-1" aria-hidden="true" tabindex="-1"></a>make_formula <span class="ot">&lt;-</span> <span class="cf">function</span>(y, main_vars, <span class="at">interact_vars =</span> <span class="cn">NULL</span>, <span class="at">fe_vars =</span> <span class="cn">NULL</span>) {</span>
<span id="cb316-2"><a href="#cb316-2" aria-hidden="true" tabindex="-1"></a>  rhs <span class="ot">&lt;-</span> main_vars</span>
<span id="cb316-3"><a href="#cb316-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(interact_vars) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(interact_vars) <span class="sc">==</span> <span class="dv">2</span>) {</span>
<span id="cb316-4"><a href="#cb316-4" aria-hidden="true" tabindex="-1"></a>    rhs <span class="ot">&lt;-</span> <span class="fu">c</span>(rhs, <span class="fu">paste</span>(interact_vars, <span class="at">collapse =</span> <span class="st">":"</span>))</span>
<span id="cb316-5"><a href="#cb316-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb316-6"><a href="#cb316-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fe_vars)) {</span>
<span id="cb316-7"><a href="#cb316-7" aria-hidden="true" tabindex="-1"></a>    rhs <span class="ot">&lt;-</span> <span class="fu">c</span>(rhs, fe_vars)</span>
<span id="cb316-8"><a href="#cb316-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb316-9"><a href="#cb316-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.formula</span>(<span class="fu">paste</span>(y, <span class="st">"~"</span>, <span class="fu">paste</span>(rhs, <span class="at">collapse =</span> <span class="st">" + "</span>)))</span>
<span id="cb316-10"><a href="#cb316-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb316-11"><a href="#cb316-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb316-12"><a href="#cb316-12" aria-hidden="true" tabindex="-1"></a>f1 <span class="ot">&lt;-</span> <span class="fu">make_formula</span>(y_var, structural_vars)</span>
<span id="cb316-13"><a href="#cb316-13" aria-hidden="true" tabindex="-1"></a>f2 <span class="ot">&lt;-</span> <span class="fu">make_formula</span>(y_var, <span class="fu">c</span>(structural_vars, census_vars))</span>
<span id="cb316-14"><a href="#cb316-14" aria-hidden="true" tabindex="-1"></a>f3 <span class="ot">&lt;-</span> <span class="fu">make_formula</span>(y_var, <span class="fu">c</span>(structural_vars, census_vars, spatial_vars))</span>
<span id="cb316-15"><a href="#cb316-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb316-16"><a href="#cb316-16" aria-hidden="true" tabindex="-1"></a>interact_pairs <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb316-17"><a href="#cb316-17" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="st">"total_livable_area"</span> <span class="sc">%in%</span> structural_vars <span class="sc">&amp;&amp;</span> <span class="st">"median_incomeE"</span> <span class="sc">%in%</span> census_vars) {</span>
<span id="cb316-18"><a href="#cb316-18" aria-hidden="true" tabindex="-1"></a>  interact_pairs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"total_livable_area"</span>, <span class="st">"median_incomeE"</span>)</span>
<span id="cb316-19"><a href="#cb316-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb316-20"><a href="#cb316-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb316-21"><a href="#cb316-21" aria-hidden="true" tabindex="-1"></a>f4 <span class="ot">&lt;-</span> <span class="fu">make_formula</span>(y_var, <span class="fu">c</span>(structural_vars, census_vars, spatial_vars),</span>
<span id="cb316-22"><a href="#cb316-22" aria-hidden="true" tabindex="-1"></a>                   <span class="at">interact_vars =</span> interact_pairs, <span class="at">fe_vars =</span> fixed_effects)</span>
<span id="cb316-23"><a href="#cb316-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb316-24"><a href="#cb316-24" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb316-25"><a href="#cb316-25" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Fitting Model 1..."</span>); models[[<span class="st">"M1: Structural"</span>]] <span class="ot">&lt;-</span> <span class="fu">lm</span>(f1, <span class="at">data =</span> df, <span class="at">na.action =</span> na.exclude); <span class="fu">cat</span>(<span class="st">" ✓</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Fitting Model 1...</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> ✓</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb319"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb319-1"><a href="#cb319-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Fitting Model 2..."</span>); models[[<span class="st">"M2: +Census"</span>]] <span class="ot">&lt;-</span> <span class="fu">lm</span>(f2, <span class="at">data =</span> df, <span class="at">na.action =</span> na.exclude); <span class="fu">cat</span>(<span class="st">" ✓</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Fitting Model 2...</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> ✓</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb322"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb322-1"><a href="#cb322-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Fitting Model 3..."</span>); models[[<span class="st">"M3: +Spatial"</span>]] <span class="ot">&lt;-</span> <span class="fu">lm</span>(f3, <span class="at">data =</span> df, <span class="at">na.action =</span> na.exclude); <span class="fu">cat</span>(<span class="st">" ✓</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Fitting Model 3...</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> ✓</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb325"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb325-1"><a href="#cb325-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Fitting Model 4..."</span>); models[[<span class="st">"M4: +Interact+FE"</span>]] <span class="ot">&lt;-</span> <span class="fu">lm</span>(f4, <span class="at">data =</span> df, <span class="at">na.action =</span> na.exclude); <span class="fu">cat</span>(<span class="st">" ✓</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Fitting Model 4...</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> ✓</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb328"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb328-1"><a href="#cb328-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb328-2"><a href="#cb328-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Model Performance Evaluation</span></span>
<span id="cb328-3"><a href="#cb328-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb328-4"><a href="#cb328-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb328-5"><a href="#cb328-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb330"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb330-1"><a href="#cb330-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Model Performance Evaluation ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== Model Performance Evaluation ===</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb332"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb332-1"><a href="#cb332-1" aria-hidden="true" tabindex="-1"></a>train_perf <span class="ot">&lt;-</span> <span class="fu">lapply</span>(models, <span class="cf">function</span>(m) {</span>
<span id="cb332-2"><a href="#cb332-2" aria-hidden="true" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> <span class="fu">fitted</span>(m)</span>
<span id="cb332-3"><a href="#cb332-3" aria-hidden="true" tabindex="-1"></a>  actual <span class="ot">&lt;-</span> df[[y_var]][<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">fitted</span>(m))]</span>
<span id="cb332-4"><a href="#cb332-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb332-5"><a href="#cb332-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Log-scale metrics</span></span>
<span id="cb332-6"><a href="#cb332-6" aria-hidden="true" tabindex="-1"></a>  rmse_log <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((pred <span class="sc">-</span> actual)<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb332-7"><a href="#cb332-7" aria-hidden="true" tabindex="-1"></a>  mae_log <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">abs</span>(pred <span class="sc">-</span> actual), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb332-8"><a href="#cb332-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb332-9"><a href="#cb332-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Original-scale metrics — use expm1 to invert log1p</span></span>
<span id="cb332-10"><a href="#cb332-10" aria-hidden="true" tabindex="-1"></a>  pred_original <span class="ot">&lt;-</span> <span class="fu">expm1</span>(pred)</span>
<span id="cb332-11"><a href="#cb332-11" aria-hidden="true" tabindex="-1"></a>  actual_original <span class="ot">&lt;-</span> <span class="fu">expm1</span>(actual)</span>
<span id="cb332-12"><a href="#cb332-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb332-13"><a href="#cb332-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Method 3: remove outliers based on residuals (|residual| &gt; 3 standard deviations)</span></span>
<span id="cb332-14"><a href="#cb332-14" aria-hidden="true" tabindex="-1"></a>  residuals_original <span class="ot">&lt;-</span> pred_original <span class="sc">-</span> actual_original</span>
<span id="cb332-15"><a href="#cb332-15" aria-hidden="true" tabindex="-1"></a>  res_sd <span class="ot">&lt;-</span> <span class="fu">sd</span>(residuals_original, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb332-16"><a href="#cb332-16" aria-hidden="true" tabindex="-1"></a>  valid_idx <span class="ot">&lt;-</span> <span class="fu">abs</span>(residuals_original) <span class="sc">&lt;=</span> <span class="dv">3</span> <span class="sc">*</span> res_sd</span>
<span id="cb332-17"><a href="#cb332-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb332-18"><a href="#cb332-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute RMSE and MAE after removing outliers</span></span>
<span id="cb332-19"><a href="#cb332-19" aria-hidden="true" tabindex="-1"></a>  rmse_original <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((pred_original[valid_idx] <span class="sc">-</span> actual_original[valid_idx])<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb332-20"><a href="#cb332-20" aria-hidden="true" tabindex="-1"></a>  mae_original <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">abs</span>(pred_original[valid_idx] <span class="sc">-</span> actual_original[valid_idx]), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb332-21"><a href="#cb332-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb332-22"><a href="#cb332-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb332-23"><a href="#cb332-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">RMSE_log =</span> rmse_log,</span>
<span id="cb332-24"><a href="#cb332-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">RMSE_original =</span> rmse_original,</span>
<span id="cb332-25"><a href="#cb332-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAE_log =</span> mae_log,</span>
<span id="cb332-26"><a href="#cb332-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAE_original =</span> mae_original,</span>
<span id="cb332-27"><a href="#cb332-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">R2 =</span> <span class="fu">summary</span>(m)<span class="sc">$</span>r.squared,</span>
<span id="cb332-28"><a href="#cb332-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">Adj_R2 =</span> <span class="fu">summary</span>(m)<span class="sc">$</span>adj.r.squared,</span>
<span id="cb332-29"><a href="#cb332-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">N_vars =</span> <span class="fu">length</span>(<span class="fu">coef</span>(m)) <span class="sc">-</span> <span class="dv">1</span>,</span>
<span id="cb332-30"><a href="#cb332-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">N =</span> <span class="fu">length</span>(pred),</span>
<span id="cb332-31"><a href="#cb332-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">N_valid =</span> <span class="fu">sum</span>(valid_idx, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),      <span class="co"># retained sample count</span></span>
<span id="cb332-32"><a href="#cb332-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">Pct_valid =</span> <span class="fu">mean</span>(valid_idx, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span>  <span class="co"># percentage of retained samples</span></span>
<span id="cb332-33"><a href="#cb332-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb332-34"><a href="#cb332-34" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"Model"</span>)</span>
<span id="cb332-35"><a href="#cb332-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb332-36"><a href="#cb332-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Print removal stats</span></span>
<span id="cb332-37"><a href="#cb332-37" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Outlier removal statistics (|residual| &gt; 3σ):</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Outlier removal statistics (|residual| &gt; 3σ):</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb334"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb334-1"><a href="#cb334-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(train_perf <span class="sc">%&gt;%</span> <span class="fu">select</span>(Model, N, N_valid, Pct_valid, RMSE_original, MAE_original))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>             Model     N N_valid Pct_valid RMSE_original MAE_original
1   M1: Structural 24023   23693  98.62632      172980.9    113702.55
2      M2: +Census 24023   23713  98.70957      137239.1     84251.14
3     M3: +Spatial 24023   23714  98.71373      135990.7     82773.39
4 M4: +Interact+FE 24023   23726  98.76368      121478.7     73179.58</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb336"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb336-1"><a href="#cb336-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Performing 10-fold cross-validation...</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Performing 10-fold cross-validation...</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb338"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb338-1"><a href="#cb338-1" aria-hidden="true" tabindex="-1"></a>cv_ctrl <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">"cv"</span>, <span class="at">number =</span> <span class="dv">10</span>, <span class="at">verboseIter =</span> <span class="cn">FALSE</span>)</span>
<span id="cb338-2"><a href="#cb338-2" aria-hidden="true" tabindex="-1"></a>formulas <span class="ot">&lt;-</span> <span class="fu">list</span>(f1, f2, f3, f4)</span>
<span id="cb338-3"><a href="#cb338-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(formulas) <span class="ot">&lt;-</span> <span class="fu">names</span>(models)</span>
<span id="cb338-4"><a href="#cb338-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-5"><a href="#cb338-5" aria-hidden="true" tabindex="-1"></a>cv_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(formulas, <span class="cf">function</span>(fm) {</span>
<span id="cb338-6"><a href="#cb338-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>(<span class="fu">train</span>(fm, <span class="at">data =</span> df, <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">trControl =</span> cv_ctrl, <span class="at">na.action =</span> na.omit),</span>
<span id="cb338-7"><a href="#cb338-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb338-8"><a href="#cb338-8" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb338-9"><a href="#cb338-9" aria-hidden="true" tabindex="-1"></a>cv_results <span class="ot">&lt;-</span> <span class="fu">Filter</span>(<span class="fu">Negate</span>(is.null), cv_results)</span>
<span id="cb338-10"><a href="#cb338-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-11"><a href="#cb338-11" aria-hidden="true" tabindex="-1"></a>cv_perf <span class="ot">&lt;-</span> <span class="fu">lapply</span>(cv_results, <span class="cf">function</span>(m) {</span>
<span id="cb338-12"><a href="#cb338-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">CV_RMSE_log =</span> m<span class="sc">$</span>results<span class="sc">$</span>RMSE[<span class="dv">1</span>], <span class="at">CV_R2 =</span> m<span class="sc">$</span>results<span class="sc">$</span>Rsquared[<span class="dv">1</span>])</span>
<span id="cb338-13"><a href="#cb338-13" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">"Model"</span>)</span>
<span id="cb338-14"><a href="#cb338-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-15"><a href="#cb338-15" aria-hidden="true" tabindex="-1"></a>perf_table <span class="ot">&lt;-</span> train_perf <span class="sc">%&gt;%</span></span>
<span id="cb338-16"><a href="#cb338-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(cv_perf, <span class="at">by =</span> <span class="st">"Model"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb338-17"><a href="#cb338-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Overfit_RMSE_log =</span> CV_RMSE_log <span class="sc">-</span> RMSE_log, <span class="at">Overfit_R2 =</span> R2 <span class="sc">-</span> CV_R2)</span>
<span id="cb338-18"><a href="#cb338-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-19"><a href="#cb338-19" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb339"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb339-1"><a href="#cb339-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(perf_table, <span class="at">digits =</span> <span class="dv">4</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>            Model RMSE_log RMSE_original MAE_log MAE_original     R2 Adj_R2
   M1: Structural   0.6863        172981  0.4860       113703 0.3442 0.3441
      M2: +Census   0.5917        137239  0.3776        84251 0.5126 0.5124
     M3: +Spatial   0.5870        135991  0.3714        82773 0.5202 0.5200
 M4: +Interact+FE   0.5561        121479  0.3380        73180 0.5695 0.5669
 N_vars     N N_valid Pct_valid CV_RMSE_log  CV_R2 Overfit_RMSE_log Overfit_R2
      5 24023   23693     98.63      0.6862 0.3445       -7.634e-05 -0.0003115
      8 24023   23713     98.71      0.5916 0.5128       -8.878e-05 -0.0001838
     11 24023   23714     98.71      0.5869 0.5204       -1.000e-04 -0.0001902
    142 24023   23726     98.76      0.5593 0.5644        3.269e-03  0.0050628</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb341"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb341-1"><a href="#cb341-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb341-2"><a href="#cb341-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Heteroskedasticity Test</span></span>
<span id="cb341-3"><a href="#cb341-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb341-4"><a href="#cb341-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb341-5"><a href="#cb341-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb343"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb343-1"><a href="#cb343-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Heteroskedasticity Test (Model 4) ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== Heteroskedasticity Test (Model 4) ===</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb345"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb345-1"><a href="#cb345-1" aria-hidden="true" tabindex="-1"></a>bp_test <span class="ot">&lt;-</span> <span class="fu">bptest</span>(models[[<span class="st">"M4: +Interact+FE"</span>]])</span>
<span id="cb345-2"><a href="#cb345-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Breusch–Pagan Test:</span><span class="sc">\n</span><span class="st">  Statistic = %.2f</span><span class="sc">\n</span><span class="st">  p-value = %.4f</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb345-3"><a href="#cb345-3" aria-hidden="true" tabindex="-1"></a>            bp_test<span class="sc">$</span>statistic, bp_test<span class="sc">$</span>p.value))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Breusch–Pagan Test:
  Statistic = 2134.62
  p-value = 0.0000</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb347"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb347-1"><a href="#cb347-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (bp_test<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb347-2"><a href="#cb347-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">️ Significant heteroskedasticity detected (p &lt; 0.05)</span><span class="sc">\n</span><span class="st">   Recommendation: use robust standard errors</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb347-3"><a href="#cb347-3" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb347-4"><a href="#cb347-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st"> No significant heteroskedasticity detected</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb347-5"><a href="#cb347-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
️ Significant heteroskedasticity detected (p &lt; 0.05)
   Recommendation: use robust standard errors</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb349"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb349-1"><a href="#cb349-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb349-2"><a href="#cb349-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 4 Full Coefficient Table (Robust Standard Errors)</span></span>
<span id="cb349-3"><a href="#cb349-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb349-4"><a href="#cb349-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb349-5"><a href="#cb349-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb351"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb351-1"><a href="#cb351-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Model 4: Full Coefficient Table (Robust SE) ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== Model 4: Full Coefficient Table (Robust SE) ===</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb353"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb353-1"><a href="#cb353-1" aria-hidden="true" tabindex="-1"></a>model4 <span class="ot">&lt;-</span> models[[<span class="st">"M4: +Interact+FE"</span>]]</span>
<span id="cb353-2"><a href="#cb353-2" aria-hidden="true" tabindex="-1"></a>robust_coef <span class="ot">&lt;-</span> <span class="fu">coeftest</span>(model4, <span class="at">vcov =</span> <span class="fu">vcovHC</span>(model4, <span class="at">type =</span> <span class="st">"HC1"</span>))</span>
<span id="cb353-3"><a href="#cb353-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb353-4"><a href="#cb353-4" aria-hidden="true" tabindex="-1"></a>coef_table <span class="ot">&lt;-</span> <span class="fu">tidy</span>(robust_coef) <span class="sc">%&gt;%</span></span>
<span id="cb353-5"><a href="#cb353-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(term <span class="sc">!=</span> <span class="st">"(Intercept)"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb353-6"><a href="#cb353-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb353-7"><a href="#cb353-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">sig =</span> <span class="fu">case_when</span>(</span>
<span id="cb353-8"><a href="#cb353-8" aria-hidden="true" tabindex="-1"></a>      p.value <span class="sc">&lt;</span> <span class="fl">0.001</span> <span class="sc">~</span> <span class="st">"***"</span>,</span>
<span id="cb353-9"><a href="#cb353-9" aria-hidden="true" tabindex="-1"></a>      p.value <span class="sc">&lt;</span> <span class="fl">0.01</span> <span class="sc">~</span> <span class="st">"**"</span>,</span>
<span id="cb353-10"><a href="#cb353-10" aria-hidden="true" tabindex="-1"></a>      p.value <span class="sc">&lt;</span> <span class="fl">0.05</span> <span class="sc">~</span> <span class="st">"*"</span>,</span>
<span id="cb353-11"><a href="#cb353-11" aria-hidden="true" tabindex="-1"></a>      p.value <span class="sc">&lt;</span> <span class="fl">0.10</span> <span class="sc">~</span> <span class="st">"."</span>,</span>
<span id="cb353-12"><a href="#cb353-12" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">""</span></span>
<span id="cb353-13"><a href="#cb353-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb353-14"><a href="#cb353-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb353-15"><a href="#cb353-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(p.value) <span class="sc">%&gt;%</span></span>
<span id="cb353-16"><a href="#cb353-16" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(term, estimate, std.error, statistic, p.value, sig)</span>
<span id="cb353-17"><a href="#cb353-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb353-18"><a href="#cb353-18" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"file"</span>)) <span class="fu">dir.create</span>(<span class="st">"file"</span>)</span>
<span id="cb353-19"><a href="#cb353-19" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"table"</span>)) <span class="fu">dir.create</span>(<span class="st">"table"</span>)</span>
<span id="cb353-20"><a href="#cb353-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb353-21"><a href="#cb353-21" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(coef_table, <span class="st">"table/model4_full_coefficients.csv"</span>)</span>
<span id="cb353-22"><a href="#cb353-22" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  ✓ table/model4_full_coefficients.csv (All coefficients)</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ✓ table/model4_full_coefficients.csv (All coefficients)</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb355"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb355-1"><a href="#cb355-1" aria-hidden="true" tabindex="-1"></a>coef_sig <span class="ot">&lt;-</span> coef_table <span class="sc">%&gt;%</span> <span class="fu">filter</span>(p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>)</span>
<span id="cb355-2"><a href="#cb355-2" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(coef_sig, <span class="st">"table/model4_significant_coefficients.csv"</span>)</span>
<span id="cb355-3"><a href="#cb355-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  ✓ table/model4_significant_coefficients.csv (Significant coefficients)</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ✓ table/model4_significant_coefficients.csv (Significant coefficients)</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb357"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb357-1"><a href="#cb357-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Number of significant variables (p &lt; 0.05): %d</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">nrow</span>(coef_sig)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Number of significant variables (p &lt; 0.05): 74</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb359"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb359-1"><a href="#cb359-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Top 20 significant variables:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Top 20 significant variables:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb361"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb361-1"><a href="#cb361-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">as.data.frame</span>(<span class="fu">head</span>(coef_sig, <span class="dv">20</span>)), <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>                term    estimate   std.error  statistic       p.value sig
 number_of_bathrooms  0.57683321 0.015420414  37.407116 1.142354e-297 ***
     per_cap_incomeE  0.36773913 0.025683742  14.317973  2.628332e-46 ***
  total_livable_area  0.48199968 0.038119301  12.644505  1.571285e-36 ***
       zip_code19103  0.63540760 0.054794635  11.596165  5.218699e-31 ***
                age2 -0.04775122 0.004555385 -10.482367  1.183564e-25 ***
       census_tract7  0.87985167 0.088002818   9.997994  1.729730e-23 ***
      census_tract13  0.54303063 0.068221853   7.959775  1.799726e-15 ***
      census_tract14  0.54498041 0.068646953   7.938887  2.129287e-15 ***
      census_tract12  0.54252167 0.068824818   7.882646  3.341484e-15 ***
       zip_code19106  0.63471600 0.085682176   7.407795  1.326740e-13 ***
       zip_code19147  0.49363371 0.066777930   7.392169  1.492021e-13 ***
     census_tract180  0.72410180 0.099219613   7.297970  3.012660e-13 ***
       zip_code19130  0.49781714 0.072690260   6.848471  7.645435e-12 ***
       zip_code19107  0.49815251 0.073630825   6.765543  1.358805e-11 ***
       zip_code19148  0.44251467 0.073274428   6.039142  1.572250e-09 ***
      census_tract11  0.39171657 0.066613539   5.880435  4.146363e-09 ***
     census_tract379  0.54364745 0.102377266   5.310236  1.104621e-07 ***
     census_tract179  0.61289816 0.115555239   5.303941  1.143375e-07 ***
       zip_code19146  0.34323604 0.065585163   5.233440  1.677892e-07 ***
       zip_code19123  0.37828484 0.072407204   5.224409  1.761784e-07 ***</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb363"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb363-1"><a href="#cb363-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb363-2"><a href="#cb363-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Stargazer Regression Table</span></span>
<span id="cb363-3"><a href="#cb363-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb363-4"><a href="#cb363-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-5"><a href="#cb363-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb365"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb365-1"><a href="#cb365-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Generating Stargazer Regression Table ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== Generating Stargazer Regression Table ===</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb367"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb367-1"><a href="#cb367-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"stargazer"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb367-2"><a href="#cb367-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sink</span>(<span class="st">"table/regression_table.txt"</span>)</span>
<span id="cb367-3"><a href="#cb367-3" aria-hidden="true" tabindex="-1"></a>  stargazer<span class="sc">::</span><span class="fu">stargazer</span>(</span>
<span id="cb367-4"><a href="#cb367-4" aria-hidden="true" tabindex="-1"></a>    models[[<span class="dv">1</span>]], models[[<span class="dv">2</span>]], models[[<span class="dv">3</span>]], models[[<span class="dv">4</span>]],</span>
<span id="cb367-5"><a href="#cb367-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"text"</span>,</span>
<span id="cb367-6"><a href="#cb367-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Progressive OLS Regression Results"</span>,</span>
<span id="cb367-7"><a href="#cb367-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">dep.var.labels =</span> <span class="st">"Log Sale Price"</span>,</span>
<span id="cb367-8"><a href="#cb367-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">column.labels =</span> <span class="fu">c</span>(<span class="st">"Model 1"</span>, <span class="st">"Model 2"</span>, <span class="st">"Model 3"</span>, <span class="st">"Model 4"</span>),</span>
<span id="cb367-9"><a href="#cb367-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">omit.stat =</span> <span class="fu">c</span>(<span class="st">"ser"</span>, <span class="st">"f"</span>),</span>
<span id="cb367-10"><a href="#cb367-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">digits =</span> <span class="dv">3</span>,</span>
<span id="cb367-11"><a href="#cb367-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">star.cutoffs =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.01</span>, <span class="fl">0.001</span>),</span>
<span id="cb367-12"><a href="#cb367-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">notes =</span> <span class="st">"Robust standard errors in parentheses"</span></span>
<span id="cb367-13"><a href="#cb367-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb367-14"><a href="#cb367-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sink</span>()</span>
<span id="cb367-15"><a href="#cb367-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"   table/regression_table.txt</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb367-16"><a href="#cb367-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>   table/regression_table.txt</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb369"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb369-1"><a href="#cb369-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb369-2"><a href="#cb369-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross-Model Feature Importance</span></span>
<span id="cb369-3"><a href="#cb369-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb369-4"><a href="#cb369-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb369-5"><a href="#cb369-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb371"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb371-1"><a href="#cb371-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Cross-Model Feature Importance Comparison ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== Cross-Model Feature Importance Comparison ===</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb373"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb373-1"><a href="#cb373-1" aria-hidden="true" tabindex="-1"></a>importance_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb373-2"><a href="#cb373-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>) {</span>
<span id="cb373-3"><a href="#cb373-3" aria-hidden="true" tabindex="-1"></a>  model_name <span class="ot">&lt;-</span> <span class="fu">names</span>(models)[i]</span>
<span id="cb373-4"><a href="#cb373-4" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> models[[i]]</span>
<span id="cb373-5"><a href="#cb373-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb373-6"><a href="#cb373-6" aria-hidden="true" tabindex="-1"></a>  coefs <span class="ot">&lt;-</span> <span class="fu">tidy</span>(model) <span class="sc">%&gt;%</span></span>
<span id="cb373-7"><a href="#cb373-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(term <span class="sc">!=</span> <span class="st">"(Intercept)"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb373-8"><a href="#cb373-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">abs_estimate =</span> <span class="fu">abs</span>(estimate)) <span class="sc">%&gt;%</span></span>
<span id="cb373-9"><a href="#cb373-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(abs_estimate)) <span class="sc">%&gt;%</span></span>
<span id="cb373-10"><a href="#cb373-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb373-11"><a href="#cb373-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Model =</span> model_name) <span class="sc">%&gt;%</span></span>
<span id="cb373-12"><a href="#cb373-12" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(Model, term, estimate, abs_estimate)</span>
<span id="cb373-13"><a href="#cb373-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb373-14"><a href="#cb373-14" aria-hidden="true" tabindex="-1"></a>  importance_list[[i]] <span class="ot">&lt;-</span> coefs</span>
<span id="cb373-15"><a href="#cb373-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb373-16"><a href="#cb373-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb373-17"><a href="#cb373-17" aria-hidden="true" tabindex="-1"></a>importance_all <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(importance_list)</span>
<span id="cb373-18"><a href="#cb373-18" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(importance_all, <span class="st">"table/feature_importance_all_models.csv"</span>)</span>
<span id="cb373-19"><a href="#cb373-19" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  ✓ table/feature_importance_all_models.csv</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ✓ table/feature_importance_all_models.csv</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb375"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb375-1"><a href="#cb375-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify variables that are important across multiple models</span></span>
<span id="cb375-2"><a href="#cb375-2" aria-hidden="true" tabindex="-1"></a>top_vars <span class="ot">&lt;-</span> importance_all <span class="sc">%&gt;%</span></span>
<span id="cb375-3"><a href="#cb375-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(term) <span class="sc">%&gt;%</span></span>
<span id="cb375-4"><a href="#cb375-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">appearances =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb375-5"><a href="#cb375-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(appearances <span class="sc">&gt;=</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb375-6"><a href="#cb375-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(term)</span>
<span id="cb375-7"><a href="#cb375-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb375-8"><a href="#cb375-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(top_vars) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb375-9"><a href="#cb375-9" aria-hidden="true" tabindex="-1"></a>  importance_key <span class="ot">&lt;-</span> importance_all <span class="sc">%&gt;%</span> <span class="fu">filter</span>(term <span class="sc">%in%</span> top_vars)</span>
<span id="cb375-10"><a href="#cb375-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb375-11"><a href="#cb375-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"plot"</span>)) <span class="fu">dir.create</span>(<span class="st">"plot"</span>)</span>
<span id="cb375-12"><a href="#cb375-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb375-13"><a href="#cb375-13" aria-hidden="true" tabindex="-1"></a>  p_importance <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(importance_key, <span class="fu">aes</span>(Model, abs_estimate, <span class="at">fill =</span> Model)) <span class="sc">+</span></span>
<span id="cb375-14"><a href="#cb375-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_col</span>(<span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb375-15"><a href="#cb375-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>term, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb375-16"><a href="#cb375-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(</span>
<span id="cb375-17"><a href="#cb375-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#053061"</span>, <span class="st">"#2166AC"</span>, <span class="st">"#4393C3"</span>, <span class="st">"#D6604D"</span>),</span>
<span id="cb375-18"><a href="#cb375-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">guide =</span> <span class="st">"none"</span></span>
<span id="cb375-19"><a href="#cb375-19" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb375-20"><a href="#cb375-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">9</span>) <span class="sc">+</span></span>
<span id="cb375-21"><a href="#cb375-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb375-22"><a href="#cb375-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">7</span>),</span>
<span id="cb375-23"><a href="#cb375-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb375-24"><a href="#cb375-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb375-25"><a href="#cb375-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb375-26"><a href="#cb375-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb375-27"><a href="#cb375-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb375-28"><a href="#cb375-28" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb375-29"><a href="#cb375-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb375-30"><a href="#cb375-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Feature Importance Across Models"</span>,</span>
<span id="cb375-31"><a href="#cb375-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="st">"Variables appearing in top 10 of at least 3 models"</span>,</span>
<span id="cb375-32"><a href="#cb375-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Absolute Coefficient"</span></span>
<span id="cb375-33"><a href="#cb375-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb375-34"><a href="#cb375-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb375-35"><a href="#cb375-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="st">"plot/feature_importance_across_models.png"</span>, p_importance,</span>
<span id="cb375-36"><a href="#cb375-36" aria-hidden="true" tabindex="-1"></a>         <span class="at">width =</span> <span class="dv">14</span>, <span class="at">height =</span> <span class="dv">10</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb375-37"><a href="#cb375-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"   plot/feature_importance_across_models.png</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb375-38"><a href="#cb375-38" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>   plot/feature_importance_across_models.png</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb377"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb377-1"><a href="#cb377-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb377-2"><a href="#cb377-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization (Original 3 Figures)</span></span>
<span id="cb377-3"><a href="#cb377-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb377-4"><a href="#cb377-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-5"><a href="#cb377-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb379"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb379-1"><a href="#cb379-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Generate Performance Visualizations ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== Generate Performance Visualizations ===</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb381"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb381-1"><a href="#cb381-1" aria-hidden="true" tabindex="-1"></a>perf_plot_data <span class="ot">&lt;-</span> perf_table <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Model_Num =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>())</span>
<span id="cb381-2"><a href="#cb381-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-3"><a href="#cb381-3" aria-hidden="true" tabindex="-1"></a>p_r2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(perf_plot_data, <span class="fu">aes</span>(Model_Num)) <span class="sc">+</span></span>
<span id="cb381-4"><a href="#cb381-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> R2, <span class="at">color =</span> <span class="st">"Training R²"</span>), <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb381-5"><a href="#cb381-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> CV_R2, <span class="at">color =</span> <span class="st">"CV R²"</span>), <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb381-6"><a href="#cb381-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> R2, <span class="at">color =</span> <span class="st">"Training R²"</span>), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb381-7"><a href="#cb381-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> CV_R2, <span class="at">color =</span> <span class="st">"CV R²"</span>), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb381-8"><a href="#cb381-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Training R²"</span> <span class="ot">=</span> <span class="st">"#67001F"</span>, <span class="st">"CV R²"</span> <span class="ot">=</span> <span class="st">"#053061"</span>), <span class="at">name =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb381-9"><a href="#cb381-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">labels =</span> perf_table<span class="sc">$</span>Model) <span class="sc">+</span></span>
<span id="cb381-10"><a href="#cb381-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb381-11"><a href="#cb381-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb381-12"><a href="#cb381-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb381-13"><a href="#cb381-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">20</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb381-14"><a href="#cb381-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb381-15"><a href="#cb381-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb381-16"><a href="#cb381-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb381-17"><a href="#cb381-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb381-18"><a href="#cb381-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb381-19"><a href="#cb381-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"R² Improvement: Progressive Model Building"</span>, <span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"R² Value"</span>)</span>
<span id="cb381-20"><a href="#cb381-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-21"><a href="#cb381-21" aria-hidden="true" tabindex="-1"></a>p_rmse <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(perf_plot_data, <span class="fu">aes</span>(Model_Num)) <span class="sc">+</span></span>
<span id="cb381-22"><a href="#cb381-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> RMSE_original<span class="sc">/</span><span class="dv">1000</span>, <span class="at">color =</span> <span class="st">"RMSE ($1000s)"</span>), <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb381-23"><a href="#cb381-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> RMSE_original<span class="sc">/</span><span class="dv">1000</span>, <span class="at">color =</span> <span class="st">"RMSE ($1000s)"</span>), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb381-24"><a href="#cb381-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"RMSE ($1000s)"</span> <span class="ot">=</span> <span class="st">"#67001F"</span>), <span class="at">name =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb381-25"><a href="#cb381-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">labels =</span> perf_table<span class="sc">$</span>Model) <span class="sc">+</span></span>
<span id="cb381-26"><a href="#cb381-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb381-27"><a href="#cb381-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb381-28"><a href="#cb381-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">20</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb381-29"><a href="#cb381-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb381-30"><a href="#cb381-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb381-31"><a href="#cb381-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb381-32"><a href="#cb381-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb381-33"><a href="#cb381-33" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb381-34"><a href="#cb381-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"RMSE Reduction (Original Scale)"</span>, <span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"RMSE ($1000s)"</span>)</span>
<span id="cb381-35"><a href="#cb381-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-36"><a href="#cb381-36" aria-hidden="true" tabindex="-1"></a>p_combined <span class="ot">&lt;-</span> (p_r2 <span class="sc">|</span> p_rmse) <span class="sc">+</span></span>
<span id="cb381-37"><a href="#cb381-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_annotation</span>(</span>
<span id="cb381-38"><a href="#cb381-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"4-Model Progressive OLS: Performance Evolution"</span>,</span>
<span id="cb381-39"><a href="#cb381-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"From structural features to full specification with interactions and fixed effects"</span>,</span>
<span id="cb381-40"><a href="#cb381-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(</span>
<span id="cb381-41"><a href="#cb381-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">15</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb381-42"><a href="#cb381-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb381-43"><a href="#cb381-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb381-44"><a href="#cb381-44" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb381-45"><a href="#cb381-45" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb381-46"><a href="#cb381-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-47"><a href="#cb381-47" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"plot/ols_4model_performance.png"</span>, p_combined, <span class="at">width =</span> <span class="dv">14</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb381-48"><a href="#cb381-48" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  ✓ plot/ols_4model_performance.png</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ✓ plot/ols_4model_performance.png</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb383"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb383-1"><a href="#cb383-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prediction Scatter Plot</span></span>
<span id="cb383-2"><a href="#cb383-2" aria-hidden="true" tabindex="-1"></a>pred_m4 <span class="ot">&lt;-</span> <span class="fu">fitted</span>(models[[<span class="st">"M4: +Interact+FE"</span>]])</span>
<span id="cb383-3"><a href="#cb383-3" aria-hidden="true" tabindex="-1"></a>actual_m4 <span class="ot">&lt;-</span> df[[y_var]][<span class="sc">!</span><span class="fu">is.na</span>(pred_m4)]</span>
<span id="cb383-4"><a href="#cb383-4" aria-hidden="true" tabindex="-1"></a>pred_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb383-5"><a href="#cb383-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">actual =</span> actual_m4,</span>
<span id="cb383-6"><a href="#cb383-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">predicted =</span> pred_m4[<span class="sc">!</span><span class="fu">is.na</span>(pred_m4)],</span>
<span id="cb383-7"><a href="#cb383-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">residual =</span> pred_m4[<span class="sc">!</span><span class="fu">is.na</span>(pred_m4)] <span class="sc">-</span> actual_m4</span>
<span id="cb383-8"><a href="#cb383-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb383-9"><a href="#cb383-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb383-10"><a href="#cb383-10" aria-hidden="true" tabindex="-1"></a>p_pred <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(pred_data, <span class="fu">aes</span>(actual, predicted)) <span class="sc">+</span></span>
<span id="cb383-11"><a href="#cb383-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> residual), <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">size =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb383-12"><a href="#cb383-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_gradient2</span>(<span class="at">low =</span> <span class="st">"#053061"</span>, <span class="at">mid =</span> <span class="st">"#F7F7F7"</span>, <span class="at">high =</span> <span class="st">"#67001F"</span>, <span class="at">midpoint =</span> <span class="dv">0</span>, <span class="at">name =</span> <span class="st">"Residual"</span>) <span class="sc">+</span></span>
<span id="cb383-13"><a href="#cb383-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb383-14"><a href="#cb383-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">min</span>(pred_data<span class="sc">$</span>actual) <span class="sc">+</span> <span class="fl">0.5</span>, <span class="at">y =</span> <span class="fu">max</span>(pred_data<span class="sc">$</span>predicted) <span class="sc">-</span> <span class="fl">0.5</span>,</span>
<span id="cb383-15"><a href="#cb383-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">sprintf</span>(<span class="st">"R² = %.4f</span><span class="sc">\n</span><span class="st">RMSE = %.4f"</span>, perf_table<span class="sc">$</span>R2[<span class="dv">4</span>], perf_table<span class="sc">$</span>RMSE[<span class="dv">4</span>]),</span>
<span id="cb383-16"><a href="#cb383-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="fl">4.5</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb383-17"><a href="#cb383-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb383-18"><a href="#cb383-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb383-19"><a href="#cb383-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb383-20"><a href="#cb383-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb383-21"><a href="#cb383-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">11</span>),</span>
<span id="cb383-22"><a href="#cb383-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb383-23"><a href="#cb383-23" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb383-24"><a href="#cb383-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Model 4: Prediction vs. Actual"</span>,</span>
<span id="cb383-25"><a href="#cb383-25" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Full specification with interactions and fixed effects"</span>,</span>
<span id="cb383-26"><a href="#cb383-26" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Actual Sale Price (log)"</span>, <span class="at">y =</span> <span class="st">"Predicted Sale Price (log)"</span>)</span>
<span id="cb383-27"><a href="#cb383-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb383-28"><a href="#cb383-28" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"plot/ols_4model_prediction.png"</span>, p_pred, <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb383-29"><a href="#cb383-29" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"   plot/ols_4model_prediction.png</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>   plot/ols_4model_prediction.png</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb385"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb385-1"><a href="#cb385-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Residual Diagnostics</span></span>
<span id="cb385-2"><a href="#cb385-2" aria-hidden="true" tabindex="-1"></a>resid_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb385-3"><a href="#cb385-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">fitted =</span> pred_m4[<span class="sc">!</span><span class="fu">is.na</span>(pred_m4)],</span>
<span id="cb385-4"><a href="#cb385-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">residual =</span> pred_data<span class="sc">$</span>residual,</span>
<span id="cb385-5"><a href="#cb385-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">std_resid =</span> <span class="fu">rstandard</span>(models[[<span class="st">"M4: +Interact+FE"</span>]])[<span class="sc">!</span><span class="fu">is.na</span>(pred_m4)]</span>
<span id="cb385-6"><a href="#cb385-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb385-7"><a href="#cb385-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb385-8"><a href="#cb385-8" aria-hidden="true" tabindex="-1"></a>p_r1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(resid_data, <span class="fu">aes</span>(fitted, residual)) <span class="sc">+</span></span>
<span id="cb385-9"><a href="#cb385-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"#053061"</span>) <span class="sc">+</span></span>
<span id="cb385-10"><a href="#cb385-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb385-11"><a href="#cb385-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">color =</span> <span class="st">"#67001F"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb385-12"><a href="#cb385-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb385-13"><a href="#cb385-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(), <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb385-14"><a href="#cb385-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residuals vs. Fitted"</span>, <span class="at">x =</span> <span class="st">"Fitted"</span>, <span class="at">y =</span> <span class="st">"Residuals"</span>)</span>
<span id="cb385-15"><a href="#cb385-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb385-16"><a href="#cb385-16" aria-hidden="true" tabindex="-1"></a>p_r2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(resid_data, <span class="fu">aes</span>(<span class="at">sample =</span> std_resid)) <span class="sc">+</span></span>
<span id="cb385-17"><a href="#cb385-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_qq</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">size =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"#053061"</span>) <span class="sc">+</span></span>
<span id="cb385-18"><a href="#cb385-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_qq_line</span>(<span class="at">color =</span> <span class="st">"#67001F"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb385-19"><a href="#cb385-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb385-20"><a href="#cb385-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(), <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb385-21"><a href="#cb385-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Normal Q-Q"</span>, <span class="at">x =</span> <span class="st">"Theoretical"</span>, <span class="at">y =</span> <span class="st">"Std. Residuals"</span>)</span>
<span id="cb385-22"><a href="#cb385-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb385-23"><a href="#cb385-23" aria-hidden="true" tabindex="-1"></a>p_r3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(resid_data, <span class="fu">aes</span>(std_resid)) <span class="sc">+</span></span>
<span id="cb385-24"><a href="#cb385-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>, <span class="at">fill =</span> <span class="st">"#053061"</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb385-25"><a href="#cb385-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"#67001F"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb385-26"><a href="#cb385-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb385-27"><a href="#cb385-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(), <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb385-28"><a href="#cb385-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residual Distribution"</span>, <span class="at">x =</span> <span class="st">"Std. Residuals"</span>, <span class="at">y =</span> <span class="st">"Count"</span>)</span>
<span id="cb385-29"><a href="#cb385-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb385-30"><a href="#cb385-30" aria-hidden="true" tabindex="-1"></a>p_r4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(resid_data, <span class="fu">aes</span>(fitted, <span class="fu">sqrt</span>(<span class="fu">abs</span>(std_resid)))) <span class="sc">+</span></span>
<span id="cb385-31"><a href="#cb385-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"#053061"</span>) <span class="sc">+</span></span>
<span id="cb385-32"><a href="#cb385-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">color =</span> <span class="st">"#67001F"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb385-33"><a href="#cb385-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb385-34"><a href="#cb385-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(), <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb385-35"><a href="#cb385-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Scale-Location"</span>, <span class="at">x =</span> <span class="st">"Fitted"</span>, <span class="at">y =</span> <span class="st">"√|Std. Residuals|"</span>)</span>
<span id="cb385-36"><a href="#cb385-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb385-37"><a href="#cb385-37" aria-hidden="true" tabindex="-1"></a>p_diag <span class="ot">&lt;-</span> (p_r1 <span class="sc">|</span> p_r2) <span class="sc">/</span> (p_r3 <span class="sc">|</span> p_r4) <span class="sc">+</span></span>
<span id="cb385-38"><a href="#cb385-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_annotation</span>(</span>
<span id="cb385-39"><a href="#cb385-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="fu">sprintf</span>(<span class="st">"Model 4 Diagnostics (BP test p = %.4f)"</span>, bp_test<span class="sc">$</span>p.value),</span>
<span id="cb385-40"><a href="#cb385-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb385-41"><a href="#cb385-41" aria-hidden="true" tabindex="-1"></a>                  <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>))</span>
<span id="cb385-42"><a href="#cb385-42" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb385-43"><a href="#cb385-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb385-44"><a href="#cb385-44" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"plot/ols_4model_diagnostics.png"</span>, p_diag, <span class="at">width =</span> <span class="dv">12</span>, <span class="at">height =</span> <span class="dv">10</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb385-45"><a href="#cb385-45" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  ✓ plot/ols_4model_diagnostics.png</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ✓ plot/ols_4model_diagnostics.png</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb387"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb387-1"><a href="#cb387-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb387-2"><a href="#cb387-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial Prediction Comparison Plot</span></span>
<span id="cb387-3"><a href="#cb387-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb387-4"><a href="#cb387-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb387-5"><a href="#cb387-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"x_coord"</span>, <span class="st">"y_coord"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(df))) {</span>
<span id="cb387-6"><a href="#cb387-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb387-7"><a href="#cb387-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"=== Generating Spatial Prediction Comparison Plot ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb387-8"><a href="#cb387-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb387-9"><a href="#cb387-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Prepare data</span></span>
<span id="cb387-10"><a href="#cb387-10" aria-hidden="true" tabindex="-1"></a>  spatial_pred_data <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb387-11"><a href="#cb387-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(x_coord) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(y_coord)) <span class="sc">%&gt;%</span></span>
<span id="cb387-12"><a href="#cb387-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb387-13"><a href="#cb387-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">predicted =</span> <span class="fu">fitted</span>(models[[<span class="st">"M4: +Interact+FE"</span>]]),</span>
<span id="cb387-14"><a href="#cb387-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">residual =</span> predicted <span class="sc">-</span> .data[[y_var]]</span>
<span id="cb387-15"><a href="#cb387-15" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb387-16"><a href="#cb387-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(predicted))</span>
<span id="cb387-17"><a href="#cb387-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb387-18"><a href="#cb387-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If the dataset is too large, randomly sample to speed up plotting</span></span>
<span id="cb387-19"><a href="#cb387-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(spatial_pred_data) <span class="sc">&gt;</span> <span class="dv">10000</span>) {</span>
<span id="cb387-20"><a href="#cb387-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(<span class="dv">2025</span>)</span>
<span id="cb387-21"><a href="#cb387-21" aria-hidden="true" tabindex="-1"></a>    spatial_pred_data <span class="ot">&lt;-</span> spatial_pred_data <span class="sc">%&gt;%</span> </span>
<span id="cb387-22"><a href="#cb387-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">10000</span>)</span>
<span id="cb387-23"><a href="#cb387-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Large dataset detected; randomly sampled 10,000 points for plotting</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb387-24"><a href="#cb387-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb387-25"><a href="#cb387-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb387-26"><a href="#cb387-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Spatial Distribution of Actual Sale Prices</span></span>
<span id="cb387-27"><a href="#cb387-27" aria-hidden="true" tabindex="-1"></a>p_actual <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(spatial_pred_data, <span class="fu">aes</span>(x_coord, y_coord, <span class="at">color =</span> .data[[y_var]])) <span class="sc">+</span></span>
<span id="cb387-28"><a href="#cb387-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb387-29"><a href="#cb387-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_gradient2</span>(</span>
<span id="cb387-30"><a href="#cb387-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">low =</span> <span class="st">"#053061"</span>, <span class="at">mid =</span> <span class="st">"#F7F7F7"</span>, <span class="at">high =</span> <span class="st">"#67001F"</span>,</span>
<span id="cb387-31"><a href="#cb387-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">midpoint =</span> <span class="fu">median</span>(spatial_pred_data[[y_var]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb387-32"><a href="#cb387-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Log Price"</span></span>
<span id="cb387-33"><a href="#cb387-33" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb387-34"><a href="#cb387-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb387-35"><a href="#cb387-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb387-36"><a href="#cb387-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb387-37"><a href="#cb387-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb387-38"><a href="#cb387-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb387-39"><a href="#cb387-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb387-40"><a href="#cb387-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb387-41"><a href="#cb387-41" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb387-42"><a href="#cb387-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb387-43"><a href="#cb387-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Actual Sale Price"</span>,</span>
<span id="cb387-44"><a href="#cb387-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"X Coordinate"</span>,</span>
<span id="cb387-45"><a href="#cb387-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Y Coordinate"</span></span>
<span id="cb387-46"><a href="#cb387-46" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb387-47"><a href="#cb387-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb387-48"><a href="#cb387-48" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Spatial Distribution of Predicted Sale Prices</span></span>
<span id="cb387-49"><a href="#cb387-49" aria-hidden="true" tabindex="-1"></a>p_predicted <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(spatial_pred_data, <span class="fu">aes</span>(x_coord, y_coord, <span class="at">color =</span> predicted)) <span class="sc">+</span></span>
<span id="cb387-50"><a href="#cb387-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb387-51"><a href="#cb387-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_gradient2</span>(</span>
<span id="cb387-52"><a href="#cb387-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">low =</span> <span class="st">"#053061"</span>, <span class="at">mid =</span> <span class="st">"#F7F7F7"</span>, <span class="at">high =</span> <span class="st">"#67001F"</span>,</span>
<span id="cb387-53"><a href="#cb387-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">midpoint =</span> <span class="fu">median</span>(spatial_pred_data<span class="sc">$</span>predicted, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb387-54"><a href="#cb387-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Log Price"</span></span>
<span id="cb387-55"><a href="#cb387-55" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb387-56"><a href="#cb387-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb387-57"><a href="#cb387-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb387-58"><a href="#cb387-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb387-59"><a href="#cb387-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb387-60"><a href="#cb387-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb387-61"><a href="#cb387-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb387-62"><a href="#cb387-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb387-63"><a href="#cb387-63" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb387-64"><a href="#cb387-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb387-65"><a href="#cb387-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Predicted Sale Price (Model 4)"</span>,</span>
<span id="cb387-66"><a href="#cb387-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"X Coordinate"</span>,</span>
<span id="cb387-67"><a href="#cb387-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Y Coordinate"</span></span>
<span id="cb387-68"><a href="#cb387-68" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb387-69"><a href="#cb387-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb387-70"><a href="#cb387-70" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Spatial Distribution of Residuals</span></span>
<span id="cb387-71"><a href="#cb387-71" aria-hidden="true" tabindex="-1"></a>p_residual_spatial <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(spatial_pred_data, <span class="fu">aes</span>(x_coord, y_coord, <span class="at">color =</span> residual)) <span class="sc">+</span></span>
<span id="cb387-72"><a href="#cb387-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb387-73"><a href="#cb387-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_gradient2</span>(</span>
<span id="cb387-74"><a href="#cb387-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">low =</span> <span class="st">"#053061"</span>, <span class="at">mid =</span> <span class="st">"#F7F7F7"</span>, <span class="at">high =</span> <span class="st">"#67001F"</span>,</span>
<span id="cb387-75"><a href="#cb387-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">midpoint =</span> <span class="dv">0</span>,</span>
<span id="cb387-76"><a href="#cb387-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Residual"</span></span>
<span id="cb387-77"><a href="#cb387-77" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb387-78"><a href="#cb387-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb387-79"><a href="#cb387-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb387-80"><a href="#cb387-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb387-81"><a href="#cb387-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb387-82"><a href="#cb387-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb387-83"><a href="#cb387-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb387-84"><a href="#cb387-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb387-85"><a href="#cb387-85" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb387-86"><a href="#cb387-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb387-87"><a href="#cb387-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Prediction Residuals"</span>,</span>
<span id="cb387-88"><a href="#cb387-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Blue = Underpredicted | Red = Overpredicted"</span>,</span>
<span id="cb387-89"><a href="#cb387-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"X Coordinate"</span>,</span>
<span id="cb387-90"><a href="#cb387-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Y Coordinate"</span></span>
<span id="cb387-91"><a href="#cb387-91" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb387-92"><a href="#cb387-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb387-93"><a href="#cb387-93" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the 3 plots</span></span>
<span id="cb387-94"><a href="#cb387-94" aria-hidden="true" tabindex="-1"></a>p_spatial_comparison <span class="ot">&lt;-</span> (p_actual <span class="sc">|</span> p_predicted <span class="sc">|</span> p_residual_spatial) <span class="sc">+</span></span>
<span id="cb387-95"><a href="#cb387-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_annotation</span>(</span>
<span id="cb387-96"><a href="#cb387-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Spatial Distribution: Actual vs. Predicted Sale Prices"</span>,</span>
<span id="cb387-97"><a href="#cb387-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">sprintf</span>(<span class="st">"Model 4 predictions (R² = %.4f, RMSE = %.4f)"</span>, </span>
<span id="cb387-98"><a href="#cb387-98" aria-hidden="true" tabindex="-1"></a>                      perf_table<span class="sc">$</span>R2[<span class="dv">4</span>], perf_table<span class="sc">$</span>RMSE[<span class="dv">4</span>]),</span>
<span id="cb387-99"><a href="#cb387-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(</span>
<span id="cb387-100"><a href="#cb387-100" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">15</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb387-101"><a href="#cb387-101" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb387-102"><a href="#cb387-102" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb387-103"><a href="#cb387-103" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb387-104"><a href="#cb387-104" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb387-105"><a href="#cb387-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb387-106"><a href="#cb387-106" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"plot/spatial_prediction_comparison.png"</span>, p_spatial_comparison,</span>
<span id="cb387-107"><a href="#cb387-107" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">18</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb387-108"><a href="#cb387-108" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"   plot/spatial_prediction_comparison.png</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb387-109"><a href="#cb387-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb387-110"><a href="#cb387-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4. High-Resolution Hexbin Heatmap Version</span></span>
<span id="cb387-111"><a href="#cb387-111" aria-hidden="true" tabindex="-1"></a>  p_actual_hex <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(spatial_pred_data, <span class="fu">aes</span>(x_coord, y_coord, <span class="at">z =</span> .data[[y_var]])) <span class="sc">+</span></span>
<span id="cb387-112"><a href="#cb387-112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_summary_hex</span>(<span class="at">bins =</span> <span class="dv">40</span>, <span class="at">fun =</span> mean) <span class="sc">+</span></span>
<span id="cb387-113"><a href="#cb387-113" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradient2</span>(</span>
<span id="cb387-114"><a href="#cb387-114" aria-hidden="true" tabindex="-1"></a>      <span class="at">low =</span> <span class="st">"#053061"</span>, <span class="at">mid =</span> <span class="st">"#F7F7F7"</span>, <span class="at">high =</span> <span class="st">"#67001F"</span>,</span>
<span id="cb387-115"><a href="#cb387-115" aria-hidden="true" tabindex="-1"></a>      <span class="at">midpoint =</span> <span class="fu">median</span>(spatial_pred_data[[y_var]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb387-116"><a href="#cb387-116" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Avg Log Price"</span></span>
<span id="cb387-117"><a href="#cb387-117" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb387-118"><a href="#cb387-118" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb387-119"><a href="#cb387-119" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb387-120"><a href="#cb387-120" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb387-121"><a href="#cb387-121" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb387-122"><a href="#cb387-122" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb387-123"><a href="#cb387-123" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb387-124"><a href="#cb387-124" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb387-125"><a href="#cb387-125" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Actual (Hexbin Average)"</span>, <span class="at">x =</span> <span class="st">"X Coordinate"</span>, <span class="at">y =</span> <span class="st">"Y Coordinate"</span>)</span>
<span id="cb387-126"><a href="#cb387-126" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb387-127"><a href="#cb387-127" aria-hidden="true" tabindex="-1"></a>  p_predicted_hex <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(spatial_pred_data, <span class="fu">aes</span>(x_coord, y_coord, <span class="at">z =</span> predicted)) <span class="sc">+</span></span>
<span id="cb387-128"><a href="#cb387-128" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_summary_hex</span>(<span class="at">bins =</span> <span class="dv">40</span>, <span class="at">fun =</span> mean) <span class="sc">+</span></span>
<span id="cb387-129"><a href="#cb387-129" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradient2</span>(</span>
<span id="cb387-130"><a href="#cb387-130" aria-hidden="true" tabindex="-1"></a>      <span class="at">low =</span> <span class="st">"#053061"</span>, <span class="at">mid =</span> <span class="st">"#F7F7F7"</span>, <span class="at">high =</span> <span class="st">"#67001F"</span>,</span>
<span id="cb387-131"><a href="#cb387-131" aria-hidden="true" tabindex="-1"></a>      <span class="at">midpoint =</span> <span class="fu">median</span>(spatial_pred_data<span class="sc">$</span>predicted, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb387-132"><a href="#cb387-132" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Avg Log Price"</span></span>
<span id="cb387-133"><a href="#cb387-133" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb387-134"><a href="#cb387-134" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb387-135"><a href="#cb387-135" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb387-136"><a href="#cb387-136" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb387-137"><a href="#cb387-137" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb387-138"><a href="#cb387-138" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb387-139"><a href="#cb387-139" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb387-140"><a href="#cb387-140" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb387-141"><a href="#cb387-141" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Predicted (Hexbin Average)"</span>, <span class="at">x =</span> <span class="st">"X Coordinate"</span>, <span class="at">y =</span> <span class="st">"Y Coordinate"</span>)</span>
<span id="cb387-142"><a href="#cb387-142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb387-143"><a href="#cb387-143" aria-hidden="true" tabindex="-1"></a>  p_residual_hex <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(spatial_pred_data, <span class="fu">aes</span>(x_coord, y_coord, <span class="at">z =</span> residual)) <span class="sc">+</span></span>
<span id="cb387-144"><a href="#cb387-144" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_summary_hex</span>(<span class="at">bins =</span> <span class="dv">40</span>, <span class="at">fun =</span> mean) <span class="sc">+</span></span>
<span id="cb387-145"><a href="#cb387-145" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradient2</span>(</span>
<span id="cb387-146"><a href="#cb387-146" aria-hidden="true" tabindex="-1"></a>      <span class="at">low =</span> <span class="st">"#053061"</span>, <span class="at">mid =</span> <span class="st">"#F7F7F7"</span>, <span class="at">high =</span> <span class="st">"#67001F"</span>,</span>
<span id="cb387-147"><a href="#cb387-147" aria-hidden="true" tabindex="-1"></a>      <span class="at">midpoint =</span> <span class="dv">0</span>,</span>
<span id="cb387-148"><a href="#cb387-148" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Avg Residual"</span></span>
<span id="cb387-149"><a href="#cb387-149" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb387-150"><a href="#cb387-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb387-151"><a href="#cb387-151" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb387-152"><a href="#cb387-152" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb387-153"><a href="#cb387-153" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb387-154"><a href="#cb387-154" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb387-155"><a href="#cb387-155" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb387-156"><a href="#cb387-156" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb387-157"><a href="#cb387-157" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residuals (Hexbin Average)"</span>, <span class="at">x =</span> <span class="st">"X Coordinate"</span>, <span class="at">y =</span> <span class="st">"Y Coordinate"</span>)</span>
<span id="cb387-158"><a href="#cb387-158" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb387-159"><a href="#cb387-159" aria-hidden="true" tabindex="-1"></a>  p_spatial_hexbin <span class="ot">&lt;-</span> (p_actual_hex <span class="sc">|</span> p_predicted_hex <span class="sc">|</span> p_residual_hex) <span class="sc">+</span></span>
<span id="cb387-160"><a href="#cb387-160" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_annotation</span>(</span>
<span id="cb387-161"><a href="#cb387-161" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Spatial Distribution (Hexbin Aggregation): Actual vs. Predicted"</span>,</span>
<span id="cb387-162"><a href="#cb387-162" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="st">"Hexagonal bins show average values in each area"</span>,</span>
<span id="cb387-163"><a href="#cb387-163" aria-hidden="true" tabindex="-1"></a>      <span class="at">theme =</span> <span class="fu">theme</span>(</span>
<span id="cb387-164"><a href="#cb387-164" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">15</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb387-165"><a href="#cb387-165" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb387-166"><a href="#cb387-166" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb387-167"><a href="#cb387-167" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb387-168"><a href="#cb387-168" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb387-169"><a href="#cb387-169" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb387-170"><a href="#cb387-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="st">"plot/spatial_prediction_hexbin.png"</span>, p_spatial_hexbin,</span>
<span id="cb387-171"><a href="#cb387-171" aria-hidden="true" tabindex="-1"></a>         <span class="at">width =</span> <span class="dv">18</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb387-172"><a href="#cb387-172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  ✓ plot/spatial_prediction_hexbin.png</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb387-173"><a href="#cb387-173" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb387-174"><a href="#cb387-174" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5. Spatial Clustering of Residuals</span></span>
<span id="cb387-175"><a href="#cb387-175" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate spatial statistics of residuals</span></span>
<span id="cb387-176"><a href="#cb387-176" aria-hidden="true" tabindex="-1"></a>  residual_stats <span class="ot">&lt;-</span> spatial_pred_data <span class="sc">%&gt;%</span></span>
<span id="cb387-177"><a href="#cb387-177" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb387-178"><a href="#cb387-178" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_residual =</span> <span class="fu">mean</span>(residual, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb387-179"><a href="#cb387-179" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd_residual =</span> <span class="fu">sd</span>(residual, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb387-180"><a href="#cb387-180" aria-hidden="true" tabindex="-1"></a>      <span class="at">min_residual =</span> <span class="fu">min</span>(residual, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb387-181"><a href="#cb387-181" aria-hidden="true" tabindex="-1"></a>      <span class="at">max_residual =</span> <span class="fu">max</span>(residual, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb387-182"><a href="#cb387-182" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb387-183"><a href="#cb387-183" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb387-184"><a href="#cb387-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">  Spatial Residual Statistics:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb387-185"><a href="#cb387-185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"    Mean: %.4f</span><span class="sc">\n</span><span class="st">"</span>, residual_stats<span class="sc">$</span>mean_residual))</span>
<span id="cb387-186"><a href="#cb387-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"    Standard Deviation: %.4f</span><span class="sc">\n</span><span class="st">"</span>, residual_stats<span class="sc">$</span>sd_residual))</span>
<span id="cb387-187"><a href="#cb387-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"    Range: [%.4f, %.4f]</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb387-188"><a href="#cb387-188" aria-hidden="true" tabindex="-1"></a>              residual_stats<span class="sc">$</span>min_residual, residual_stats<span class="sc">$</span>max_residual))</span>
<span id="cb387-189"><a href="#cb387-189" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb387-190"><a href="#cb387-190" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Identify high-residual areas</span></span>
<span id="cb387-191"><a href="#cb387-191" aria-hidden="true" tabindex="-1"></a>  high_residual_areas <span class="ot">&lt;-</span> spatial_pred_data <span class="sc">%&gt;%</span></span>
<span id="cb387-192"><a href="#cb387-192" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">abs</span>(residual) <span class="sc">&gt;</span> <span class="dv">2</span> <span class="sc">*</span> residual_stats<span class="sc">$</span>sd_residual) <span class="sc">%&gt;%</span></span>
<span id="cb387-193"><a href="#cb387-193" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">residual_type =</span> <span class="fu">ifelse</span>(residual <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Overpredicted"</span>, <span class="st">"Underpredicted"</span>))</span>
<span id="cb387-194"><a href="#cb387-194" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb387-195"><a href="#cb387-195" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(high_residual_areas) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb387-196"><a href="#cb387-196" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">  ️ Detected %d high-residual points (|residual| &gt; 2σ):</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb387-197"><a href="#cb387-197" aria-hidden="true" tabindex="-1"></a>                <span class="fu">nrow</span>(high_residual_areas)))</span>
<span id="cb387-198"><a href="#cb387-198" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"    Overpredicted: %d</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">sum</span>(high_residual_areas<span class="sc">$</span>residual_type <span class="sc">==</span> <span class="st">"Overpredicted"</span>)))</span>
<span id="cb387-199"><a href="#cb387-199" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"    Underpredicted: %d</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">sum</span>(high_residual_areas<span class="sc">$</span>residual_type <span class="sc">==</span> <span class="st">"Underpredicted"</span>)))</span>
<span id="cb387-200"><a href="#cb387-200" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb387-201"><a href="#cb387-201" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save high-residual point data</span></span>
<span id="cb387-202"><a href="#cb387-202" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(high_residual_areas <span class="sc">%&gt;%</span> </span>
<span id="cb387-203"><a href="#cb387-203" aria-hidden="true" tabindex="-1"></a>                dplyr<span class="sc">::</span><span class="fu">select</span>(x_coord, y_coord, <span class="sc">!!</span><span class="fu">sym</span>(y_var), predicted, residual, residual_type),</span>
<span id="cb387-204"><a href="#cb387-204" aria-hidden="true" tabindex="-1"></a>              <span class="st">"file/high_residual_locations.csv"</span>)</span>
<span id="cb387-205"><a href="#cb387-205" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"     file/high_residual_locations.csv</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb387-206"><a href="#cb387-206" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb387-207"><a href="#cb387-207" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================
=== Generating Spatial Prediction Comparison Plot ===

  Large dataset detected; randomly sampled 10,000 points for plotting</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>   plot/spatial_prediction_comparison.png</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  ✓ plot/spatial_prediction_hexbin.png

  Spatial Residual Statistics:
    Mean: 0.0036
    Standard Deviation: 0.5571
    Range: [-3.8418, 3.8371]

  ️ Detected 483 high-residual points (|residual| &gt; 2σ):
    Overpredicted: 294
    Underpredicted: 189
     file/high_residual_locations.csv</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb391"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb391-1"><a href="#cb391-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb391-2"><a href="#cb391-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Save Results</span></span>
<span id="cb391-3"><a href="#cb391-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb391-4"><a href="#cb391-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb391-5"><a href="#cb391-5" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(perf_table, <span class="st">"file/ols_4model_performance.csv"</span>)</span>
<span id="cb391-6"><a href="#cb391-6" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(models, <span class="st">"file/ols_4models.rds"</span>)</span>
<span id="cb391-7"><a href="#cb391-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb391-8"><a href="#cb391-8" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb391-9"><a href="#cb391-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary</span></span>
<span id="cb391-10"><a href="#cb391-10" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb391-11"><a href="#cb391-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb391-12"><a href="#cb391-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb393"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb393-1"><a href="#cb393-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">" Step 4 Completed</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> Step 4 Completed</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb395"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb395-1"><a href="#cb395-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb397"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb397-1"><a href="#cb397-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">" Output Files:</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> Output Files:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb399"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb399-1"><a href="#cb399-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Tables:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Tables:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb401"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb401-1"><a href="#cb401-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • table/model4_full_coefficients.csv - Full coefficient table (Model 4)</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • table/model4_full_coefficients.csv - Full coefficient table (Model 4)</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb403"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb403-1"><a href="#cb403-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • table/model4_significant_coefficients.csv - Significant coefficients (Model 4)</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • table/model4_significant_coefficients.csv - Significant coefficients (Model 4)</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb405"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb405-1"><a href="#cb405-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • table/regression_table.txt - Stargazer regression summary</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • table/regression_table.txt - Stargazer regression summary</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb407"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb407-1"><a href="#cb407-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • table/feature_importance_all_models.csv - Cross-model feature importance</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • table/feature_importance_all_models.csv - Cross-model feature importance</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb409"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb409-1"><a href="#cb409-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • file/ols_4model_performance.csv - Model performance comparison</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • file/ols_4model_performance.csv - Model performance comparison</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb411"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb411-1"><a href="#cb411-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • file/ols_4models.rds - RDS objects of all 4 models</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • file/ols_4models.rds - RDS objects of all 4 models</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb413"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb413-1"><a href="#cb413-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Figures:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Figures:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb415"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb415-1"><a href="#cb415-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • plot/ols_4model_performance.png - Performance evolution</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • plot/ols_4model_performance.png - Performance evolution</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb417"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb417-1"><a href="#cb417-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • plot/ols_4model_prediction.png - Model 4 prediction vs. actual</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • plot/ols_4model_prediction.png - Model 4 prediction vs. actual</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb419"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb419-1"><a href="#cb419-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • plot/ols_4model_diagnostics.png - Model 4 diagnostic plots</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • plot/ols_4model_diagnostics.png - Model 4 diagnostic plots</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb421"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb421-1"><a href="#cb421-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • plot/feature_importance_across_models.png - Cross-model feature importance</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • plot/feature_importance_across_models.png - Cross-model feature importance</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb423"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb423-1"><a href="#cb423-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"x_coord"</span>, <span class="st">"y_coord"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(df))) {</span>
<span id="cb423-2"><a href="#cb423-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  • plot/spatial_prediction_comparison.png - Spatial prediction comparison</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb423-3"><a href="#cb423-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  • plot/spatial_prediction_hexbin.png - Spatial prediction heatmap</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb423-4"><a href="#cb423-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • plot/spatial_prediction_comparison.png - Spatial prediction comparison
  • plot/spatial_prediction_hexbin.png - Spatial prediction heatmap</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb425"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb425-1"><a href="#cb425-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb426"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb426-1"><a href="#cb426-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">" Model Summary:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> Model Summary:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb428"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb428-1"><a href="#cb428-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>) {</span>
<span id="cb428-2"><a href="#cb428-2" aria-hidden="true" tabindex="-1"></a>  rmse_fmt <span class="ot">&lt;-</span> <span class="fu">formatC</span>(perf_table<span class="sc">$</span>RMSE_original[i], <span class="at">format =</span> <span class="st">"f"</span>, <span class="at">digits =</span> <span class="dv">0</span>, <span class="at">big.mark =</span> <span class="st">","</span>)</span>
<span id="cb428-3"><a href="#cb428-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Model %d: R² = %.4f, RMSE = $%s [%d variables]</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb428-4"><a href="#cb428-4" aria-hidden="true" tabindex="-1"></a>              i, perf_table<span class="sc">$</span>R2[i], rmse_fmt, perf_table<span class="sc">$</span>N_vars[i]))</span>
<span id="cb428-5"><a href="#cb428-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Model 1: R² = 0.3442, RMSE = $172,981 [5 variables]
  Model 2: R² = 0.5126, RMSE = $137,239 [8 variables]
  Model 3: R² = 0.5202, RMSE = $135,991 [11 variables]
  Model 4: R² = 0.5695, RMSE = $121,479 [142 variables]</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb430"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb430-1"><a href="#cb430-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st"> Paper Writing Suggestions:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Paper Writing Suggestions:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb432"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb432-1"><a href="#cb432-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  1. Results (Opening): Descriptive statistics table</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  1. Results (Opening): Descriptive statistics table</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb434"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb434-1"><a href="#cb434-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  2. Results (Core): Stargazer regression summary (comparison of 4 models)</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  2. Results (Core): Stargazer regression summary (comparison of 4 models)</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb436"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb436-1"><a href="#cb436-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  3. Results (Details): Significant coefficients of Model 4</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  3. Results (Details): Significant coefficients of Model 4</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb438"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb438-1"><a href="#cb438-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  4. Discussion: Cross-model feature importance comparison</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  4. Discussion: Cross-model feature importance comparison</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb440"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb440-1"><a href="#cb440-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  5. Mention the use of robust standard errors to address heteroskedasticity</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  5. Mention the use of robust standard errors to address heteroskedasticity</code></pre>
</div>
</div>
<p>Step4 plus</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb442"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb442-1"><a href="#cb442-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb442-2"><a href="#cb442-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4 Supplement: Cook’s Distance + Moran’s I Spatial Autocorrelation</span></span>
<span id="cb442-3"><a href="#cb442-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb442-4"><a href="#cb442-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb442-5"><a href="#cb442-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb442-6"><a href="#cb442-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb442-7"><a href="#cb442-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb442-8"><a href="#cb442-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb442-9"><a href="#cb442-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spdep)  <span class="co"># Moran’s I</span></span>
<span id="cb442-10"><a href="#cb442-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)     <span class="co"># Spatial data</span></span>
<span id="cb442-11"><a href="#cb442-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb442-12"><a href="#cb442-12" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2025</span>)</span>
<span id="cb442-13"><a href="#cb442-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb442-14"><a href="#cb442-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb444"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb444-1"><a href="#cb444-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">" Step 4 Supplement: Influential Point Diagnostics and Spatial Autocorrelation Test</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> Step 4 Supplement: Influential Point Diagnostics and Spatial Autocorrelation Test</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb446"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb446-1"><a href="#cb446-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb448"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb448-1"><a href="#cb448-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === Load Data and Models ===</span></span>
<span id="cb448-2"><a href="#cb448-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"file/opa_sales_step2_clean.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb448-3"><a href="#cb448-3" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"file/ols_4models.rds"</span>)</span>
<span id="cb448-4"><a href="#cb448-4" aria-hidden="true" tabindex="-1"></a>model4 <span class="ot">&lt;-</span> models[[<span class="st">"M4: +Interact+FE"</span>]]</span>
<span id="cb448-5"><a href="#cb448-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb448-6"><a href="#cb448-6" aria-hidden="true" tabindex="-1"></a>y_var <span class="ot">&lt;-</span> <span class="fu">case_when</span>(</span>
<span id="cb448-7"><a href="#cb448-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sale_price_log"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df) <span class="sc">~</span> <span class="st">"sale_price_log"</span>,</span>
<span id="cb448-8"><a href="#cb448-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"log_sale_price"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df) <span class="sc">~</span> <span class="st">"log_sale_price"</span>,</span>
<span id="cb448-9"><a href="#cb448-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sale_price"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df) <span class="sc">~</span> <span class="st">"sale_price"</span>,</span>
<span id="cb448-10"><a href="#cb448-10" aria-hidden="true" tabindex="-1"></a>  <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb448-11"><a href="#cb448-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb449"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb449-1"><a href="#cb449-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb449-2"><a href="#cb449-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Cook’s Distance – Influential Observation Detection</span></span>
<span id="cb449-3"><a href="#cb449-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb449-4"><a href="#cb449-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb449-5"><a href="#cb449-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Cook’s Distance Analysis ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== Cook’s Distance Analysis ===</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb451"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb451-1"><a href="#cb451-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Cook’s distance</span></span>
<span id="cb451-2"><a href="#cb451-2" aria-hidden="true" tabindex="-1"></a>cooks_d <span class="ot">&lt;-</span> <span class="fu">cooks.distance</span>(model4)</span>
<span id="cb451-3"><a href="#cb451-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">length</span>(cooks_d)</span>
<span id="cb451-4"><a href="#cb451-4" aria-hidden="true" tabindex="-1"></a>threshold <span class="ot">&lt;-</span> <span class="dv">4</span><span class="sc">/</span>n  <span class="co"># Classic threshold</span></span>
<span id="cb451-5"><a href="#cb451-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb451-6"><a href="#cb451-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify influential points</span></span>
<span id="cb451-7"><a href="#cb451-7" aria-hidden="true" tabindex="-1"></a>influential <span class="ot">&lt;-</span> <span class="fu">which</span>(cooks_d <span class="sc">&gt;</span> threshold)</span>
<span id="cb451-8"><a href="#cb451-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Sample size: %d</span><span class="sc">\n</span><span class="st">"</span>, n))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sample size: 24023</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb453"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb453-1"><a href="#cb453-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Cook’s D threshold: %.6f (4/n)</span><span class="sc">\n</span><span class="st">"</span>, threshold))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cook’s D threshold: 0.000167 (4/n)</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb455"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb455-1"><a href="#cb455-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Number of influential points: %d (%.2f%%)</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">length</span>(influential), <span class="dv">100</span><span class="sc">*</span><span class="fu">length</span>(influential)<span class="sc">/</span>n))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of influential points: 1060 (4.41%)</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb457"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb457-1"><a href="#cb457-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save influential observations</span></span>
<span id="cb457-2"><a href="#cb457-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(influential) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb457-3"><a href="#cb457-3" aria-hidden="true" tabindex="-1"></a>  influential_data <span class="ot">&lt;-</span> df[influential, ] <span class="sc">%&gt;%</span></span>
<span id="cb457-4"><a href="#cb457-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb457-5"><a href="#cb457-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">cooks_d =</span> cooks_d[influential],</span>
<span id="cb457-6"><a href="#cb457-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">fitted =</span> <span class="fu">fitted</span>(model4)[influential],</span>
<span id="cb457-7"><a href="#cb457-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">residual =</span> <span class="fu">residuals</span>(model4)[influential]</span>
<span id="cb457-8"><a href="#cb457-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb457-9"><a href="#cb457-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(cooks_d)) <span class="sc">%&gt;%</span></span>
<span id="cb457-10"><a href="#cb457-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(<span class="dv">100</span>)  <span class="co"># Save Top 100</span></span>
<span id="cb457-11"><a href="#cb457-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb457-12"><a href="#cb457-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(influential_data, <span class="st">"file/influential_observations.csv"</span>)</span>
<span id="cb457-13"><a href="#cb457-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  ✓ file/influential_observations.csv (Top 100 Influential Points)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb457-14"><a href="#cb457-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb457-15"><a href="#cb457-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Display Top 10</span></span>
<span id="cb457-16"><a href="#cb457-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Top 10 Influential Points:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb457-17"><a href="#cb457-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(influential_data <span class="sc">%&gt;%</span> </span>
<span id="cb457-18"><a href="#cb457-18" aria-hidden="true" tabindex="-1"></a>          <span class="fu">select</span>(parcel_number, sale_price, cooks_d, fitted, residual) <span class="sc">%&gt;%</span> </span>
<span id="cb457-19"><a href="#cb457-19" aria-hidden="true" tabindex="-1"></a>          <span class="fu">head</span>(<span class="dv">10</span>), </span>
<span id="cb457-20"><a href="#cb457-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">n =</span> <span class="dv">10</span>)</span>
<span id="cb457-21"><a href="#cb457-21" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ✓ file/influential_observations.csv (Top 100 Influential Points)

Top 10 Influential Points:
# A tibble: 10 × 5
   parcel_number sale_price cooks_d fitted residual
   &lt;chr&gt;              &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
 1 211051105           9.39 0.00407   13.2    -3.84
 2 071348000          15.0  0.00383   11.0     4.04
 3 401237000          15.0  0.00343   11.6     3.44
 4 401237400          15.0  0.00343   11.6     3.44
 5 043166400          15.4  0.00335   11.6     3.85
 6 041330100          15.4  0.00333   11.6     3.84
 7 043055800          15.4  0.00329   11.6     3.82
 8 381091300          14.7  0.00320   11.6     3.04
 9 401220400          15.0  0.00311   11.8     3.28
10 611317900           9.21 0.00303   13.3    -4.04</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb459"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb459-1"><a href="#cb459-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize Cook’s Distance</span></span>
<span id="cb459-2"><a href="#cb459-2" aria-hidden="true" tabindex="-1"></a>cooks_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb459-3"><a href="#cb459-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">index =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb459-4"><a href="#cb459-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">cooks_d =</span> cooks_d,</span>
<span id="cb459-5"><a href="#cb459-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">influential =</span> cooks_d <span class="sc">&gt;</span> threshold</span>
<span id="cb459-6"><a href="#cb459-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb459-7"><a href="#cb459-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb459-8"><a href="#cb459-8" aria-hidden="true" tabindex="-1"></a>p_cooks <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(cooks_df, <span class="fu">aes</span>(index, cooks_d, <span class="at">color =</span> influential)) <span class="sc">+</span></span>
<span id="cb459-9"><a href="#cb459-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">size =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb459-10"><a href="#cb459-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> threshold, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"#67001F"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb459-11"><a href="#cb459-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb459-12"><a href="#cb459-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"#053061"</span>, <span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"#67001F"</span>),</span>
<span id="cb459-13"><a href="#cb459-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"Normal"</span>, <span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"Influential"</span>),</span>
<span id="cb459-14"><a href="#cb459-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="cn">NULL</span></span>
<span id="cb459-15"><a href="#cb459-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb459-16"><a href="#cb459-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> n<span class="sc">*</span><span class="fl">0.8</span>, <span class="at">y =</span> threshold<span class="sc">*</span><span class="fl">1.2</span>,</span>
<span id="cb459-17"><a href="#cb459-17" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">sprintf</span>(<span class="st">"Threshold = %.6f"</span>, threshold),</span>
<span id="cb459-18"><a href="#cb459-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> <span class="st">"#67001F"</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb459-19"><a href="#cb459-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb459-20"><a href="#cb459-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb459-21"><a href="#cb459-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb459-22"><a href="#cb459-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb459-23"><a href="#cb459-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">11</span>),</span>
<span id="cb459-24"><a href="#cb459-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb459-25"><a href="#cb459-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb459-26"><a href="#cb459-26" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb459-27"><a href="#cb459-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb459-28"><a href="#cb459-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Cook’s Distance – Detection of Influential Observations"</span>,</span>
<span id="cb459-29"><a href="#cb459-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">sprintf</span>(<span class="st">"%d influential points (%.2f%% of data)"</span>, </span>
<span id="cb459-30"><a href="#cb459-30" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">length</span>(influential), <span class="dv">100</span><span class="sc">*</span><span class="fu">length</span>(influential)<span class="sc">/</span>n),</span>
<span id="cb459-31"><a href="#cb459-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Observation Index"</span>,</span>
<span id="cb459-32"><a href="#cb459-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Cook’s Distance"</span>,</span>
<span id="cb459-33"><a href="#cb459-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Threshold = 4/n (classic rule)"</span></span>
<span id="cb459-34"><a href="#cb459-34" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb459-35"><a href="#cb459-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb459-36"><a href="#cb459-36" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"plot"</span>)) <span class="fu">dir.create</span>(<span class="st">"plot"</span>)</span>
<span id="cb459-37"><a href="#cb459-37" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"plot/cooks_distance.png"</span>, p_cooks, <span class="at">width =</span> <span class="dv">12</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb459-38"><a href="#cb459-38" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">   plot/cooks_distance.png</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   plot/cooks_distance.png</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb461"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb461-1"><a href="#cb461-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb461-2"><a href="#cb461-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Moran’s I – Spatial Autocorrelation Test</span></span>
<span id="cb461-3"><a href="#cb461-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb461-4"><a href="#cb461-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb461-5"><a href="#cb461-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb463"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb463-1"><a href="#cb463-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Moran’s I Spatial Autocorrelation Test ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>=== Moran’s I Spatial Autocorrelation Test ===</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb465"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb465-1"><a href="#cb465-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check coordinates</span></span>
<span id="cb465-2"><a href="#cb465-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"x_coord"</span>, <span class="st">"y_coord"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(df))) {</span>
<span id="cb465-3"><a href="#cb465-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-4"><a href="#cb465-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Prepare spatial data</span></span>
<span id="cb465-5"><a href="#cb465-5" aria-hidden="true" tabindex="-1"></a>  df_spatial <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb465-6"><a href="#cb465-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(x_coord), <span class="sc">!</span><span class="fu">is.na</span>(y_coord)) <span class="sc">%&gt;%</span></span>
<span id="cb465-7"><a href="#cb465-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb465-8"><a href="#cb465-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">residual =</span> <span class="fu">residuals</span>(model4)[<span class="sc">!</span><span class="fu">is.na</span>(x_coord) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(y_coord)],</span>
<span id="cb465-9"><a href="#cb465-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">sale_price_actual =</span> .data[[y_var]]</span>
<span id="cb465-10"><a href="#cb465-10" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb465-11"><a href="#cb465-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(residual))</span>
<span id="cb465-12"><a href="#cb465-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-13"><a href="#cb465-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to sf object</span></span>
<span id="cb465-14"><a href="#cb465-14" aria-hidden="true" tabindex="-1"></a>  coords <span class="ot">&lt;-</span> df_spatial <span class="sc">%&gt;%</span> <span class="fu">select</span>(x_coord, y_coord)</span>
<span id="cb465-15"><a href="#cb465-15" aria-hidden="true" tabindex="-1"></a>  coords_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(coords, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x_coord"</span>, <span class="st">"y_coord"</span>), <span class="at">crs =</span> <span class="dv">2272</span>)</span>
<span id="cb465-16"><a href="#cb465-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-17"><a href="#cb465-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Valid samples: %d</span><span class="sc">\n\n</span><span class="st">"</span>, <span class="fu">nrow</span>(df_spatial)))</span>
<span id="cb465-18"><a href="#cb465-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-19"><a href="#cb465-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># === 2.1 Moran’s I for Actual Sale Price ===</span></span>
<span id="cb465-20"><a href="#cb465-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"--- Spatial Autocorrelation of Actual Sale Price ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb465-21"><a href="#cb465-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-22"><a href="#cb465-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Build spatial weight matrix (K-nearest neighbors, k=8)</span></span>
<span id="cb465-23"><a href="#cb465-23" aria-hidden="true" tabindex="-1"></a>  nb_knn <span class="ot">&lt;-</span> <span class="fu">knn2nb</span>(<span class="fu">knearneigh</span>(coords_sf, <span class="at">k =</span> <span class="dv">8</span>))</span>
<span id="cb465-24"><a href="#cb465-24" aria-hidden="true" tabindex="-1"></a>  listw_knn <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(nb_knn, <span class="at">style =</span> <span class="st">"W"</span>)</span>
<span id="cb465-25"><a href="#cb465-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-26"><a href="#cb465-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Moran’s I test</span></span>
<span id="cb465-27"><a href="#cb465-27" aria-hidden="true" tabindex="-1"></a>  moran_price <span class="ot">&lt;-</span> <span class="fu">moran.test</span>(df_spatial<span class="sc">$</span>sale_price_actual, listw_knn)</span>
<span id="cb465-28"><a href="#cb465-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-29"><a href="#cb465-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Moran’s I = %.4f</span><span class="sc">\n</span><span class="st">"</span>, moran_price<span class="sc">$</span>estimate[<span class="dv">1</span>]))</span>
<span id="cb465-30"><a href="#cb465-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Expected = %.4f</span><span class="sc">\n</span><span class="st">"</span>, moran_price<span class="sc">$</span>estimate[<span class="dv">2</span>]))</span>
<span id="cb465-31"><a href="#cb465-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Variance = %.6f</span><span class="sc">\n</span><span class="st">"</span>, moran_price<span class="sc">$</span>estimate[<span class="dv">3</span>]))</span>
<span id="cb465-32"><a href="#cb465-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Z-score = %.4f</span><span class="sc">\n</span><span class="st">"</span>, moran_price<span class="sc">$</span>statistic))</span>
<span id="cb465-33"><a href="#cb465-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  p-value = %.4e</span><span class="sc">\n</span><span class="st">"</span>, moran_price<span class="sc">$</span>p.value))</span>
<span id="cb465-34"><a href="#cb465-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-35"><a href="#cb465-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (moran_price<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.001</span>) {</span>
<span id="cb465-36"><a href="#cb465-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  *** Highly significant positive spatial autocorrelation (p &lt; 0.001)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb465-37"><a href="#cb465-37" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (moran_price<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb465-38"><a href="#cb465-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  ** Significant positive spatial autocorrelation (p &lt; 0.05)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb465-39"><a href="#cb465-39" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb465-40"><a href="#cb465-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  No significant spatial autocorrelation detected</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb465-41"><a href="#cb465-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb465-42"><a href="#cb465-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-43"><a href="#cb465-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># === 2.2 Moran’s I for Residuals ===</span></span>
<span id="cb465-44"><a href="#cb465-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Spatial Autocorrelation of Model 4 Residuals ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb465-45"><a href="#cb465-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-46"><a href="#cb465-46" aria-hidden="true" tabindex="-1"></a>  moran_resid <span class="ot">&lt;-</span> <span class="fu">moran.test</span>(df_spatial<span class="sc">$</span>residual, listw_knn)</span>
<span id="cb465-47"><a href="#cb465-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-48"><a href="#cb465-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Moran’s I = %.4f</span><span class="sc">\n</span><span class="st">"</span>, moran_resid<span class="sc">$</span>estimate[<span class="dv">1</span>]))</span>
<span id="cb465-49"><a href="#cb465-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Expected = %.4f</span><span class="sc">\n</span><span class="st">"</span>, moran_resid<span class="sc">$</span>estimate[<span class="dv">2</span>]))</span>
<span id="cb465-50"><a href="#cb465-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Variance = %.6f</span><span class="sc">\n</span><span class="st">"</span>, moran_resid<span class="sc">$</span>estimate[<span class="dv">3</span>]))</span>
<span id="cb465-51"><a href="#cb465-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Z-score = %.4f</span><span class="sc">\n</span><span class="st">"</span>, moran_resid<span class="sc">$</span>statistic))</span>
<span id="cb465-52"><a href="#cb465-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  p-value = %.4e</span><span class="sc">\n</span><span class="st">"</span>, moran_resid<span class="sc">$</span>p.value))</span>
<span id="cb465-53"><a href="#cb465-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-54"><a href="#cb465-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (moran_resid<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.001</span>) {</span>
<span id="cb465-55"><a href="#cb465-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  ️ Strong residual spatial autocorrelation detected (p &lt; 0.001)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb465-56"><a href="#cb465-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Suggestion: Consider Spatial Lag Model (SAR) or Spatial Error Model (SEM)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb465-57"><a href="#cb465-57" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (moran_resid<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb465-58"><a href="#cb465-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  ️ Residual spatial autocorrelation detected (p &lt; 0.05)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb465-59"><a href="#cb465-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Suggestion: Add more spatial variables or use spatial regression models</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb465-60"><a href="#cb465-60" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb465-61"><a href="#cb465-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  ✓ No significant residual spatial autocorrelation – spatial effects well captured</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb465-62"><a href="#cb465-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb465-63"><a href="#cb465-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-64"><a href="#cb465-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># === 2.3 Moran Scatterplots ===</span></span>
<span id="cb465-65"><a href="#cb465-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-66"><a href="#cb465-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate spatial lags</span></span>
<span id="cb465-67"><a href="#cb465-67" aria-hidden="true" tabindex="-1"></a>  lag_price <span class="ot">&lt;-</span> <span class="fu">lag.listw</span>(listw_knn, df_spatial<span class="sc">$</span>sale_price_actual)</span>
<span id="cb465-68"><a href="#cb465-68" aria-hidden="true" tabindex="-1"></a>  lag_resid <span class="ot">&lt;-</span> <span class="fu">lag.listw</span>(listw_knn, df_spatial<span class="sc">$</span>residual)</span>
<span id="cb465-69"><a href="#cb465-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-70"><a href="#cb465-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Standardize</span></span>
<span id="cb465-71"><a href="#cb465-71" aria-hidden="true" tabindex="-1"></a>  price_std <span class="ot">&lt;-</span> <span class="fu">scale</span>(df_spatial<span class="sc">$</span>sale_price_actual)[,<span class="dv">1</span>]</span>
<span id="cb465-72"><a href="#cb465-72" aria-hidden="true" tabindex="-1"></a>  lag_price_std <span class="ot">&lt;-</span> <span class="fu">scale</span>(lag_price)[,<span class="dv">1</span>]</span>
<span id="cb465-73"><a href="#cb465-73" aria-hidden="true" tabindex="-1"></a>  resid_std <span class="ot">&lt;-</span> <span class="fu">scale</span>(df_spatial<span class="sc">$</span>residual)[,<span class="dv">1</span>]</span>
<span id="cb465-74"><a href="#cb465-74" aria-hidden="true" tabindex="-1"></a>  lag_resid_std <span class="ot">&lt;-</span> <span class="fu">scale</span>(lag_resid)[,<span class="dv">1</span>]</span>
<span id="cb465-75"><a href="#cb465-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-76"><a href="#cb465-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define quadrants</span></span>
<span id="cb465-77"><a href="#cb465-77" aria-hidden="true" tabindex="-1"></a>  quadrant_price <span class="ot">&lt;-</span> <span class="fu">case_when</span>(</span>
<span id="cb465-78"><a href="#cb465-78" aria-hidden="true" tabindex="-1"></a>    price_std <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> lag_price_std <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"HH (High-High)"</span>,</span>
<span id="cb465-79"><a href="#cb465-79" aria-hidden="true" tabindex="-1"></a>    price_std <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> lag_price_std <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"LL (Low-Low)"</span>,</span>
<span id="cb465-80"><a href="#cb465-80" aria-hidden="true" tabindex="-1"></a>    price_std <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> lag_price_std <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"HL (High-Low)"</span>,</span>
<span id="cb465-81"><a href="#cb465-81" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"LH (Low-High)"</span></span>
<span id="cb465-82"><a href="#cb465-82" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb465-83"><a href="#cb465-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-84"><a href="#cb465-84" aria-hidden="true" tabindex="-1"></a>  quadrant_resid <span class="ot">&lt;-</span> <span class="fu">case_when</span>(</span>
<span id="cb465-85"><a href="#cb465-85" aria-hidden="true" tabindex="-1"></a>    resid_std <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> lag_resid_std <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"HH"</span>,</span>
<span id="cb465-86"><a href="#cb465-86" aria-hidden="true" tabindex="-1"></a>    resid_std <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> lag_resid_std <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"LL"</span>,</span>
<span id="cb465-87"><a href="#cb465-87" aria-hidden="true" tabindex="-1"></a>    resid_std <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> lag_resid_std <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"HL"</span>,</span>
<span id="cb465-88"><a href="#cb465-88" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"LH"</span></span>
<span id="cb465-89"><a href="#cb465-89" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb465-90"><a href="#cb465-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-91"><a href="#cb465-91" aria-hidden="true" tabindex="-1"></a>  moran_df_price <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb465-92"><a href="#cb465-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> price_std,</span>
<span id="cb465-93"><a href="#cb465-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag_value =</span> lag_price_std,</span>
<span id="cb465-94"><a href="#cb465-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">quadrant =</span> quadrant_price</span>
<span id="cb465-95"><a href="#cb465-95" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb465-96"><a href="#cb465-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-97"><a href="#cb465-97" aria-hidden="true" tabindex="-1"></a>  moran_df_resid <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb465-98"><a href="#cb465-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> resid_std,</span>
<span id="cb465-99"><a href="#cb465-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">lag_value =</span> lag_resid_std,</span>
<span id="cb465-100"><a href="#cb465-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">quadrant =</span> quadrant_resid</span>
<span id="cb465-101"><a href="#cb465-101" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb465-102"><a href="#cb465-102" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-103"><a href="#cb465-103" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot – Sale Price</span></span>
<span id="cb465-104"><a href="#cb465-104" aria-hidden="true" tabindex="-1"></a>  p_moran_price <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(moran_df_price, <span class="fu">aes</span>(value, lag_value, <span class="at">color =</span> quadrant)) <span class="sc">+</span></span>
<span id="cb465-105"><a href="#cb465-105" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb465-106"><a href="#cb465-106" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb465-107"><a href="#cb465-107" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb465-108"><a href="#cb465-108" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">group =</span> <span class="dv">1</span>), <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, </span>
<span id="cb465-109"><a href="#cb465-109" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="st">"#67001F"</span>, <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb465-110"><a href="#cb465-110" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(</span>
<span id="cb465-111"><a href="#cb465-111" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"HH (High-High)"</span> <span class="ot">=</span> <span class="st">"#67001F"</span>, </span>
<span id="cb465-112"><a href="#cb465-112" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"LL (Low-Low)"</span> <span class="ot">=</span> <span class="st">"#053061"</span>,</span>
<span id="cb465-113"><a href="#cb465-113" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"HL (High-Low)"</span> <span class="ot">=</span> <span class="st">"#F4A582"</span>,</span>
<span id="cb465-114"><a href="#cb465-114" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"LH (Low-High)"</span> <span class="ot">=</span> <span class="st">"#92C5DE"</span>),</span>
<span id="cb465-115"><a href="#cb465-115" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Quadrant"</span></span>
<span id="cb465-116"><a href="#cb465-116" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb465-117"><a href="#cb465-117" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="sc">-</span><span class="dv">3</span>, <span class="at">y =</span> <span class="dv">3</span>, </span>
<span id="cb465-118"><a href="#cb465-118" aria-hidden="true" tabindex="-1"></a>             <span class="at">label =</span> <span class="fu">sprintf</span>(<span class="st">"Moran’s I = %.4f***"</span>, moran_price<span class="sc">$</span>estimate[<span class="dv">1</span>]),</span>
<span id="cb465-119"><a href="#cb465-119" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">5</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">color =</span> <span class="st">"#67001F"</span>) <span class="sc">+</span></span>
<span id="cb465-120"><a href="#cb465-120" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb465-121"><a href="#cb465-121" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb465-122"><a href="#cb465-122" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb465-123"><a href="#cb465-123" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb465-124"><a href="#cb465-124" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">11</span>),</span>
<span id="cb465-125"><a href="#cb465-125" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb465-126"><a href="#cb465-126" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb465-127"><a href="#cb465-127" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb465-128"><a href="#cb465-128" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb465-129"><a href="#cb465-129" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Moran’s I Scatter Plot – Sale Price"</span>,</span>
<span id="cb465-130"><a href="#cb465-130" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="st">"Strong positive spatial autocorrelation"</span>,</span>
<span id="cb465-131"><a href="#cb465-131" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Standardized Sale Price"</span>,</span>
<span id="cb465-132"><a href="#cb465-132" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Spatial Lag (Average of Neighbors)"</span></span>
<span id="cb465-133"><a href="#cb465-133" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb465-134"><a href="#cb465-134" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-135"><a href="#cb465-135" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot – Residuals</span></span>
<span id="cb465-136"><a href="#cb465-136" aria-hidden="true" tabindex="-1"></a>  p_moran_resid <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(moran_df_resid, <span class="fu">aes</span>(value, lag_value, <span class="at">color =</span> quadrant)) <span class="sc">+</span></span>
<span id="cb465-137"><a href="#cb465-137" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb465-138"><a href="#cb465-138" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb465-139"><a href="#cb465-139" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb465-140"><a href="#cb465-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">group =</span> <span class="dv">1</span>), <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, </span>
<span id="cb465-141"><a href="#cb465-141" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="st">"#67001F"</span>, <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb465-142"><a href="#cb465-142" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(</span>
<span id="cb465-143"><a href="#cb465-143" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"HH"</span> <span class="ot">=</span> <span class="st">"#67001F"</span>, <span class="st">"LL"</span> <span class="ot">=</span> <span class="st">"#053061"</span>,</span>
<span id="cb465-144"><a href="#cb465-144" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"HL"</span> <span class="ot">=</span> <span class="st">"#F4A582"</span>, <span class="st">"LH"</span> <span class="ot">=</span> <span class="st">"#92C5DE"</span>),</span>
<span id="cb465-145"><a href="#cb465-145" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Quadrant"</span></span>
<span id="cb465-146"><a href="#cb465-146" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb465-147"><a href="#cb465-147" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="sc">-</span><span class="dv">3</span>, <span class="at">y =</span> <span class="dv">3</span>, </span>
<span id="cb465-148"><a href="#cb465-148" aria-hidden="true" tabindex="-1"></a>             <span class="at">label =</span> <span class="fu">sprintf</span>(<span class="st">"Moran’s I = %.4f%s"</span>, </span>
<span id="cb465-149"><a href="#cb465-149" aria-hidden="true" tabindex="-1"></a>                           moran_resid<span class="sc">$</span>estimate[<span class="dv">1</span>],</span>
<span id="cb465-150"><a href="#cb465-150" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">ifelse</span>(moran_resid<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.001</span>, <span class="st">"***"</span>,</span>
<span id="cb465-151"><a href="#cb465-151" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">ifelse</span>(moran_resid<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"**"</span>, <span class="st">""</span>))),</span>
<span id="cb465-152"><a href="#cb465-152" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">5</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>, </span>
<span id="cb465-153"><a href="#cb465-153" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="fu">ifelse</span>(moran_resid<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="st">"#67001F"</span>, <span class="st">"gray50"</span>)) <span class="sc">+</span></span>
<span id="cb465-154"><a href="#cb465-154" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb465-155"><a href="#cb465-155" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb465-156"><a href="#cb465-156" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb465-157"><a href="#cb465-157" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb465-158"><a href="#cb465-158" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">11</span>),</span>
<span id="cb465-159"><a href="#cb465-159" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb465-160"><a href="#cb465-160" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb465-161"><a href="#cb465-161" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb465-162"><a href="#cb465-162" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb465-163"><a href="#cb465-163" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Moran’s I Scatter Plot – Model 4 Residuals"</span>,</span>
<span id="cb465-164"><a href="#cb465-164" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="fu">ifelse</span>(moran_resid<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>, </span>
<span id="cb465-165"><a href="#cb465-165" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"Residual spatial autocorrelation detected"</span>,</span>
<span id="cb465-166"><a href="#cb465-166" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"No significant residual spatial autocorrelation"</span>),</span>
<span id="cb465-167"><a href="#cb465-167" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Standardized Residual"</span>,</span>
<span id="cb465-168"><a href="#cb465-168" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Spatial Lag (Average of Neighbors)"</span></span>
<span id="cb465-169"><a href="#cb465-169" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb465-170"><a href="#cb465-170" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-171"><a href="#cb465-171" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine plots</span></span>
<span id="cb465-172"><a href="#cb465-172" aria-hidden="true" tabindex="-1"></a>  p_moran_combined <span class="ot">&lt;-</span> (p_moran_price <span class="sc">|</span> p_moran_resid) <span class="sc">+</span></span>
<span id="cb465-173"><a href="#cb465-173" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_annotation</span>(</span>
<span id="cb465-174"><a href="#cb465-174" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Spatial Autocorrelation Analysis (Moran’s I)"</span>,</span>
<span id="cb465-175"><a href="#cb465-175" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="st">"Left: Original prices show strong clustering | Right: Model residuals"</span>,</span>
<span id="cb465-176"><a href="#cb465-176" aria-hidden="true" tabindex="-1"></a>      <span class="at">theme =</span> <span class="fu">theme</span>(</span>
<span id="cb465-177"><a href="#cb465-177" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb465-178"><a href="#cb465-178" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb465-179"><a href="#cb465-179" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb465-180"><a href="#cb465-180" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb465-181"><a href="#cb465-181" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb465-182"><a href="#cb465-182" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-183"><a href="#cb465-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="st">"plot/morans_i_scatter.png"</span>, p_moran_combined, </span>
<span id="cb465-184"><a href="#cb465-184" aria-hidden="true" tabindex="-1"></a>         <span class="at">width =</span> <span class="dv">16</span>, <span class="at">height =</span> <span class="dv">7</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb465-185"><a href="#cb465-185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">   plot/morans_i_scatter.png</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb465-186"><a href="#cb465-186" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-187"><a href="#cb465-187" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save Moran’s I results</span></span>
<span id="cb465-188"><a href="#cb465-188" aria-hidden="true" tabindex="-1"></a>  moran_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb465-189"><a href="#cb465-189" aria-hidden="true" tabindex="-1"></a>    <span class="at">Variable =</span> <span class="fu">c</span>(<span class="st">"Sale Price"</span>, <span class="st">"Model 4 Residuals"</span>),</span>
<span id="cb465-190"><a href="#cb465-190" aria-hidden="true" tabindex="-1"></a>    <span class="at">Morans_I =</span> <span class="fu">c</span>(moran_price<span class="sc">$</span>estimate[<span class="dv">1</span>], moran_resid<span class="sc">$</span>estimate[<span class="dv">1</span>]),</span>
<span id="cb465-191"><a href="#cb465-191" aria-hidden="true" tabindex="-1"></a>    <span class="at">Expected =</span> <span class="fu">c</span>(moran_price<span class="sc">$</span>estimate[<span class="dv">2</span>], moran_resid<span class="sc">$</span>estimate[<span class="dv">2</span>]),</span>
<span id="cb465-192"><a href="#cb465-192" aria-hidden="true" tabindex="-1"></a>    <span class="at">Variance =</span> <span class="fu">c</span>(moran_price<span class="sc">$</span>estimate[<span class="dv">3</span>], moran_resid<span class="sc">$</span>estimate[<span class="dv">3</span>]),</span>
<span id="cb465-193"><a href="#cb465-193" aria-hidden="true" tabindex="-1"></a>    <span class="at">Z_score =</span> <span class="fu">c</span>(moran_price<span class="sc">$</span>statistic, moran_resid<span class="sc">$</span>statistic),</span>
<span id="cb465-194"><a href="#cb465-194" aria-hidden="true" tabindex="-1"></a>    <span class="at">P_value =</span> <span class="fu">c</span>(moran_price<span class="sc">$</span>p.value, moran_resid<span class="sc">$</span>p.value),</span>
<span id="cb465-195"><a href="#cb465-195" aria-hidden="true" tabindex="-1"></a>    <span class="at">Significant =</span> <span class="fu">c</span>(moran_price<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>, moran_resid<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>)</span>
<span id="cb465-196"><a href="#cb465-196" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb465-197"><a href="#cb465-197" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-198"><a href="#cb465-198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(moran_summary, <span class="st">"file/morans_i_results.csv"</span>)</span>
<span id="cb465-199"><a href="#cb465-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  ✓ file/morans_i_results.csv</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb465-200"><a href="#cb465-200" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb465-201"><a href="#cb465-201" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb465-202"><a href="#cb465-202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">" Missing coordinate data – Moran’s I test cannot be performed</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb465-203"><a href="#cb465-203" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Valid samples: 24023

--- Spatial Autocorrelation of Actual Sale Price ---</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Moran’s I = 0.5328
  Expected = -0.0000
  Variance = 0.000009
  Z-score = 175.1095
  p-value = 0.0000e+00
  *** Highly significant positive spatial autocorrelation (p &lt; 0.001)

--- Spatial Autocorrelation of Model 4 Residuals ---
  Moran’s I = 0.0820
  Expected = -0.0000
  Variance = 0.000009
  Z-score = 26.9827
  p-value = 1.1797e-160
  ️ Strong residual spatial autocorrelation detected (p &lt; 0.001)
  Suggestion: Consider Spatial Lag Model (SAR) or Spatial Error Model (SEM)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
   plot/morans_i_scatter.png
  ✓ file/morans_i_results.csv</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb469"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb469-1"><a href="#cb469-1" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb469-2"><a href="#cb469-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary</span></span>
<span id="cb469-3"><a href="#cb469-3" aria-hidden="true" tabindex="-1"></a><span class="co"># =========================================================</span></span>
<span id="cb469-4"><a href="#cb469-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb469-5"><a href="#cb469-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb471"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb471-1"><a href="#cb471-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">" Step 4 Supplement Completed</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> Step 4 Supplement Completed</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb473"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb473-1"><a href="#cb473-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">80</span>), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb475"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb475-1"><a href="#cb475-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">" Output Files:</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> Output Files:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb477"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb477-1"><a href="#cb477-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Tables:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Tables:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb479"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb479-1"><a href="#cb479-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"influential_data"</span>)) {</span>
<span id="cb479-2"><a href="#cb479-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  • file/influential_observations.csv – List of influential observations</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb479-3"><a href="#cb479-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • file/influential_observations.csv – List of influential observations</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb481"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb481-1"><a href="#cb481-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"moran_summary"</span>)) {</span>
<span id="cb481-2"><a href="#cb481-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  • file/morans_i_results.csv – Moran’s I test results</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb481-3"><a href="#cb481-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • file/morans_i_results.csv – Moran’s I test results</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb483"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb483-1"><a href="#cb483-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Figures:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Figures:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb485"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb485-1"><a href="#cb485-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • plot/cooks_distance.png – Cook’s Distance Scatter Plot</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • plot/cooks_distance.png – Cook’s Distance Scatter Plot</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb487"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb487-1"><a href="#cb487-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"p_moran_combined"</span>)) {</span>
<span id="cb487-2"><a href="#cb487-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  • plot/morans_i_scatter.png – Moran’s I Scatter Plot</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb487-3"><a href="#cb487-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • plot/morans_i_scatter.png – Moran’s I Scatter Plot</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb489"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb489-1"><a href="#cb489-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st"> Key Findings:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 Key Findings:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb491"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb491-1"><a href="#cb491-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"moran_resid"</span>)) {</span>
<span id="cb491-2"><a href="#cb491-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (moran_resid<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb491-3"><a href="#cb491-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  ️ Significant spatial autocorrelation detected in residuals</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb491-4"><a href="#cb491-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"     → The model did not fully capture spatial effects</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb491-5"><a href="#cb491-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"     → Suggest using spatial econometric models (SAR/SEM)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb491-6"><a href="#cb491-6" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb491-7"><a href="#cb491-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"   No significant spatial autocorrelation in residuals</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb491-8"><a href="#cb491-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"     → Fixed effects adequately controlled for spatial dependence</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb491-9"><a href="#cb491-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb491-10"><a href="#cb491-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ️ Significant spatial autocorrelation detected in residuals
     → The model did not fully capture spatial effects
     → Suggest using spatial econometric models (SAR/SEM)</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb493"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb493-1"><a href="#cb493-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb494"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb494-1"><a href="#cb494-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb494-2"><a href="#cb494-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb494-3"><a href="#cb494-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb494-4"><a href="#cb494-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb494-5"><a href="#cb494-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forcats)</span>
<span id="cb494-6"><a href="#cb494-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb494-7"><a href="#cb494-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb494-8"><a href="#cb494-8" aria-hidden="true" tabindex="-1"></a><span class="co"># tidytext</span></span>
<span id="cb494-9"><a href="#cb494-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"tidytext"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb494-10"><a href="#cb494-10" aria-hidden="true" tabindex="-1"></a>  reorder_within <span class="ot">&lt;-</span> <span class="cf">function</span>(x, by, within, <span class="at">fun =</span> mean, <span class="at">sep =</span> <span class="st">"___"</span>, ...) {</span>
<span id="cb494-11"><a href="#cb494-11" aria-hidden="true" tabindex="-1"></a>    new_x <span class="ot">&lt;-</span> <span class="fu">paste</span>(x, within, <span class="at">sep =</span> sep)</span>
<span id="cb494-12"><a href="#cb494-12" aria-hidden="true" tabindex="-1"></a>    stats<span class="sc">::</span><span class="fu">reorder</span>(new_x, by, <span class="at">FUN =</span> fun)</span>
<span id="cb494-13"><a href="#cb494-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb494-14"><a href="#cb494-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb494-15"><a href="#cb494-15" aria-hidden="true" tabindex="-1"></a>  scale_x_reordered <span class="ot">&lt;-</span> <span class="cf">function</span>(..., <span class="at">sep =</span> <span class="st">"___"</span>) {</span>
<span id="cb494-16"><a href="#cb494-16" aria-hidden="true" tabindex="-1"></a>    reg <span class="ot">&lt;-</span> <span class="fu">paste0</span>(sep, <span class="st">".+$"</span>)</span>
<span id="cb494-17"><a href="#cb494-17" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_x_discrete</span>(<span class="at">labels =</span> <span class="cf">function</span>(x) <span class="fu">gsub</span>(reg, <span class="st">""</span>, x), ...)</span>
<span id="cb494-18"><a href="#cb494-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb494-19"><a href="#cb494-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb494-20"><a href="#cb494-20" aria-hidden="true" tabindex="-1"></a>  scale_y_reordered <span class="ot">&lt;-</span> <span class="cf">function</span>(..., <span class="at">sep =</span> <span class="st">"___"</span>) {</span>
<span id="cb494-21"><a href="#cb494-21" aria-hidden="true" tabindex="-1"></a>    reg <span class="ot">&lt;-</span> <span class="fu">paste0</span>(sep, <span class="st">".+$"</span>)</span>
<span id="cb494-22"><a href="#cb494-22" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_y_discrete</span>(<span class="at">labels =</span> <span class="cf">function</span>(x) <span class="fu">gsub</span>(reg, <span class="st">""</span>, x), ...)</span>
<span id="cb494-23"><a href="#cb494-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb494-24"><a href="#cb494-24" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb494-25"><a href="#cb494-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(tidytext)</span>
<span id="cb494-26"><a href="#cb494-26" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb495"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb495-1"><a href="#cb495-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read data</span></span>
<span id="cb495-2"><a href="#cb495-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"./table/feature_importance_all_models.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb495-3"><a href="#cb495-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb495-4"><a href="#cb495-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Data cleaning</span></span>
<span id="cb495-5"><a href="#cb495-5" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb495-6"><a href="#cb495-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb495-7"><a href="#cb495-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate =</span> <span class="fu">as.numeric</span>(estimate),</span>
<span id="cb495-8"><a href="#cb495-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_estimate =</span> <span class="fu">as.numeric</span>(abs_estimate)</span>
<span id="cb495-9"><a href="#cb495-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb495-10"><a href="#cb495-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb495-11"><a href="#cb495-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Variable classification</span></span>
<span id="cb495-12"><a href="#cb495-12" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb495-13"><a href="#cb495-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb495-14"><a href="#cb495-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">var_type =</span> <span class="fu">case_when</span>(</span>
<span id="cb495-15"><a href="#cb495-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">grepl</span>(<span class="st">"census_tract|zip_code"</span>, term) <span class="sc">~</span> <span class="st">"Location Fixed Effects"</span>,</span>
<span id="cb495-16"><a href="#cb495-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">grepl</span>(<span class="st">"income|POVERTY"</span>, term) <span class="sc">~</span> <span class="st">"Socioeconomic"</span>,</span>
<span id="cb495-17"><a href="#cb495-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">grepl</span>(<span class="st">"bathroom|bedroom|livable_area"</span>, term) <span class="sc">~</span> <span class="st">"Structural"</span>,</span>
<span id="cb495-18"><a href="#cb495-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">grepl</span>(<span class="st">"age"</span>, term) <span class="sc">~</span> <span class="st">"Age"</span>,</span>
<span id="cb495-19"><a href="#cb495-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">grepl</span>(<span class="st">"coord|dist"</span>, term) <span class="sc">~</span> <span class="st">"Spatial"</span>,</span>
<span id="cb495-20"><a href="#cb495-20" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Other"</span></span>
<span id="cb495-21"><a href="#cb495-21" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb495-22"><a href="#cb495-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean variable names</span></span>
<span id="cb495-23"><a href="#cb495-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">term_clean =</span> <span class="fu">case_when</span>(</span>
<span id="cb495-24"><a href="#cb495-24" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"number_of_bathrooms"</span> <span class="sc">~</span> <span class="st">"Bathrooms"</span>,</span>
<span id="cb495-25"><a href="#cb495-25" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"number_of_bedrooms"</span> <span class="sc">~</span> <span class="st">"Bedrooms"</span>,</span>
<span id="cb495-26"><a href="#cb495-26" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"total_livable_area"</span> <span class="sc">~</span> <span class="st">"Livable Area"</span>,</span>
<span id="cb495-27"><a href="#cb495-27" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"per_cap_incomeE"</span> <span class="sc">~</span> <span class="st">"Per Capita Income"</span>,</span>
<span id="cb495-28"><a href="#cb495-28" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"median_incomeE"</span> <span class="sc">~</span> <span class="st">"Median Income"</span>,</span>
<span id="cb495-29"><a href="#cb495-29" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"PCTPOVERTY"</span> <span class="sc">~</span> <span class="st">"Poverty Rate"</span>,</span>
<span id="cb495-30"><a href="#cb495-30" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"age2"</span> <span class="sc">~</span> <span class="st">"Age²"</span>,</span>
<span id="cb495-31"><a href="#cb495-31" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"dist_to_center"</span> <span class="sc">~</span> <span class="st">"Distance to Center"</span>,</span>
<span id="cb495-32"><a href="#cb495-32" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"x_coord"</span> <span class="sc">~</span> <span class="st">"X Coordinate"</span>,</span>
<span id="cb495-33"><a href="#cb495-33" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"y_coord"</span> <span class="sc">~</span> <span class="st">"Y Coordinate"</span>,</span>
<span id="cb495-34"><a href="#cb495-34" aria-hidden="true" tabindex="-1"></a>      <span class="fu">grepl</span>(<span class="st">"census_tract"</span>, term) <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">"census_tract"</span>, <span class="st">"Census Tract "</span>, term),</span>
<span id="cb495-35"><a href="#cb495-35" aria-hidden="true" tabindex="-1"></a>      <span class="fu">grepl</span>(<span class="st">"zip_code"</span>, term) <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">"zip_code"</span>, <span class="st">"ZIP "</span>, term),</span>
<span id="cb495-36"><a href="#cb495-36" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> term</span>
<span id="cb495-37"><a href="#cb495-37" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb495-38"><a href="#cb495-38" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb495-39"><a href="#cb495-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb495-40"><a href="#cb495-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only top 10 most important variables per model</span></span>
<span id="cb495-41"><a href="#cb495-41" aria-hidden="true" tabindex="-1"></a>top_features <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb495-42"><a href="#cb495-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Model) <span class="sc">%&gt;%</span></span>
<span id="cb495-43"><a href="#cb495-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(abs_estimate, <span class="at">n =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb495-44"><a href="#cb495-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb495-45"><a href="#cb495-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb495-46"><a href="#cb495-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Color palette (deep blue to deep red)</span></span>
<span id="cb495-47"><a href="#cb495-47" aria-hidden="true" tabindex="-1"></a>color_palette <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb495-48"><a href="#cb495-48" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Structural"</span> <span class="ot">=</span> <span class="st">"#67001F"</span>,        <span class="co"># deep red</span></span>
<span id="cb495-49"><a href="#cb495-49" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Socioeconomic"</span> <span class="ot">=</span> <span class="st">"#4393C3"</span>,     <span class="co"># medium blue  </span></span>
<span id="cb495-50"><a href="#cb495-50" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Age"</span> <span class="ot">=</span> <span class="st">"#2166AC"</span>,               <span class="co"># darker blue</span></span>
<span id="cb495-51"><a href="#cb495-51" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Spatial"</span> <span class="ot">=</span> <span class="st">"#053061"</span>,           <span class="co"># darkest blue</span></span>
<span id="cb495-52"><a href="#cb495-52" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Location Fixed Effects"</span> <span class="ot">=</span> <span class="st">"#D6604D"</span>  <span class="co"># reddish tone</span></span>
<span id="cb495-53"><a href="#cb495-53" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb495-54"><a href="#cb495-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb495-55"><a href="#cb495-55" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Generating visualization (using deep blue–deep red palette)...</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Generating visualization (using deep blue–deep red palette)...</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb497"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb497-1"><a href="#cb497-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ========== Figure 1: Lollipop Chart ==========</span></span>
<span id="cb497-2"><a href="#cb497-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Generating Figure 1: Lollipop chart...</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Generating Figure 1: Lollipop chart...</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb499"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb499-1"><a href="#cb499-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(top_features, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder_within</span>(term_clean, abs_estimate, Model), </span>
<span id="cb499-2"><a href="#cb499-2" aria-hidden="true" tabindex="-1"></a>                                <span class="at">y =</span> abs_estimate, <span class="at">color =</span> var_type)) <span class="sc">+</span></span>
<span id="cb499-3"><a href="#cb499-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">xend =</span> <span class="fu">reorder_within</span>(term_clean, abs_estimate, Model), <span class="at">yend =</span> <span class="dv">0</span>), </span>
<span id="cb499-4"><a href="#cb499-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">size =</span> <span class="fl">1.2</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb499-5"><a href="#cb499-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">4</span>, <span class="at">alpha =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb499-6"><a href="#cb499-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb499-7"><a href="#cb499-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Model, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb499-8"><a href="#cb499-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_reordered</span>() <span class="sc">+</span></span>
<span id="cb499-9"><a href="#cb499-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> color_palette, <span class="at">name =</span> <span class="st">"Feature Type"</span>) <span class="sc">+</span></span>
<span id="cb499-10"><a href="#cb499-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb499-11"><a href="#cb499-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Feature Importance Across Progressive Models"</span>,</span>
<span id="cb499-12"><a href="#cb499-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Lollipop chart showing top 10 features per model"</span>,</span>
<span id="cb499-13"><a href="#cb499-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb499-14"><a href="#cb499-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Absolute Coefficient"</span></span>
<span id="cb499-15"><a href="#cb499-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb499-16"><a href="#cb499-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb499-17"><a href="#cb499-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb499-18"><a href="#cb499-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">16</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb499-19"><a href="#cb499-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"gray40"</span>),</span>
<span id="cb499-20"><a href="#cb499-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">11</span>),</span>
<span id="cb499-21"><a href="#cb499-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"gray95"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb499-22"><a href="#cb499-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb499-23"><a href="#cb499-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb499-24"><a href="#cb499-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb499-25"><a href="#cb499-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray90"</span>, <span class="at">size =</span> <span class="fl">0.3</span>),</span>
<span id="cb499-26"><a href="#cb499-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb499-27"><a href="#cb499-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb499-28"><a href="#cb499-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb499-29"><a href="#cb499-29" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb499-30"><a href="#cb499-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb499-31"><a href="#cb499-31" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"plot/feature_importance_lollipop_v2.png"</span>, p1, </span>
<span id="cb499-32"><a href="#cb499-32" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">14</span>, <span class="at">height =</span> <span class="dv">10</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb499-33"><a href="#cb499-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb499-34"><a href="#cb499-34" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"    ✓ Saved to: plot/feature_importance_lollipop_v2.png</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>    ✓ Saved to: plot/feature_importance_lollipop_v2.png</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb501"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb501-1"><a href="#cb501-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ========== Figure 2: Heatmap ==========</span></span>
<span id="cb501-2"><a href="#cb501-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Generating Figure 2: Heatmap...</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Generating Figure 2: Heatmap...</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb503"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb503-1"><a href="#cb503-1" aria-hidden="true" tabindex="-1"></a>heatmap_data <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb503-2"><a href="#cb503-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Model) <span class="sc">%&gt;%</span></span>
<span id="cb503-3"><a href="#cb503-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(abs_estimate, <span class="at">n =</span> <span class="dv">8</span>) <span class="sc">%&gt;%</span></span>
<span id="cb503-4"><a href="#cb503-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb503-5"><a href="#cb503-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Model_short =</span> <span class="fu">gsub</span>(<span class="st">"M[0-9]: "</span>, <span class="st">""</span>, Model))</span>
<span id="cb503-6"><a href="#cb503-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb503-7"><a href="#cb503-7" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(heatmap_data, <span class="fu">aes</span>(<span class="at">x =</span> Model_short, <span class="at">y =</span> <span class="fu">fct_reorder</span>(term_clean, abs_estimate), </span>
<span id="cb503-8"><a href="#cb503-8" aria-hidden="true" tabindex="-1"></a>                                <span class="at">fill =</span> abs_estimate)) <span class="sc">+</span></span>
<span id="cb503-9"><a href="#cb503-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb503-10"><a href="#cb503-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">sprintf</span>(<span class="st">"%.3f"</span>, abs_estimate)), </span>
<span id="cb503-11"><a href="#cb503-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb503-12"><a href="#cb503-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(</span>
<span id="cb503-13"><a href="#cb503-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">low =</span> <span class="st">"#053061"</span>, <span class="at">mid =</span> <span class="st">"#F7F7F7"</span>, <span class="at">high =</span> <span class="st">"#67001F"</span>,</span>
<span id="cb503-14"><a href="#cb503-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">midpoint =</span> <span class="fu">median</span>(heatmap_data<span class="sc">$</span>abs_estimate),</span>
<span id="cb503-15"><a href="#cb503-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Coefficient</span><span class="sc">\n</span><span class="st">Magnitude"</span></span>
<span id="cb503-16"><a href="#cb503-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb503-17"><a href="#cb503-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb503-18"><a href="#cb503-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Feature Importance Heatmap Across Models"</span>,</span>
<span id="cb503-19"><a href="#cb503-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Top 8 features per model (darker = stronger effect)"</span>,</span>
<span id="cb503-20"><a href="#cb503-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb503-21"><a href="#cb503-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="cn">NULL</span></span>
<span id="cb503-22"><a href="#cb503-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb503-23"><a href="#cb503-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb503-24"><a href="#cb503-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb503-25"><a href="#cb503-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">16</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb503-26"><a href="#cb503-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"gray40"</span>),</span>
<span id="cb503-27"><a href="#cb503-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">11</span>),</span>
<span id="cb503-28"><a href="#cb503-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb503-29"><a href="#cb503-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb503-30"><a href="#cb503-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb503-31"><a href="#cb503-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb503-32"><a href="#cb503-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb503-33"><a href="#cb503-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb503-34"><a href="#cb503-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb503-35"><a href="#cb503-35" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"plot/feature_importance_heatmap_v2.png"</span>, p2, </span>
<span id="cb503-36"><a href="#cb503-36" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">12</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb503-37"><a href="#cb503-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb503-38"><a href="#cb503-38" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"    ✓ Saved to: plot/feature_importance_heatmap_v2.png</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>    ✓ Saved to: plot/feature_importance_heatmap_v2.png</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb505"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb505-1"><a href="#cb505-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ========== Figure 3: Nightingale Rose Chart ==========</span></span>
<span id="cb505-2"><a href="#cb505-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Generating Figure 3: Nightingale rose chart...</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Generating Figure 3: Nightingale rose chart...</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb507"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb507-1"><a href="#cb507-1" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">unique</span>(top_features<span class="sc">$</span>Model)</span>
<span id="cb507-2"><a href="#cb507-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb507-3"><a href="#cb507-3" aria-hidden="true" tabindex="-1"></a>rose_plots <span class="ot">&lt;-</span> <span class="fu">lapply</span>(models, <span class="cf">function</span>(m) {</span>
<span id="cb507-4"><a href="#cb507-4" aria-hidden="true" tabindex="-1"></a>  data_m <span class="ot">&lt;-</span> top_features <span class="sc">%&gt;%</span></span>
<span id="cb507-5"><a href="#cb507-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Model <span class="sc">==</span> m) <span class="sc">%&gt;%</span></span>
<span id="cb507-6"><a href="#cb507-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(abs_estimate)) <span class="sc">%&gt;%</span></span>
<span id="cb507-7"><a href="#cb507-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(<span class="dv">8</span>) <span class="sc">%&gt;%</span></span>
<span id="cb507-8"><a href="#cb507-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">term_clean =</span> <span class="fu">factor</span>(term_clean, <span class="at">levels =</span> term_clean))</span>
<span id="cb507-9"><a href="#cb507-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb507-10"><a href="#cb507-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(data_m, <span class="fu">aes</span>(<span class="at">x =</span> term_clean, <span class="at">y =</span> abs_estimate, <span class="at">fill =</span> abs_estimate)) <span class="sc">+</span></span>
<span id="cb507-11"><a href="#cb507-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_col</span>(<span class="at">width =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.9</span>, <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb507-12"><a href="#cb507-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_polar</span>(<span class="at">theta =</span> <span class="st">"x"</span>) <span class="sc">+</span></span>
<span id="cb507-13"><a href="#cb507-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradient2</span>(</span>
<span id="cb507-14"><a href="#cb507-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">low =</span> <span class="st">"#4393C3"</span>, <span class="at">mid =</span> <span class="st">"#F7F7F7"</span>, <span class="at">high =</span> <span class="st">"#67001F"</span>,</span>
<span id="cb507-15"><a href="#cb507-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">midpoint =</span> <span class="fu">median</span>(data_m<span class="sc">$</span>abs_estimate),</span>
<span id="cb507-16"><a href="#cb507-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Importance"</span></span>
<span id="cb507-17"><a href="#cb507-17" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb507-18"><a href="#cb507-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> m, <span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb507-19"><a href="#cb507-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb507-20"><a href="#cb507-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb507-21"><a href="#cb507-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">11</span>),</span>
<span id="cb507-22"><a href="#cb507-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb507-23"><a href="#cb507-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb507-24"><a href="#cb507-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"gray90"</span>, <span class="at">size =</span> <span class="fl">0.3</span>),</span>
<span id="cb507-25"><a href="#cb507-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb507-26"><a href="#cb507-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb507-27"><a href="#cb507-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>),</span>
<span id="cb507-28"><a href="#cb507-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb507-29"><a href="#cb507-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb507-30"><a href="#cb507-30" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb507-31"><a href="#cb507-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb507-32"><a href="#cb507-32" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(rose_plots, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb507-33"><a href="#cb507-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_annotation</span>(</span>
<span id="cb507-34"><a href="#cb507-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Feature Importance: Nightingale Rose Chart"</span>,</span>
<span id="cb507-35"><a href="#cb507-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Top 8 features visualized as rose petals (larger petal = more important)"</span>,</span>
<span id="cb507-36"><a href="#cb507-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(</span>
<span id="cb507-37"><a href="#cb507-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">18</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb507-38"><a href="#cb507-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">"gray40"</span>),</span>
<span id="cb507-39"><a href="#cb507-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>)</span>
<span id="cb507-40"><a href="#cb507-40" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb507-41"><a href="#cb507-41" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb507-42"><a href="#cb507-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb507-43"><a href="#cb507-43" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"plot/feature_importance_rose_v2.png"</span>, p3, </span>
<span id="cb507-44"><a href="#cb507-44" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">14</span>, <span class="at">height =</span> <span class="dv">12</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb507-45"><a href="#cb507-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb507-46"><a href="#cb507-46" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"     Saved to: plot/feature_importance_rose_v2.png</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Saved to: plot/feature_importance_rose_v2.png</code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb509"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb509-1"><a href="#cb509-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print Summary</span></span>
<span id="cb509-2"><a href="#cb509-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">==============================================</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
==============================================</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb511"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb511-1"><a href="#cb511-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"🎨 All visualizations have been successfully generated! (Deep Blue–Red Palette)</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>🎨 All visualizations have been successfully generated! (Deep Blue–Red Palette)</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb513"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb513-1"><a href="#cb513-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"==============================================</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>==============================================</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb515"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb515-1"><a href="#cb515-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"📊 Generated Figures:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>📊 Generated Figures:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb517"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb517-1"><a href="#cb517-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  1. feature_importance_lollipop_v2.png  - Lollipop Chart</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  1. feature_importance_lollipop_v2.png  - Lollipop Chart</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb519"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb519-1"><a href="#cb519-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  2. feature_importance_heatmap_v2.png   - Heatmap</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  2. feature_importance_heatmap_v2.png   - Heatmap</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb521"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb521-1"><a href="#cb521-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  3. feature_importance_rose_v2.png      - Nightingale Rose Chart</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  3. feature_importance_rose_v2.png      - Nightingale Rose Chart</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb523"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb523-1"><a href="#cb523-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"🎨 Color Palette (following Moran's I visualization):</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>🎨 Color Palette (following Moran's I visualization):</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb525"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb525-1"><a href="#cb525-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • Structural: Deep Red (#67001F)</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • Structural: Deep Red (#67001F)</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb527"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb527-1"><a href="#cb527-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • Socioeconomic: Deep Blue (#4393C3)</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • Socioeconomic: Deep Blue (#4393C3)</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb529"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb529-1"><a href="#cb529-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • Age: Darker Blue (#2166AC)</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • Age: Darker Blue (#2166AC)</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb531"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb531-1"><a href="#cb531-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • Spatial: Deepest Blue (#053061)</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • Spatial: Deepest Blue (#053061)</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb533"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb533-1"><a href="#cb533-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  • Location FE: Reddish Tone (#D6604D)</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  • Location FE: Reddish Tone (#D6604D)</code></pre>
</div>
</div>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>